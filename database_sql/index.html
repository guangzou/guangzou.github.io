<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>database/sql - zg blog</title><meta name=Description content="Stay hungry, stay foolish! ğŸš€"><meta property="og:url" content="https://guangzou.github.io/database_sql/"><meta property="og:site_name" content="zg blog"><meta property="og:title" content="database/sql"><meta property="og:description" content="å­¦ä¹  go è¯­è¨€é€šç”¨çš„ç»“æ„åŒ–æŸ¥è¯¢æµç¨‹æ¡†æ¶ â€“ æ ‡å‡†åº“ database/sql"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-02-03T16:44:51+08:00"><meta property="article:modified_time" content="2026-02-06T15:46:08+08:00"><meta property="article:tag" content="GORM"><meta property="article:tag" content="Go"><meta property="og:image" content="https://guangzou.github.io/logo.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://guangzou.github.io/logo.png"><meta name=twitter:title content="database/sql"><meta name=twitter:description content="å­¦ä¹  go è¯­è¨€é€šç”¨çš„ç»“æ„åŒ–æŸ¥è¯¢æµç¨‹æ¡†æ¶ â€“ æ ‡å‡†åº“ database/sql"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=referrer content="no-referrer"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://guangzou.github.io/database_sql/><link rel=prev href=https://guangzou.github.io/func/><link rel=next href=https://guangzou.github.io/context/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/css/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"database/sql","inLanguage":"zh-cn","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/guangzou.github.io\/database_sql\/"},"genre":"posts","keywords":"GORM, Go","wordcount":6182,"url":"https:\/\/guangzou.github.io\/database_sql\/","datePublished":"2026-02-03T16:44:51+08:00","dateModified":"2026-02-06T15:46:08+08:00","license":"xxx","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"zg"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script>const query=window.matchMedia("(prefers-color-scheme: dark)");function applyTheme(){let e=window.localStorage?.getItem("theme")||"auto",t=e==="dark"||e==="auto"&&query.matches;document.body.setAttribute("theme",t?"dark":"light"),document.body.setAttribute("cfg-theme",e)}applyTheme(),query.addEventListener("change",applyTheme)</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="zg blog"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span><span id=id-1 class=typeit></span><span class=header-title-post><i class='fas fa-book fa-fw'></i></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>æ–‡ç«  </a><a class=menu-item href=/tags/>æ ‡ç­¾ </a><a class=menu-item href=/categories/>åˆ†ç±» </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=æœç´¢><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=æ¸…ç©º><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="zg blog"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span><span id=id-2 class=typeit></span><span class=header-title-post><i class='fas fa-book fa-fw'></i></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=æœç´¢><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=æ¸…ç©º><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>å–æ¶ˆ</a></div><a class=menu-item href=/posts/ title>æ–‡ç« </a><a class=menu-item href=/tags/ title>æ ‡ç­¾</a><a class=menu-item href=/categories/ title>åˆ†ç±»</a><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>ç›®å½•</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">database/sql</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>zg</a></span>&nbsp;<span class=post-category>æ”¶å½•äº <a href=/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/><i class="far fa-folder fa-fw" aria-hidden=true></i>æ•°æ®åº“</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2026-02-03>2026-02-03</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;çº¦ 6182 å­—&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;é¢„è®¡é˜…è¯» 13 åˆ†é’Ÿ&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/images/%e6%a0%87%e5%87%86%e5%ba%93database_sql%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90_banner.png data-srcset="/images/%e6%a0%87%e5%87%86%e5%ba%93database_sql%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90_banner.png, /images/%e6%a0%87%e5%87%86%e5%ba%93database_sql%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90_banner.png 1.5x, /images/%e6%a0%87%e5%87%86%e5%ba%93database_sql%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90_banner.png 2x" data-sizes=auto alt=/images/æ ‡å‡†åº“database_sqlæºç è§£æ_banner.png title=/images/æ ‡å‡†åº“database_sqlæºç è§£æ_banner.png></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>ç›®å½•</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#ä¸€æŠ½è±¡æ¥å£å®šä¹‰>ä¸€ã€æŠ½è±¡æ¥å£å®šä¹‰</a><ul><li><a href=#1-æŠ½è±¡æ¥å£>1ã€ æŠ½è±¡æ¥å£</a></li><li><a href=#2åˆ›å»ºæ•°æ®åº“å®ä¾‹>2ã€åˆ›å»ºæ•°æ®åº“å®ä¾‹</a><ul><li><a href=#21-è¿æ¥æ± çš„ç®¡ç†>2.1 è¿æ¥æ± çš„ç®¡ç†</a><ul><li><a href=#211-è¿æ¥çš„è¡¨è¾¾å½¢å¼>2.1.1 è¿æ¥çš„è¡¨è¾¾å½¢å¼</a></li><li><a href=#212-putæ”¾å…¥è¿æ¥æ± >2.1.2 putæ”¾å…¥è¿æ¥æ± </a></li><li><a href=#213-æ¸…ç†ç©ºé—²è¿æ¥>2.1.3 æ¸…ç†ç©ºé—²è¿æ¥</a></li></ul></li></ul></li><li><a href=#3æ‰§è¡Œè¯·æ±‚æµç¨‹>3ã€æ‰§è¡Œè¯·æ±‚æµç¨‹</a><ul><li><a href=#31æ‰§è¡Œå…¥å£>3.1ã€æ‰§è¡Œå…¥å£</a></li><li><a href=#32-è·å–æ•°æ®åº“è¿æ¥>3.2 è·å–æ•°æ®åº“è¿æ¥</a></li></ul></li></ul></li></ul></nav></div></div><div class=content id=content><p>å­¦ä¹  go è¯­è¨€é€šç”¨çš„ç»“æ„åŒ–æŸ¥è¯¢æµç¨‹æ¡†æ¶ &ndash; æ ‡å‡†åº“ database/sql</p><h1 id=ä¸€æŠ½è±¡æ¥å£å®šä¹‰>ä¸€ã€æŠ½è±¡æ¥å£å®šä¹‰</h1><p>æ ‡å‡†åº“ database/sql å®šä¹‰äº† go è¯­è¨€é€šç”¨çš„ç»“æ„åŒ–æŸ¥è¯¢æµç¨‹æ¡†æ¶ï¼Œå…¶å¯¹æ¥çš„æ•°æ®åº“ç±»å‹æ˜¯çµæ´»å¤šå˜çš„ï¼Œå¦‚ mysqlã€sqliteã€oracle ç­‰. å› æ­¤<strong>åœ¨ database/sql ä¸­ï¼Œä¸å…·ä½“æ•°æ®åº“äº¤äº’çš„ç»†èŠ‚å†…å®¹ç»Ÿä¸€æ‰˜ä»˜ç»™ä¸€ä¸ªæŠ½è±¡çš„æ•°æ®åº“é©±åŠ¨æ¨¡å—ï¼Œåœ¨å…¶ä¸­å£°æ˜å¥½ä¸€å¥—é€‚ç”¨äºå„ç±»å…³ç³»å‹æ•°æ®åº“çš„ç»Ÿä¸€è§„èŒƒï¼Œå°†å„ä¸ªå…³é”®èŠ‚ç‚¹å®šä¹‰æˆæŠ½è±¡çš„ interfaceï¼Œç”±å…·ä½“ç±»å‹çš„æ•°æ®åº“å®Œæˆæ•°æ®åº“é©±åŠ¨æ¨¡å—çš„å®ç°</strong>ï¼Œç„¶åå°†å…¶æ³¨å…¥åˆ° database/sql çš„å¤§æ¡†æ¶ä¹‹ä¸­.</p><p>database/sql å…³äºæ•°æ®åº“é©±åŠ¨æ¨¡å—ä¸‹å„æ ¸å¿ƒ interface ä¸»è¦åŒ…æ‹¬ï¼š</p><ul><li><strong>Connectorï¼šæŠ½è±¡çš„æ•°æ®åº“è¿æ¥å™¨</strong>ï¼Œéœ€è¦å…·å¤‡åˆ›å»ºæ•°æ®åº“è¿æ¥ä»¥åŠè¿”å›ä»å±çš„æ•°æ®åº“é©±åŠ¨çš„èƒ½åŠ›</li><li><strong>Driverï¼šæŠ½è±¡çš„æ•°æ®åº“é©±åŠ¨</strong>ï¼Œå…·å¤‡åˆ›å»ºæ•°æ®åº“è¿æ¥çš„èƒ½åŠ›</li><li><strong>Connï¼šæŠ½è±¡çš„æ•°æ®åº“è¿æ¥</strong>ï¼Œå…·å¤‡é¢„å¤„ç† sql ä»¥åŠå¼€å¯äº‹åŠ¡çš„èƒ½åŠ›</li><li><strong>Txï¼šæŠ½è±¡çš„äº‹åŠ¡</strong>ï¼Œå…·å¤‡æäº¤å’Œå›æ»šçš„èƒ½åŠ›</li><li><strong>Statementï¼šæŠ½è±¡çš„è¯·æ±‚é¢„å¤„ç†çŠ¶æ€</strong>. å…·å¤‡å®é™…æ‰§è¡Œ sql å¹¶è¿”å›æ‰§è¡Œç»“æœçš„èƒ½åŠ›</li><li><strong>Result/Row</strong>ï¼š<strong>æŠ½è±¡çš„ sql æ‰§è¡Œç»“æœ</strong></li></ul><p><a class=lightgallery href=../images/database_sql%e6%8e%a5%e5%8f%a3%e5%85%b3%e7%b3%bb.png title=database_sqlæ¥å£å…³ç³» data-thumbnail=../images/database_sqlæ¥å£å…³ç³».png><img class=lazyload src=/svg/loading.min.svg data-src=../images/database_sql%e6%8e%a5%e5%8f%a3%e5%85%b3%e7%b3%bb.png data-srcset="../images/database_sql%e6%8e%a5%e5%8f%a3%e5%85%b3%e7%b3%bb.png, ../images/database_sql%e6%8e%a5%e5%8f%a3%e5%85%b3%e7%b3%bb.png 1.5x, ../images/database_sql%e6%8e%a5%e5%8f%a3%e5%85%b3%e7%b3%bb.png 2x" data-sizes=auto alt=../images/database_sqlæ¥å£å…³ç³».png></a></p><h2 id=1-æŠ½è±¡æ¥å£>1ã€ æŠ½è±¡æ¥å£</h2><p>ç”±å…·ä½“çš„æ•°æ®åº“ç±»å‹æä¾›å…·ä½“çš„å®ç°ç‰ˆæœ¬</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// æŠ½è±¡çš„æ•°æ®åº“è¿æ¥å™¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>Connector</span><span class=w> </span><span class=kd>interface</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è·å–ä¸€ä¸ªæ•°æ®åº“è¿æ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Connect</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>Conn</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è·å–æ•°æ®åº“é©±åŠ¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Driver</span><span class=p>()</span><span class=w> </span><span class=nx>Driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// æŠ½è±¡çš„æ•°æ®åº“è¿æ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>Conn</span><span class=w> </span><span class=kd>interface</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// é¢„å¤„ç† sql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Prepare</span><span class=p>(</span><span class=nx>query</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>Stmt</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å…³é—­è¿æ¥   </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Close</span><span class=p>()</span><span class=w> </span><span class=kt>error</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¼€å¯äº‹åŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Begin</span><span class=p>()</span><span class=w> </span><span class=p>(</span><span class=nx>Tx</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// æŠ½è±¡çš„è¯·æ±‚é¢„å¤„ç†çŠ¶æ€æ¥å£</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>Stmt</span><span class=w> </span><span class=kd>interface</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å…³é—­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Close</span><span class=p>()</span><span class=w> </span><span class=kt>error</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è¿”å› sql ä¸­å­˜åœ¨çš„å¯å˜å‚æ•°æ•°é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>NumInput</span><span class=p>()</span><span class=w> </span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ‰§è¡Œæ“ä½œç±»å‹çš„ sql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Exec</span><span class=p>(</span><span class=nx>args</span><span class=w> </span><span class=p>[]</span><span class=nx>Value</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>Result</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ‰§è¡ŒæŸ¥è¯¢ç±»å‹çš„ sql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Query</span><span class=p>(</span><span class=nx>args</span><span class=w> </span><span class=p>[]</span><span class=nx>Value</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>Rows</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// æŠ½è±¡çš„æ‰§è¡Œç»“æœæ¥å£</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>Result</span><span class=w> </span><span class=kd>interface</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æœ€åä¸€ç¬”æ’å…¥æ•°æ®çš„ä¸»é”®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>LastInsertId</span><span class=p>()</span><span class=w> </span><span class=p>(</span><span class=kt>int64</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ“ä½œå½±å“çš„è¡Œæ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>RowsAffected</span><span class=p>()</span><span class=w> </span><span class=p>(</span><span class=kt>int64</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>Rows</span><span class=w> </span><span class=kd>interface</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è¿”å›æ‰€æœ‰åˆ—å</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Columns</span><span class=p>()</span><span class=w> </span><span class=p>[]</span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å…³é—­ rows è¿­ä»£å™¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Close</span><span class=p>()</span><span class=w> </span><span class=kt>error</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// éå†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Next</span><span class=p>(</span><span class=nx>dest</span><span class=w> </span><span class=p>[]</span><span class=nx>Value</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// æŠ½è±¡çš„äº‹åŠ¡æ¥å£</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>Tx</span><span class=w> </span><span class=kd>interface</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æäº¤äº‹åŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Commit</span><span class=p>()</span><span class=w> </span><span class=kt>error</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å›æ»šäº‹åŠ¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Rollback</span><span class=p>()</span><span class=w> </span><span class=kt>error</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// æŠ½è±¡çš„æ•°æ®åº“é©±åŠ¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>Driver</span><span class=w> </span><span class=kd>interface</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¼€å¯ä¸€ä¸ªæ–°çš„æ•°æ®åº“è¿æ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Open</span><span class=p>(</span><span class=nx>name</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>Conn</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h2 id=2åˆ›å»ºæ•°æ®åº“å®ä¾‹>2ã€åˆ›å»ºæ•°æ®åº“å®ä¾‹</h2><p>å…ˆçœ‹ä¸‹ db å®ä¾‹çš„ç»“æ„ä½“å­—æ®µï¼š</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>DB</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Total time waited for new connections.è®°å½•ç­‰å¾…æ–°è¿æ¥çš„æ€»æ—¶é•¿,ä¸»è¦ç”¨äºç»Ÿè®¡å’Œè°ƒä¼˜è¿æ¥æ± çš„æ€§èƒ½</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>waitDuration</span><span class=w> </span><span class=nx>atomic</span><span class=p>.</span><span class=nx>Int64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>connector</span><span class=w> </span><span class=nx>driver</span><span class=p>.</span><span class=nx>Connector</span><span class=w>	</span><span class=c1>// ç”¨äºåˆ›å»ºæ–°è¿æ¥çš„ Connector å¯¹è±¡,é€šå¸¸ç”±æ•°æ®åº“é©±åŠ¨å®ç°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>numClosed</span><span class=w> </span><span class=nx>atomic</span><span class=p>.</span><span class=nx>Uint64</span><span class=w>	</span><span class=c1>// ç”¨äºè®°å½•æ•°æ®åº“è¿æ¥æ± ä¸­å·²ç»å…³é—­çš„è¿æ¥æ•°ã€‚Stmt.openStmt ä¼šæ£€æŸ¥è¿™ä¸ªå­—æ®µï¼Œä»¥æ¸…ç†å…³é—­çš„è¿æ¥ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>mu</span><span class=w>           </span><span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>freeConn</span><span class=w>     </span><span class=p>[]</span><span class=o>*</span><span class=nx>driverConn</span><span class=w> </span><span class=c1>// è¿æ¥æ± ä¸­çš„ç©ºé—²è¿æ¥ ordered by returnedAt oldest to newest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>connRequests</span><span class=w> </span><span class=nx>connRequestSet</span><span class=w>	</span><span class=c1>// å­˜å‚¨ç­‰å¾…çš„è¿æ¥è¯·æ±‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>numOpen</span><span class=w>      </span><span class=kt>int</span><span class=w> </span><span class=c1>// è¡¨ç¤ºå½“å‰æ‰“å¼€ï¼ˆåŒ…æ‹¬æ­£åœ¨æ‰“å¼€å’Œå·²æ‰“å¼€ï¼‰çš„è¿æ¥æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>openerCh</span><span class=w>          </span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{}</span><span class=w>		</span><span class=c1>// é€šçŸ¥è¿æ¥æ± éœ€è¦æ‰“å¼€æ–°è¿æ¥,æ˜¯ä¸€ä¸ªä¸æºå¸¦æ•°æ®çš„é€šé“ï¼Œé€šå¸¸ç”¨äºå®ç°ä¿¡å·é€šçŸ¥æœºåˆ¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>closed</span><span class=w>            </span><span class=kt>bool</span><span class=w>				</span><span class=c1>// db å®ä¾‹æ˜¯å¦å·²å…³é—­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>dep</span><span class=w>               </span><span class=kd>map</span><span class=p>[</span><span class=nx>finalCloser</span><span class=p>]</span><span class=nx>depSet</span><span class=w>	</span><span class=c1>// å­˜å‚¨ä¾èµ–äº finalCloser ç±»å‹çš„å¯¹è±¡ï¼Œç®¡ç†å¯¹è±¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œç¡®ä¿åœ¨å…³é—­æ—¶æ­£ç¡®æ¸…ç†èµ„æº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>lastPut</span><span class=w>           </span><span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>driverConn</span><span class=p>]</span><span class=kt>string</span><span class=w> </span><span class=c1>// æœ€åä¸€æ¬¡å°†è¿æ¥æ”¾å…¥è¿æ¥æ± æ—¶çš„å †æ ˆä¿¡æ¯ï¼›debug only</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>maxIdleCount</span><span class=w>      </span><span class=kt>int</span><span class=w>                    </span><span class=c1>// è®¾ç½®ç©ºé—²è¿æ¥æ± çš„æœ€å¤§è¿æ¥æ•°ï¼Œä¸ºé›¶è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼ï¼Œå¦‚æœä¸ºè´Ÿæ•°åˆ™è¡¨ç¤ºä¸å…è®¸ç©ºé—²è¿æ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>maxOpen</span><span class=w>           </span><span class=kt>int</span><span class=w>                    </span><span class=c1>// å…è®¸çš„æœ€å¤§æ‰“å¼€è¿æ¥æ•°ï¼Œ&lt;= 0 è¡¨ç¤ºä¸é™åˆ¶æœ€å¤§è¿æ¥æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>maxLifetime</span><span class=w>       </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=w>          </span><span class=c1>// è¿æ¥çš„æœ€å¤§ç”Ÿå‘½å‘¨æœŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>maxIdleTime</span><span class=w>       </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=w>          </span><span class=c1>// è¿æ¥åœ¨ç©ºé—²çŠ¶æ€ä¸‹çš„æœ€é•¿å­˜æ´»æ—¶é—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>cleanerCh</span><span class=w>         </span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>waitCount</span><span class=w>         </span><span class=kt>int64</span><span class=w> </span><span class=c1>// è¯·æ±‚è¿æ¥æ—¶çš„ç­‰å¾…æ¬¡æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>maxIdleClosed</span><span class=w>     </span><span class=kt>int64</span><span class=w> </span><span class=c1>// å› ç©ºé—²è¿æ¥è¶…å‡ºæœ€å¤§æ•°ç›®è€Œå…³é—­çš„è¿æ¥æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>maxIdleTimeClosed</span><span class=w> </span><span class=kt>int64</span><span class=w> </span><span class=c1>// å› ç©ºé—²æ—¶é—´è¿‡é•¿è€Œè¢«å…³é—­çš„è¿æ¥æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>maxLifetimeClosed</span><span class=w> </span><span class=kt>int64</span><span class=w> </span><span class=c1>// å› è¿æ¥ç”Ÿå‘½å‘¨æœŸåˆ°æœŸè€Œè¢«å…³é—­çš„è¿æ¥æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>stop</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> 	</span><span class=c1>// å…³é—­è¿æ¥æ± æ—¶è°ƒç”¨ï¼Œç”¨äºæ¸…ç†ç›¸å…³èµ„æºå¹¶åœæ­¢è¿æ¥åˆ›å»ºæ“ä½œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>ä»¥ä¸€ä¸ªä¾‹å­å¼€å§‹å¯¹ database/sql çš„æºç è§£è¯»</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;context&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;database/sql&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;testing&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ³¨å†Œ mysql æ•°æ®åº“é©±åŠ¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>_</span><span class=w> </span><span class=s>&#34;github.com/go-sql-driver/mysql&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>user</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>UserID</span><span class=w> </span><span class=kt>int64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>Test_sql</span><span class=p>(</span><span class=nx>t</span><span class=w> </span><span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åˆ›å»º db å®ä¾‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>db</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>sql</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;mysql&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;username:passpord@(ip:port)/database&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>t</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ‰§è¡Œ sql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>ctx</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>row</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nf>QueryRowContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=s>&#34;SELECT user_id FROM user WHERE id = 1&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>row</span><span class=p>.</span><span class=nf>Err</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>t</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è§£æç»“æœ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>u</span><span class=w> </span><span class=nx>user</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>row</span><span class=p>.</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>u</span><span class=p>.</span><span class=nx>UserID</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>t</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>t</span><span class=p>.</span><span class=nf>Log</span><span class=p>(</span><span class=nx>u</span><span class=p>.</span><span class=nx>UserID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>ä» <code>sql.Open()</code> å‡½æ•°å¼€å§‹ï¼Œ<code>sql.Open</code> ä¸ä¼šç«‹å³å»ºç«‹ä¸æ•°æ®åº“çš„è¿æ¥ã€‚è¿æ¥æ˜¯åœ¨å®é™…éœ€è¦æ—¶åˆ›å»ºçš„ï¼Œä¾‹å¦‚é¦–æ¬¡æ‰§è¡ŒæŸ¥è¯¢/æˆ–è€…è°ƒç”¨ <code>DB.Ping</code></p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span><span class=w> </span><span class=nx>driversMu</span><span class=w> </span><span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span><span class=w> </span><span class=c1>// å…¨å±€å˜é‡ï¼Œè¯»å†™é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=cp>//go:linkname drivers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>var</span><span class=w> </span><span class=nx>drivers</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>driver</span><span class=p>.</span><span class=nx>Driver</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>Open</span><span class=p>(</span><span class=nx>driverName</span><span class=p>,</span><span class=w> </span><span class=nx>dataSourceName</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>DB</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>driversMu</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>driveri</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>drivers</span><span class=p>[</span><span class=nx>driverName</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>driversMu</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>ok</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;sql: unknown driver %q (forgotten import?)&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>driverName</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>driverCtx</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>driveri</span><span class=p>.(</span><span class=nx>driver</span><span class=p>.</span><span class=nx>DriverContext</span><span class=p>);</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>connector</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>driverCtx</span><span class=p>.</span><span class=nf>OpenConnector</span><span class=p>(</span><span class=nx>dataSourceName</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nf>OpenDB</span><span class=p>(</span><span class=nx>connector</span><span class=p>),</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nf>OpenDB</span><span class=p>(</span><span class=nx>dsnConnector</span><span class=p>{</span><span class=nx>dsn</span><span class=p>:</span><span class=w> </span><span class=nx>dataSourceName</span><span class=p>,</span><span class=w> </span><span class=nx>driver</span><span class=p>:</span><span class=w> </span><span class=nx>driveri</span><span class=p>}),</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>å…·ä½“æ‰§è¡Œæµç¨‹ï¼š</p><p>1ã€åŠ è¯»å†™é”è®¿é—®å…¨å±€èµ„æº <code>drivers map</code>ï¼Œä»ä¸­å–å‡ºå¯¹åº”çš„é©±åŠ¨å™¨å®ç°ç±»ï¼Œå„ä¸ªä¸åŒçš„æ•°æ®åº“æœ‰å…¶å¯¹åº”çš„å®ç°ç±»ï¼Œé€šè¿‡ <code>Register</code> å‡½æ•°æ³¨å†Œåˆ° database/sql çš„åŸºç¡€æ¡†æ¶ä¸­ã€‚</p><p>2ã€è‹¥å¯¹åº”çš„é©±åŠ¨å®ç°äº†è¿æ¥å™¨å¯¹è±¡ <code>Connector</code> ï¼Œåˆ™è·å–å¹¶åˆ›å»º db å®ä¾‹</p><p>3ã€è°ƒç”¨ OpenDB å‡½æ•°ï¼Œå¼€å§‹åˆ›å»º db å®ä¾‹</p><blockquote><p>Register å‡½æ•°ï¼š</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-GO"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-GO data-lang=GO><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>Register</span><span class=p>(</span><span class=nx>name</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>driver</span><span class=w> </span><span class=nx>driver</span><span class=p>.</span><span class=nx>Driver</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>driversMu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>defer</span><span class=w> </span><span class=nx>driversMu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>driver</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nb>panic</span><span class=p>(</span><span class=s>&#34;sql: Register driver is nil&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>dup</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>drivers</span><span class=p>[</span><span class=nx>name</span><span class=p>];</span><span class=w> </span><span class=nx>dup</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nb>panic</span><span class=p>(</span><span class=s>&#34;sql: Register called twice for driver &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nx>name</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>drivers</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>driver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></blockquote><p>å…¶ä¸­ driver.DriverContext ä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ï¼Œå…·ä½“ä¸º:</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>DriverContext</span><span class=w> </span><span class=kd>interface</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// OpenConnector must parse the name in the same format that Driver.Open</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// parses the name parameter.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>OpenConnector</span><span class=p>(</span><span class=nx>name</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>Connector</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>æ¥ç€çœ‹ OpenDB å‡½æ•°çš„å®ç°ï¼š</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-GO"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-GO data-lang=GO><span class=line><span class=cl><span class=kd>var</span><span class=w> </span><span class=nx>connectionRequestQueueSize</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>1000000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// OpenDB may just validate its arguments without creating a connection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// to the database. To verify that the data source name is valid, call</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// [DB.Ping].</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>OpenDB</span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=nx>driver</span><span class=p>.</span><span class=nx>Connector</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>DB</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>cancel</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nf>WithCancel</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>db</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>DB</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>connector</span><span class=p>:</span><span class=w> </span><span class=nx>c</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>openerCh</span><span class=p>:</span><span class=w>  </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{},</span><span class=w> </span><span class=nx>connectionRequestQueueSize</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>lastPut</span><span class=p>:</span><span class=w>   </span><span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>driverConn</span><span class=p>]</span><span class=kt>string</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>stop</span><span class=p>:</span><span class=w>      </span><span class=nx>cancel</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>go</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nf>connectionOpener</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>db</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>db</span><span class=w> </span><span class=o>*</span><span class=nx>DB</span><span class=p>)</span><span class=w> </span><span class=nf>connectionOpener</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>for</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//  ç­‰å¾…æ–°çš„è¿æ¥è¯·æ±‚åˆ°è¾¾ openerCh é€šé“ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>db</span><span class=p>.</span><span class=nx>openerCh</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>db</span><span class=p>.</span><span class=nf>openNewConnection</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>1ã€åˆ›å»º DB å®ä¾‹</p><p><code>connector</code>: å®ç°äº† <code>driver.Connector</code> æ¥å£ï¼Œç”¨äºåˆ›å»ºæ•°æ®åº“è¿æ¥ã€‚</p><p><code>openerCh</code>: ä¸€ä¸ªç¼“å†²é€šé“ï¼Œä½œä¸ºè¿æ¥è¯·æ±‚çš„ç­‰å¾…é˜Ÿåˆ—ã€‚å®¹é‡ç”± <code>connectionRequestQueueSize</code> å®šä¹‰ï¼Œå†³å®šäº†æœ€å¤šå¯ä»¥åŒæ—¶ç­‰å¾…çš„è¿æ¥è¯·æ±‚æ•°</p><p><code>lastPut</code>: è®°å½•æœ€åä¸€æ¬¡æ”¾å›æ± ä¸­çš„è¿æ¥ï¼Œç”¨äºè°ƒè¯•æˆ–ç›‘æ§ã€‚</p><p><code>connRequests</code>: ç”¨äºç®¡ç†è¿æ¥è¯·æ±‚ï¼Œæ¯ä¸ªè¯·æ±‚ä¸å”¯ä¸€çš„ ID å…³è”ã€‚</p><p><code>stop</code>: é€šè¿‡ <code>context.CancelFunc</code> æ§åˆ¶ <code>connectionOpener</code> çš„åœæ­¢ã€‚</p><p>2ã€å¯åŠ¨ä¸€ä¸ª connectionOpener åç¨‹ï¼Œæ³¨å…¥ ctxï¼Œä»¥æ­¤æ¥æ§åˆ¶è¯¥åç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</p><p>åœ¨ connectionOpener åç¨‹ä¸­ï¼Œé€šè¿‡ for select å¾ªç¯ç›‘å¬ done å’Œ db.openerCh é€šé“ï¼Œä»¥æ­¤æ¥æ‰“å¼€ä¸€ä¸ªæ–°è¿æ¥ï¼Œå…¶å…·ä½“å®ç°ä¸ºï¼š</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-GO"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-GO data-lang=GO><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>db</span><span class=w> </span><span class=o>*</span><span class=nx>DB</span><span class=p>)</span><span class=w> </span><span class=nf>openNewConnection</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// maybeOpenNewConnections has already executed db.numOpen++ before it sent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// on db.openerCh. This function must execute db.numOpen-- if the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// connection fails or is closed before returning.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>ci</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>connector</span><span class=p>.</span><span class=nf>Connect</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span><span class=w>	</span><span class=c1>// åˆ›å»ºä¸€ä¸ªåº•å±‚æ•°æ®åº“è¿æ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>defer</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>closed</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>ci</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nx>numOpen</span><span class=o>--</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nx>numOpen</span><span class=o>--</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nf>putConnDBLocked</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nf>maybeOpenNewConnections</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>dc</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>driverConn</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>:</span><span class=w>         </span><span class=nx>db</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>createdAt</span><span class=p>:</span><span class=w>  </span><span class=nf>nowFunc</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>returnedAt</span><span class=p>:</span><span class=w> </span><span class=nf>nowFunc</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>ci</span><span class=p>:</span><span class=w>         </span><span class=nx>ci</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nf>putConnDBLocked</span><span class=p>(</span><span class=nx>dc</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nf>addDepLocked</span><span class=p>(</span><span class=nx>dc</span><span class=p>,</span><span class=w> </span><span class=nx>dc</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nx>numOpen</span><span class=o>--</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>ci</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>1ï¼‰<code>db.connector.Connect(ctx)</code> åˆ›å»ºä¸€ä¸ªåº•å±‚æ•°æ®åº“è¿æ¥</p><p>2ï¼‰åŠ é”</p><p>3ï¼‰åˆ¤æ–­ db å®ä¾‹æ˜¯å¦å·²å…³é—­ï¼Œå³ä½¿åˆ›å»ºè¿æ¥æˆåŠŸï¼Œä¹Ÿå°†å…¶å…³é—­ï¼Œå¹¶ä¸”å°† db å®ä¾‹çš„è¿æ¥æ‰“å¼€æ•°å‡ä¸€</p><p>4ï¼‰db å®ä¾‹æœªå…³é—­ä½†æ˜¯è¿æ¥åˆ›å»ºæœªæˆåŠŸï¼Œè°ƒç”¨ <code>putConnDBLocked</code> è®°å½•é”™è¯¯ï¼Œå°è¯•è§¦å‘æ–°çš„è¿æ¥åˆ›å»ºï¼ˆé€šè¿‡ <code>maybeOpenNewConnections</code>ï¼‰</p><p>5ï¼‰è¿æ¥åˆ›å»ºæˆåŠŸï¼Œå°†æ–°åˆ›å»ºçš„è¿æ¥å°è£…ä¸º <code>driverConn</code>ï¼ŒåŒ…å«äº†å…ƒä¿¡æ¯ï¼ˆå¦‚åˆ›å»ºæ—¶é—´ï¼‰</p><p>6ï¼‰è°ƒç”¨ <code>putConnDBLocked</code> å°è¯•å°†è¿æ¥æ”¾å…¥ç©ºé—²æ± ä¸­ï¼ŒæˆåŠŸåˆ™æ›´æ–°è¿æ¥çš„ä¾èµ–å…³ç³»ï¼›å¦‚æœæ”¾å…¥å¤±è´¥ï¼ˆå¯èƒ½æ˜¯ç©ºé—²æ± å·²æ»¡æˆ–å…¶ä»–åŸå› ï¼‰ï¼Œå…³é—­è¿æ¥å¹¶å‡å°‘è®¡æ•°</p><p>é€šè¿‡ <code>maybeOpenNewConnections</code> å‡½æ•°ä¸æ–­åœ°å¯¹è¿æ¥è¯·æ±‚è¿›è¡Œåˆ›å»ºï¼Œç›´è‡³å…¨éƒ¨æ»¡è¶³</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// If there are connRequests and the connection limit hasn&#39;t been reached,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// then tell the connectionOpener to open new connections.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>db</span><span class=w> </span><span class=o>*</span><span class=nx>DB</span><span class=p>)</span><span class=w> </span><span class=nf>maybeOpenNewConnections</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>numRequests</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>connRequests</span><span class=p>.</span><span class=nf>Len</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>maxOpen</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>numCanOpen</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>maxOpen</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>numOpen</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>numRequests</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=nx>numCanOpen</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>numRequests</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>numCanOpen</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>for</span><span class=w> </span><span class=nx>numRequests</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nx>numOpen</span><span class=o>++</span><span class=w> </span><span class=c1>// optimistically</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>numRequests</span><span class=o>--</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>closed</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nx>openerCh</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=kd>struct</span><span class=p>{}{}</span><span class=w>	</span><span class=c1>// åœ¨ openNewConnections å‡½æ•°ç›‘å¬ï¼Œè·å–ä¸€ä¸ªæ–°è¿æ¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h3 id=21-è¿æ¥æ± çš„ç®¡ç†>2.1 è¿æ¥æ± çš„ç®¡ç†</h3><h4 id=211-è¿æ¥çš„è¡¨è¾¾å½¢å¼>2.1.1 è¿æ¥çš„è¡¨è¾¾å½¢å¼</h4><p>ä¸€æ¡è¿æ¥æ˜¯æ€ä¹ˆè¡¨è¾¾çš„ï¼Ÿæ•°æ®åº“é©±åŠ¨è¿æ¥é€šè¿‡å¦‚ä¸‹ç»“æ„åŒ…è£…äº†ä¸€å±‚ï¼Œæ·»åŠ äº†åˆ›å»ºæ—¶é—´ï¼Œé”ä¿æŠ¤æœºåˆ¶ç­‰ï¼Œå®ƒè´Ÿè´£ç®¡ç†è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬é‡ç½®ã€å…³é—­ç­‰æ“ä½œã€‚</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// driverConn wraps a driver.Conn with a mutex, to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// be held during all calls into the Conn. (including any calls onto</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// interfaces returned via that Conn, such as calls on Tx, Stmt,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// Result, Rows)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>driverConn</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>db</span><span class=w>        </span><span class=o>*</span><span class=nx>DB</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>createdAt</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span><span class=w>  </span><span class=c1>// guards following</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>ci</span><span class=w>          </span><span class=nx>driver</span><span class=p>.</span><span class=nx>Conn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>needReset</span><span class=w>   </span><span class=kt>bool</span><span class=w> </span><span class=c1>// The connection session should be reset before use if true.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>closed</span><span class=w>      </span><span class=kt>bool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>finalClosed</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=c1>// ci.Close has been called</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>openStmt</span><span class=w>    </span><span class=kd>map</span><span class=p>[</span><span class=o>*</span><span class=nx>driverStmt</span><span class=p>]</span><span class=kt>bool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// guarded by db.mu</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>inUse</span><span class=w>      </span><span class=kt>bool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>returnedAt</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=w> </span><span class=c1>// Time the connection was created or returned.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>onPut</span><span class=w>      </span><span class=p>[]</span><span class=kd>func</span><span class=p>()</span><span class=w>  </span><span class=c1>// code (with db.mu held) run when conn is next returned</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>dbmuClosed</span><span class=w> </span><span class=kt>bool</span><span class=w>      </span><span class=c1>// same as closed, but guarded by db.mu, for removeClosedStmtLocked</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>ci driver.Conn</code>: å®é™…çš„æ•°æ®åº“è¿æ¥ï¼Œæ»¡è¶³ driver.Conn æ¥å£</p><p><code>needReset bool</code>: æ ‡å¿—ï¼šå¦‚æœä¸º trueï¼Œè¡¨ç¤ºè¿æ¥éœ€è¦åœ¨ä½¿ç”¨å‰é‡ç½®</p><p><code>closed bool</code>: æ ‡å¿—ï¼šè¡¨ç¤ºæ­¤è¿æ¥æ˜¯å¦å·²å…³é—­</p><p><code>finalClosed bool</code>: æ ‡å¿—ï¼šè¡¨ç¤ºåº•å±‚è¿æ¥çš„ Close æ–¹æ³•æ˜¯å¦å·²è¢«è°ƒç”¨</p><p><code>openStmt map[*driveStmt]bool</code>: å½“å‰è¿æ¥ä¸Šæ˜¯å¦æœ‰æ‰“å¼€çš„è¯­å¥</p><p><code>inUse bool</code>: æ ‡å¿—ï¼šè¯¥è¿æ¥æ˜¯å¦æ­£åœ¨è¢«ä½¿ç”¨</p><p><code>returnedAt time.Time</code>: è¿æ¥è¢«åˆ›å»ºæˆ–è¿”å›çš„æ—¶é—´</p><p><code>onPut []func()</code>: å½“è¿æ¥è¢«è¿”å›æ—¶æ‰§è¡Œçš„ä»£ç ï¼ˆæŒæœ‰ db.mu é”æ—¶ï¼‰</p><p><code>dbmuClosed bool</code>: ä¸ closed ç±»ä¼¼ï¼Œä½†ç”± db.mu é”ä¿æŠ¤ï¼Œé¿å…å¹¶å‘è®¿é—®</p><h4 id=212-putæ”¾å…¥è¿æ¥æ± >2.1.2 putæ”¾å…¥è¿æ¥æ± </h4><p>é‚£ä¹ˆè¿æ¥æ˜¯æ€ä¹ˆè¢«æ”¾å…¥è¿æ¥æ± çš„ï¼Ÿè¿æ¥æ± æ˜¯æ€ä¹ˆç®¡ç†çš„ï¼Ÿ</p><p><code>putConnDBLocked</code> å‡½æ•°ä¸»è¦ç”¨äºç®¡ç†æ•°æ®åº“è¿æ¥æ± çš„è¡Œä¸ºã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯å¤„ç†ä¸€ä¸ªè¿æ¥è¯·æ±‚ï¼ˆconnRequestï¼‰ï¼Œæˆ–è€…å°†ä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼ˆdriverConnï¼‰æ”¾å…¥ç©ºé—²è¿æ¥æ± ä¸­ã€‚å¦‚æœæ—¢æ²¡æœ‰æ»¡è¶³è¿æ¥è¯·æ±‚ï¼Œä¹Ÿæ²¡æœ‰å°†è¿æ¥æ”¾å…¥ç©ºé—²æ± ï¼Œå®ƒå°†è¿”å› falseã€‚</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Satisfy a connRequest or put the driverConn in the idle pool and return true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// or return false.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// putConnDBLocked will satisfy a connRequest if there is one, or it will</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// return the *driverConn to the freeConn list if err == nil and the idle</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// connection limit will not be exceeded.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// If err != nil, the value of dc is ignored.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// If err == nil, then dc must not equal nil.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// If a connRequest was fulfilled or the *driverConn was placed in the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// freeConn list, then true is returned, otherwise false is returned.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>db</span><span class=w> </span><span class=o>*</span><span class=nx>DB</span><span class=p>)</span><span class=w> </span><span class=nf>putConnDBLocked</span><span class=p>(</span><span class=nx>dc</span><span class=w> </span><span class=o>*</span><span class=nx>driverConn</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ£€æŸ¥ db æ˜¯å¦å·²å…³é—­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>closed</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ£€æŸ¥æ˜¯å¦è¶…è¿‡ db å…è®¸æ‰“å¼€çš„æœ€å¤§è¿æ¥æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>maxOpen</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>numOpen</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>maxOpen</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ä»è¿æ¥è¯·æ±‚é˜Ÿåˆ—ä¸­éšæœºå–ä¸€ä¸ªè¿æ¥è¯·æ±‚ï¼Œè‹¥æˆåŠŸå–åˆ°åˆ™æ ‡è®° dc è¿æ¥å·²è¢«ä½¿ç”¨ï¼Œå¹¶é€šè¿‡ chan å‘é€ç»™è¿æ¥è¯·æ±‚ç­‰å¾…æ–¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>req</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>connRequests</span><span class=p>.</span><span class=nf>TakeRandom</span><span class=p>();</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>dc</span><span class=p>.</span><span class=nx>inUse</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>req</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=nx>connRequest</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>conn</span><span class=p>:</span><span class=w> </span><span class=nx>dc</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>err</span><span class=p>:</span><span class=w>  </span><span class=nx>err</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>!</span><span class=nx>db</span><span class=p>.</span><span class=nx>closed</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nf>maxIdleConnsLocked</span><span class=p>()</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>db</span><span class=p>.</span><span class=nx>freeConn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>db</span><span class=p>.</span><span class=nx>freeConn</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>db</span><span class=p>.</span><span class=nx>freeConn</span><span class=p>,</span><span class=w> </span><span class=nx>dc</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>db</span><span class=p>.</span><span class=nf>startCleanerLocked</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nx>maxIdleClosed</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// connRequestSet is a set of chan connRequest that&#39;s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// optimized for:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>//   - adding an element</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//   - removing an element (only by the caller who added it)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//   - taking (get + delete) a random element</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// We previously used a map for this but the take of a random element</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// was expensive, making mapiters. This type avoids a map entirely</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// and just uses a slice.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>connRequestSet</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// s are the elements in the set.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>s</span><span class=w> </span><span class=p>[]</span><span class=nx>connRequestAndIndex</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>connRequestAndIndex</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// req is the element in the set.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>req</span><span class=w> </span><span class=kd>chan</span><span class=w> </span><span class=nx>connRequest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// curIdx points to the current location of this element in</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// connRequestSet.s. It gets set to -1 upon removal.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>curIdx</span><span class=w> </span><span class=o>*</span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>1ï¼‰ä¼˜å…ˆå¤„ç†ç­‰å¾…çš„è¿æ¥è¯·æ±‚ï¼Œå¾€é€šé“ä¸­å‘é€è¿æ¥ç»™ç­‰å¾…è€…</p><p>2ï¼‰å¦‚æœæ²¡æœ‰ç­‰å¾…çš„è¿æ¥è¯·æ±‚ï¼Œå¹¶ä¸” <code>err == nil</code>ï¼ˆè¿æ¥æœ‰æ•ˆï¼‰ä¸”æ•°æ®åº“æœªå…³é—­ï¼›</p><p>æ£€æŸ¥ç©ºé—²è¿æ¥æ± ï¼ˆ<code>db.freeConn</code>ï¼‰æ˜¯å¦æœªæ»¡ï¼š</p><ul><li>è°ƒç”¨ <code>db.maxIdleConnsLocked()</code> è·å–å…è®¸çš„æœ€å¤§ç©ºé—²è¿æ¥æ•°ã€‚</li><li>å¦‚æœç©ºé—²æ± æœªæ»¡ï¼Œå°† <code>dc</code> æ”¾å…¥ <code>db.freeConn</code>ï¼Œå¹¶å¯åŠ¨è¿æ¥æ¸…ç†å™¨ï¼ˆ<code>startCleanerLocked</code>ï¼‰ï¼Œä»¥ç¡®ä¿ç©ºé—²è¿æ¥åœ¨è¿‡æœŸæ—¶è¢«æ¸…ç†ã€‚</li><li>è¿”å› <code>true</code> è¡¨ç¤ºè¿æ¥å·²æˆåŠŸæ”¾å…¥ç©ºé—²æ± ã€‚</li></ul><p>å¦‚æœç©ºé—²æ± å·²æ»¡ï¼š</p><ul><li>å¢åŠ  <code>db.maxIdleClosed</code> è®¡æ•°ï¼Œè¡¨ç¤ºå› ç©ºé—²æ± å·²æ»¡è€Œè¢«å…³é—­çš„è¿æ¥æ•°é‡ã€‚</li></ul><h4 id=213-æ¸…ç†ç©ºé—²è¿æ¥>2.1.3 æ¸…ç†ç©ºé—²è¿æ¥</h4><p><code>startCleanerLocked</code> å®šæ—¶æ¸…ç†ç©ºé—²è¿æ¥ï¼š</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// startCleanerLocked starts connectionCleaner if needed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>db</span><span class=w> </span><span class=o>*</span><span class=nx>DB</span><span class=p>)</span><span class=w> </span><span class=nf>startCleanerLocked</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>db</span><span class=p>.</span><span class=nx>maxLifetime</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>maxIdleTime</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>numOpen</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>cleanerCh</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nx>cleanerCh</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{},</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>go</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nf>connectionCleaner</span><span class=p>(</span><span class=nx>db</span><span class=p>.</span><span class=nf>shortestIdleTimeLocked</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>db</span><span class=w> </span><span class=o>*</span><span class=nx>DB</span><span class=p>)</span><span class=w> </span><span class=nf>shortestIdleTimeLocked</span><span class=p>()</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>maxIdleTime</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>maxLifetime</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>maxLifetime</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>maxIdleTime</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nb>min</span><span class=p>(</span><span class=nx>db</span><span class=p>.</span><span class=nx>maxIdleTime</span><span class=p>,</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>maxLifetime</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>db</span><span class=w> </span><span class=o>*</span><span class=nx>DB</span><span class=p>)</span><span class=w> </span><span class=nf>connectionCleaner</span><span class=p>(</span><span class=nx>d</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>const</span><span class=w> </span><span class=nx>minInterval</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>d</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>minInterval</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>d</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>minInterval</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>t</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>NewTimer</span><span class=p>(</span><span class=nx>d</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>for</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>t</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>db</span><span class=p>.</span><span class=nx>cleanerCh</span><span class=p>:</span><span class=w> </span><span class=c1>// maxLifetime was changed or db was closed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// å†æ¬¡è·å–æ¸…ç†é—´éš”æ—¶é—´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>d</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nf>shortestIdleTimeLocked</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ•°æ®åº“å®ä¾‹å…³é—­æˆ–è€…æ‰“å¼€è¿æ¥æ•°ç­‰äº0æˆ–è€…æ¸…ç†é—´éš”æ—¶é—´å°äºç­‰äº0ï¼Œåˆ™åœæ­¢æ¸…ç†æ“ä½œï¼Œè§£é”è¿”å›</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>closed</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>numOpen</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>d</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>db</span><span class=p>.</span><span class=nx>cleanerCh</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>d</span><span class=p>,</span><span class=w> </span><span class=nx>closing</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nf>connectionCleanerRunLocked</span><span class=p>(</span><span class=nx>d</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>closing</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>c</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>d</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>minInterval</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>d</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>minInterval</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>t</span><span class=p>.</span><span class=nf>Stop</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>t</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>t</span><span class=p>.</span><span class=nf>Reset</span><span class=p>(</span><span class=nx>d</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>1ã€å¦‚æœæ•°æ®åº“çš„æœ€å¤§è¿æ¥ç”Ÿå‘½å‘¨æœŸ (maxLifetime) æˆ–æœ€å¤§ç©ºé—²æ—¶é—´ (maxIdleTime) å¤§äºé›¶ï¼Œå¹¶ä¸”å½“å‰æ‰“å¼€çš„è¿æ¥æ•°å¤§äºé›¶ï¼Œåˆ™å¯åŠ¨ä¸€ä¸ªæ¸…ç† goroutine æ¥å®šæœŸæ£€æŸ¥å’Œæ¸…ç†è¿æ¥æ± ä¸­çš„ç©ºé—²è¿æ¥ã€‚<code>db.cleanerCh == nil</code>ï¼šè¡¨ç¤ºæ²¡æœ‰æ­£åœ¨è¿è¡Œçš„æ¸…ç† goroutineï¼Œé˜²æ­¢é‡å¤å¯åŠ¨ã€‚</p><p>2ã€å¯åŠ¨ä¸€ä¸ªæ–°çš„ <code>goroutine db.connectionCleaner</code>ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ªæ¸…ç†é—´éš”æ—¶é—´ã€‚æ¸…ç†é—´éš”ç”± <code>shortestIdleTimeLocked</code> æ–¹æ³•è®¡ç®—å¾—å‡ºï¼Œè¿”å›å€¼æ˜¯ <code>maxIdleTime</code> å’Œ <code>maxLifetime</code> ä¸­è¾ƒçŸ­çš„ä¸€ä¸ªã€‚</p><p>3ã€for select é˜»å¡ç­‰å¾…æ¸…ç†æ—¶é—´åˆ°è¾¾ï¼Œæˆ–è¿æ¥æ± è¢«å…³é—­æˆ–è€… maxLifetime è®¾ç½®å‘ç”Ÿå˜åŒ–</p><p>4ã€å†æ¬¡è·å–æ¸…ç†é—´éš”æ—¶é—´ï¼Œå¦‚æœæ•°æ®åº“å®ä¾‹å…³é—­æˆ–è€…æ‰“å¼€è¿æ¥æ•°ç­‰äº0æˆ–è€…æ¸…ç†é—´éš”æ—¶é—´å°äºç­‰äº0ï¼Œåˆ™åœæ­¢æ¸…ç†æ“ä½œï¼Œè§£é”è¿”å›</p><p>5ã€è°ƒç”¨ <code>connectionCleanerRunLocked</code> å‡½æ•°æ‰§è¡Œå®é™…çš„è¿æ¥æ¸…ç†é€»è¾‘ï¼Œè¿”å›æ›´æ–°åçš„æ¸…ç†æ—¶é—´å’Œå…³é—­çš„è¿æ¥åˆ—è¡¨ã€‚</p><p>6ã€è§£é”</p><p>7ã€è°ƒç”¨å…·ä½“çš„å®ç°ç±»çš„é‡Šæ”¾è¿æ¥å‡½æ•°ï¼Œè®¾ç½® dirverConn çš„å„ç±»æ ‡è¯†ç¬¦</p><p>8ã€é‡æ–°è®¾ç½®æ—¶é—´é—´éš” d å®šæ—¶å™¨</p><p><code>connectionCleanerRunLocked</code> å…·ä½“æ“ä½œè¿æ¥æ± é‡Šæ”¾çš„å‡½æ•°ï¼Œå‡½æ•°åå¸¦ lockedçš„éƒ½æ˜¯éœ€è¦æŒæœ‰é”è°ƒç”¨çš„ï¼Œè¯¥å‡½æ•°è¿”å›æ›´æ–°åçš„æ¸…ç†æ—¶é—´å’Œå…³é—­çš„è¿æ¥åˆ—è¡¨ã€‚</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// connectionCleanerRunLocked removes connections that should be closed from</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// freeConn and returns them along side an updated duration to the next check</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// if a quicker check is required to ensure connections are checked appropriately.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>db</span><span class=w> </span><span class=o>*</span><span class=nx>DB</span><span class=p>)</span><span class=w> </span><span class=nf>connectionCleanerRunLocked</span><span class=p>(</span><span class=nx>d</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>,</span><span class=w> </span><span class=p>[]</span><span class=o>*</span><span class=nx>driverConn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>var</span><span class=w> </span><span class=nx>idleClosing</span><span class=w> </span><span class=kt>int64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>var</span><span class=w> </span><span class=nx>closing</span><span class=w> </span><span class=p>[]</span><span class=o>*</span><span class=nx>driverConn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>maxIdleTime</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// As freeConn is ordered by returnedAt process</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// in reverse order to minimise the work needed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>idleSince</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>nowFunc</span><span class=p>().</span><span class=nf>Add</span><span class=p>(</span><span class=o>-</span><span class=nx>db</span><span class=p>.</span><span class=nx>maxIdleTime</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>last</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>db</span><span class=p>.</span><span class=nx>freeConn</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>last</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=o>--</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>c</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>freeConn</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>returnedAt</span><span class=p>.</span><span class=nf>Before</span><span class=p>(</span><span class=nx>idleSince</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>i</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>closing</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>freeConn</span><span class=p>[:</span><span class=nx>i</span><span class=p>:</span><span class=nx>i</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>db</span><span class=p>.</span><span class=nx>freeConn</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>freeConn</span><span class=p>[</span><span class=nx>i</span><span class=p>:]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>idleClosing</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>int64</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>closing</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>db</span><span class=p>.</span><span class=nx>maxIdleTimeClosed</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>idleClosing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>break</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>db</span><span class=p>.</span><span class=nx>freeConn</span><span class=p>)</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>c</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>freeConn</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>d2</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>returnedAt</span><span class=p>.</span><span class=nf>Sub</span><span class=p>(</span><span class=nx>idleSince</span><span class=p>);</span><span class=w> </span><span class=nx>d2</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>d</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// Ensure idle connections are cleaned up as soon as</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// possible.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>d</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>d2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>maxLifetime</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>expiredSince</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>nowFunc</span><span class=p>().</span><span class=nf>Add</span><span class=p>(</span><span class=o>-</span><span class=nx>db</span><span class=p>.</span><span class=nx>maxLifetime</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>db</span><span class=p>.</span><span class=nx>freeConn</span><span class=p>);</span><span class=w> </span><span class=nx>i</span><span class=o>++</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>c</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>freeConn</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>createdAt</span><span class=p>.</span><span class=nf>Before</span><span class=p>(</span><span class=nx>expiredSince</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>closing</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>closing</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>last</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>db</span><span class=p>.</span><span class=nx>freeConn</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// Use slow delete as order is required to ensure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// connections are reused least idle time first.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nb>copy</span><span class=p>(</span><span class=nx>db</span><span class=p>.</span><span class=nx>freeConn</span><span class=p>[</span><span class=nx>i</span><span class=p>:],</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>freeConn</span><span class=p>[</span><span class=nx>i</span><span class=o>+</span><span class=mi>1</span><span class=p>:])</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>db</span><span class=p>.</span><span class=nx>freeConn</span><span class=p>[</span><span class=nx>last</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>db</span><span class=p>.</span><span class=nx>freeConn</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>freeConn</span><span class=p>[:</span><span class=nx>last</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>i</span><span class=o>--</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=nx>d2</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>createdAt</span><span class=p>.</span><span class=nf>Sub</span><span class=p>(</span><span class=nx>expiredSince</span><span class=p>);</span><span class=w> </span><span class=nx>d2</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>d</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// Prevent connections sitting the freeConn when they</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// have expired by updating our next deadline d.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>d</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>d2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nx>maxLifetimeClosed</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nb>int64</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>closing</span><span class=p>))</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nx>idleClosing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>d</span><span class=p>,</span><span class=w> </span><span class=nx>closing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>1ã€æ¸…ç†å› åˆ°è¾¾æœ€å¤§ç©ºé—²æ—¶é—´çš„è¿æ¥</p><p>â€‹ <code>idleSince := nowFunc().Add(-db.maxIdleTime)</code>ï¼šç”¨å½“å‰æ—¶é—´ - æœ€å¤§ç©ºé—²æ—¶é•¿ï¼Œå¾—åˆ°ä»è¿™ä¸ªæ—¶é—´ç‚¹ä»¥å‰çš„åˆ›å»ºçš„è¿æ¥éƒ½æ˜¯åˆ°è¾¾äº†æœ€å¤§ç©ºé—²æ—¶é—´çš„ã€‚</p><p><a class=lightgallery href=../images/%e6%b8%85%e7%90%86%e5%88%b0%e8%be%be%e6%9c%80%e5%a4%a7%e7%a9%ba%e9%97%b2%e6%97%b6%e9%97%b4%e8%bf%9e%e6%8e%a5.png title=æ¸…ç†åˆ°è¾¾æœ€å¤§ç©ºé—²æ—¶é—´è¿æ¥ data-thumbnail=../images/æ¸…ç†åˆ°è¾¾æœ€å¤§ç©ºé—²æ—¶é—´è¿æ¥.png><img class=lazyload src=/svg/loading.min.svg data-src=../images/%e6%b8%85%e7%90%86%e5%88%b0%e8%be%be%e6%9c%80%e5%a4%a7%e7%a9%ba%e9%97%b2%e6%97%b6%e9%97%b4%e8%bf%9e%e6%8e%a5.png data-srcset="../images/%e6%b8%85%e7%90%86%e5%88%b0%e8%be%be%e6%9c%80%e5%a4%a7%e7%a9%ba%e9%97%b2%e6%97%b6%e9%97%b4%e8%bf%9e%e6%8e%a5.png, ../images/%e6%b8%85%e7%90%86%e5%88%b0%e8%be%be%e6%9c%80%e5%a4%a7%e7%a9%ba%e9%97%b2%e6%97%b6%e9%97%b4%e8%bf%9e%e6%8e%a5.png 1.5x, ../images/%e6%b8%85%e7%90%86%e5%88%b0%e8%be%be%e6%9c%80%e5%a4%a7%e7%a9%ba%e9%97%b2%e6%97%b6%e9%97%b4%e8%bf%9e%e6%8e%a5.png 2x" data-sizes=auto alt=../images/æ¸…ç†åˆ°è¾¾æœ€å¤§ç©ºé—²æ—¶é—´è¿æ¥.png></a></p><p>åœ¨ä¸´ç•Œç‚¹å·¦è¾¹åˆ›å»ºçš„è¿æ¥éƒ½æ˜¯åˆ°è¾¾äº†æœ€å¤§ç©ºé—²æ—¶é—´çš„ï¼Œfor å¾ªç¯å€’å™éå†æ˜¯å› ä¸º <code>freeConn</code> æ˜¯æŒ‰ç…§è¿æ¥çš„è¿”å›æ—¶é—´æ’å¥½åºçš„ï¼Œåªéœ€è¦æ‰¾åˆ°ç¬¬ä¸€ä¸ªåˆ°è¾¾æœ€å¤§ç©ºé—²æ—¶é—´çš„è¿æ¥å³å¯ï¼Œå¾€å‰æ‰€æœ‰çš„è¿æ¥éƒ½æ˜¯åˆ°è¾¾äº†æœ€å¤§ç©ºé—²æ—¶é—´ï¼Œèƒ½å¤Ÿæœ‰æ•ˆå‡å°‘éå†æ£€æŸ¥çš„è¿æ¥æ•°ã€‚</p><p>æˆªæ–­ <code>db.freeConn = db.freeConn[i:]</code>, iä½ç½®å¾€åçš„æ˜¯è¿˜æœ‰æ•ˆçš„ã€‚</p><p>ç´¯åŠ å› åˆ°è¾¾æœ€å¤§ç©ºé—²æ—¶é—´è€Œå…³é—­çš„è¿æ¥</p><p>2ã€æ¸…ç†å› åˆ°è¾¾æœ€å¤§ç”Ÿå‘½å‘¨æœŸçš„è¿æ¥ (å¤„ç†æ–¹å¼å¯å­¦ä¹ )</p><p>â€‹ <code>expiredSince := nowFunc().Add(-db.maxLifetime)</code>:è®¡ç®—å‡ºåº”è¯¥è¢«æ¸…ç†çš„æœ€æ—©è¿‡æœŸæ—¶é—´ç‚¹</p><p>â€‹ å¦‚æœå½“å‰è¿æ¥çš„åˆ›å»ºæ—¶é—´æ—©äº expiredSinceï¼Œè¡¨ç¤ºè¯¥è¿æ¥å·²ç»è¿‡æœŸï¼Œåº”è¯¥è¢«æ¸…ç†ã€‚</p><pre><code>- å°†å…¶åŠ å…¥ closing åˆ—è¡¨ã€‚
- ä½¿ç”¨æ…¢åˆ é™¤æ–¹æ³•ï¼šå°† i åé¢çš„è¿æ¥å‘å‰ç§»åŠ¨ï¼Œç¡®ä¿è¿æ¥æ± ä¸­çš„è¿æ¥é¡ºåºä¸è¢«æ‰“ä¹±, `copy(db.freeConn[i:], db.freeConn[i+1:])` å…¶ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ src
- æœ€åä¸€ä¸ªå…ƒç´ å»æ‰å¼•ç”¨ï¼Œå¹¶æ›´æ–°åˆ‡ç‰‡ `freeConn`
- å› ä¸ºåˆ é™¤äº†ä¸€ä¸ªå…ƒç´ ï¼Œæ‰€ä»¥ç´¢å¼• i å›é€€ï¼Œä»¥ä¾¿ç»§ç»­æ£€æŸ¥å½“å‰ç´¢å¼•ä½ç½®çš„æ–°å…ƒç´ 
</code></pre><p>3ã€æ›´æ–°æ¸…ç†æ—¶é—´é—´éš” d</p><p>å½“ç©ºé—²è¿æ¥çš„ç©ºé—²æ—¶é—´æ¥è¿‘ maxIdleTimeï¼Œæˆ–è€…è¿‡æœŸè¿æ¥æ¥è¿‘ maxLifetime æ—¶ï¼Œd ä¼šè¢«æ›´æ–°ä¸ºæ›´çŸ­çš„æ—¶é—´ã€‚è¿™æ„å‘³ç€æ¸…ç†æ“ä½œä¼šæå‰è¿›è¡Œï¼Œè€Œä¸æ˜¯ç­‰å¾…åŸå®šçš„æ—¶é—´é—´éš”ã€‚</p><p>è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼šå¦‚æœ d æ²¡æœ‰è¢«æ›´æ–°ï¼Œè€Œæ˜¯å§‹ç»ˆä¿æŒåŸå€¼ï¼Œåˆ™å¯èƒ½ä¼šå¯¼è‡´è¿æ¥æ± ä¸­çš„æŸäº›è¿æ¥å³å°†è¾¾åˆ° maxIdleTime æˆ– maxLifetime æ—¶ï¼Œæ¸…ç†æ“ä½œä»ç„¶å»¶è¿Ÿè¿›è¡Œï¼Œé€ æˆè¿æ¥æ± ä¸­å¯èƒ½è¿˜å­˜åœ¨æ— ç”¨çš„è¿æ¥ã€‚é€šè¿‡åŠ¨æ€è°ƒæ•´ dï¼Œå³ä½¿ä¸‹æ¬¡æ¸…ç†çš„æ—¶é—´é—´éš”æ²¡æœ‰åˆ°è¾¾ï¼Œç³»ç»Ÿä¹Ÿä¼šæ ¹æ®å½“å‰ç©ºé—²è¿æ¥æˆ–è¿‡æœŸè¿æ¥çš„æƒ…å†µï¼ŒåŠæ—¶è§¦å‘æ¸…ç†æ“ä½œï¼Œé¿å…èµ„æºæµªè´¹å’Œä¸å¿…è¦çš„è¿æ¥å ç”¨ã€‚</p><h2 id=3æ‰§è¡Œè¯·æ±‚æµç¨‹>3ã€æ‰§è¡Œè¯·æ±‚æµç¨‹</h2><h3 id=31æ‰§è¡Œå…¥å£>3.1ã€æ‰§è¡Œå…¥å£</h3><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>db</span><span class=w> </span><span class=o>*</span><span class=nx>DB</span><span class=p>)</span><span class=w> </span><span class=nf>QueryRowContext</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>query</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>args</span><span class=w> </span><span class=o>...</span><span class=kt>any</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>Row</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>rows</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nf>QueryContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>query</span><span class=p>,</span><span class=w> </span><span class=nx>args</span><span class=o>...</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>Row</span><span class=p>{</span><span class=nx>rows</span><span class=p>:</span><span class=w> </span><span class=nx>rows</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>:</span><span class=w> </span><span class=nx>err</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>db</span><span class=w> </span><span class=o>*</span><span class=nx>DB</span><span class=p>)</span><span class=w> </span><span class=nf>QueryContext</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>query</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>args</span><span class=w> </span><span class=o>...</span><span class=kt>any</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>Rows</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>var</span><span class=w> </span><span class=nx>rows</span><span class=w> </span><span class=o>*</span><span class=nx>Rows</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>var</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=kt>error</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nf>retry</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>strategy</span><span class=w> </span><span class=nx>connReuseStrategy</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>rows</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nf>query</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>query</span><span class=p>,</span><span class=w> </span><span class=nx>args</span><span class=p>,</span><span class=w> </span><span class=nx>strategy</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>rows</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// maxBadConnRetries is the number of maximum retries if the driver returns</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// driver.ErrBadConn to signal a broken connection before forcing a new</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// connection to be opened.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>const</span><span class=w> </span><span class=nx>maxBadConnRetries</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>const</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// alwaysNewConn forces a new connection to the database.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>alwaysNewConn</span><span class=w> </span><span class=nx>connReuseStrategy</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>iota</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// cachedOrNewConn returns a cached connection, if available, else waits</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// for one to become available (if MaxOpenConns has been reached) or</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// creates a new database connection.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>cachedOrNewConn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>db</span><span class=w> </span><span class=o>*</span><span class=nx>DB</span><span class=p>)</span><span class=w> </span><span class=nf>retry</span><span class=p>(</span><span class=nx>fn</span><span class=w> </span><span class=kd>func</span><span class=p>(</span><span class=nx>strategy</span><span class=w> </span><span class=nx>connReuseStrategy</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>int64</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>maxBadConnRetries</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=o>++</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>fn</span><span class=p>(</span><span class=nx>cachedOrNewConn</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// retry if err is driver.ErrBadConn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>!</span><span class=nx>errors</span><span class=p>.</span><span class=nf>Is</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span><span class=w> </span><span class=nx>driver</span><span class=p>.</span><span class=nx>ErrBadConn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nf>fn</span><span class=p>(</span><span class=nx>alwaysNewConn</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>1ã€è¿æ¥è¿‡æœŸè€Œå¯¼è‡´å‘ç”Ÿå¶å‘æ€§çš„ ErrBadConn é”™è¯¯ï¼Œé’ˆå¯¹è¿™ç§é”™è¯¯ï¼Œå¯ä»¥é‡‡ç”¨é‡è¯•çš„æ–¹å¼æ¥æé«˜è¯·æ±‚çš„æˆåŠŸç‡ã€‚è¿ç»­é‡åˆ°ä¸¤æ¬¡ ErrBadConn ä¹‹åï¼Œä¼šå°†ç­–ç•¥è°ƒæ•´ä¸ºä¸é‡‡ç”¨è¿æ¥æ± ç›´æ¥æ–°å»ºè¿æ¥çš„æ–¹å¼ï¼Œå†å…œåº•æ‰§è¡Œä¸€æ¬¡è¯·æ±‚ã€‚</p><p>2ã€å®é™…è°ƒç”¨ <code>db.query</code> æ–¹æ³•è¿›è¡ŒæŸ¥è¯¢</p><p>åœ¨ <code>db.query</code> æ–¹æ³•ä¸­æ ¹æ®ä¸åŒç­–ç•¥è·å–æ•°æ®åº“è¿æ¥ï¼Œè°ƒç”¨ <code>db.conn</code> æ–¹æ³•ï¼Œè°ƒç”¨ <code>db.queryDC</code> æ–¹æ³•æ‰§è¡Œ sql æŸ¥è¯¢</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>db</span><span class=w> </span><span class=o>*</span><span class=nx>DB</span><span class=p>)</span><span class=w> </span><span class=nf>query</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>query</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>args</span><span class=w> </span><span class=p>[]</span><span class=kt>any</span><span class=p>,</span><span class=w> </span><span class=nx>strategy</span><span class=w> </span><span class=nx>connReuseStrategy</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>Rows</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>dc</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nf>conn</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>strategy</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nf>queryDC</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>dc</span><span class=p>,</span><span class=w> </span><span class=nx>dc</span><span class=p>.</span><span class=nx>releaseConn</span><span class=p>,</span><span class=w> </span><span class=nx>query</span><span class=p>,</span><span class=w> </span><span class=nx>args</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h3 id=32-è·å–æ•°æ®åº“è¿æ¥>3.2 è·å–æ•°æ®åº“è¿æ¥</h3><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// conn returns a newly-opened or cached *driverConn.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>db</span><span class=w> </span><span class=o>*</span><span class=nx>DB</span><span class=p>)</span><span class=w> </span><span class=nf>conn</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>strategy</span><span class=w> </span><span class=nx>connReuseStrategy</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>driverConn</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>closed</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>errDBClosed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Check if the context is expired.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Err</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>lifetime</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>maxLifetime</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Prefer a free connection, if possible.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>last</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>db</span><span class=p>.</span><span class=nx>freeConn</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>strategy</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>cachedOrNewConn</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>last</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// Reuse the lowest idle time connection so we can close</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// connections which remain idle as soon as possible.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>conn</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>freeConn</span><span class=p>[</span><span class=nx>last</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nx>freeConn</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>freeConn</span><span class=p>[:</span><span class=nx>last</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>conn</span><span class=p>.</span><span class=nx>inUse</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>conn</span><span class=p>.</span><span class=nf>expired</span><span class=p>(</span><span class=nx>lifetime</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>db</span><span class=p>.</span><span class=nx>maxLifetimeClosed</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>driver</span><span class=p>.</span><span class=nx>ErrBadConn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// Reset the session if required.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>conn</span><span class=p>.</span><span class=nf>resetSession</span><span class=p>(</span><span class=nx>ctx</span><span class=p>);</span><span class=w> </span><span class=nx>errors</span><span class=p>.</span><span class=nf>Is</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span><span class=w> </span><span class=nx>driver</span><span class=p>.</span><span class=nx>ErrBadConn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nx>conn</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Out of free connections or we were asked not to use one. If we&#39;re not</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// allowed to open any more connections, make a request and wait.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>maxOpen</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>numOpen</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>maxOpen</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// Make the connRequest channel. It&#39;s buffered so that the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// connectionOpener doesn&#39;t block while waiting for the req to be read.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>req</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=nx>connRequest</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>delHandle</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>connRequests</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>req</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nx>waitCount</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>waitStart</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>nowFunc</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// Timeout the connection request with the context.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// Remove the connection request and ensure no value has been sent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// on it after removing.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>deleted</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>connRequests</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=nx>delHandle</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>db</span><span class=p>.</span><span class=nx>waitDuration</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nb>int64</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Since</span><span class=p>(</span><span class=nx>waitStart</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// If we failed to delete it, that means either the DB was closed or</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// something else grabbed it and is about to send on it.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>deleted</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// TODO(bradfitz): rather than this best effort select, we</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// should probably start a goroutine to read from req. This best</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// effort select existed before the change to check &#39;deleted&#39;.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// But if we know for sure it wasn&#39;t deleted and a sender is</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// outstanding, we should probably block on req (in a new</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// goroutine) to get the connection back.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>case</span><span class=w> </span><span class=nx>ret</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>req</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=k>if</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>ret</span><span class=p>.</span><span class=nx>conn</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=nx>db</span><span class=p>.</span><span class=nf>putConn</span><span class=p>(</span><span class=nx>ret</span><span class=p>.</span><span class=nx>conn</span><span class=p>,</span><span class=w> </span><span class=nx>ret</span><span class=p>.</span><span class=nx>err</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Err</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=nx>ret</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>req</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>db</span><span class=p>.</span><span class=nx>waitDuration</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nb>int64</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Since</span><span class=p>(</span><span class=nx>waitStart</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>ok</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>errDBClosed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// Only check if the connection is expired if the strategy is cachedOrNewConns.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// If we require a new connection, just re-use the connection without looking</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// at the expiry time. If it is expired, it will be checked when it is placed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// back into the connection pool.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// This prioritizes giving a valid connection to a client over the exact connection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// lifetime, which could expire exactly after this point anyway.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>strategy</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>cachedOrNewConn</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>ret</span><span class=p>.</span><span class=nx>err</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>ret</span><span class=p>.</span><span class=nx>conn</span><span class=p>.</span><span class=nf>expired</span><span class=p>(</span><span class=nx>lifetime</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>db</span><span class=p>.</span><span class=nx>maxLifetimeClosed</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>ret</span><span class=p>.</span><span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>driver</span><span class=p>.</span><span class=nx>ErrBadConn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>ret</span><span class=p>.</span><span class=nx>conn</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>ret</span><span class=p>.</span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// Reset the session if required.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>ret</span><span class=p>.</span><span class=nx>conn</span><span class=p>.</span><span class=nf>resetSession</span><span class=p>(</span><span class=nx>ctx</span><span class=p>);</span><span class=w> </span><span class=nx>errors</span><span class=p>.</span><span class=nf>Is</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span><span class=w> </span><span class=nx>driver</span><span class=p>.</span><span class=nx>ErrBadConn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>ret</span><span class=p>.</span><span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w> </span><span class=nx>ret</span><span class=p>.</span><span class=nx>conn</span><span class=p>,</span><span class=w> </span><span class=nx>ret</span><span class=p>.</span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>db</span><span class=p>.</span><span class=nx>numOpen</span><span class=o>++</span><span class=w> </span><span class=c1>// optimistically</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>ci</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nx>connector</span><span class=p>.</span><span class=nf>Connect</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nx>numOpen</span><span class=o>--</span><span class=w> </span><span class=c1>// correct for earlier optimism</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nf>maybeOpenNewConnections</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>dc</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>driverConn</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>db</span><span class=p>:</span><span class=w>         </span><span class=nx>db</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>createdAt</span><span class=p>:</span><span class=w>  </span><span class=nf>nowFunc</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>returnedAt</span><span class=p>:</span><span class=w> </span><span class=nf>nowFunc</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>ci</span><span class=p>:</span><span class=w>         </span><span class=nx>ci</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>inUse</span><span class=p>:</span><span class=w>      </span><span class=kc>true</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>db</span><span class=p>.</span><span class=nf>addDepLocked</span><span class=p>(</span><span class=nx>dc</span><span class=p>,</span><span class=w> </span><span class=nx>dc</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>db</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>dc</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>å¤§ä½“æµç¨‹ï¼š</p><p>1ã€è‹¥é‡‡ç”¨ä»è¿æ¥æ± ä¸­å¤ç”¨è¿æ¥çš„ç­–ç•¥å¹¶ä¸”è¿æ¥æœ‰ç©ºé—²è¿æ¥ï¼Œåˆ™ä¼˜å…ˆè·å–è¿æ¥ï¼Œè·å–æˆåŠŸåˆ™ç›´æ¥è¿”å›</p><p>2ã€å¦‚æœæ²¡æœ‰ç©ºé—²è¿æ¥ï¼Œæˆ–è€…ç­–ç•¥è¦æ±‚æ–°è¿æ¥ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦è¶…è¿‡æœ€å¤§æ‰“å¼€è¿æ¥æ•°</p><p>3ã€è¶…è¿‡äº†ï¼Œä¼šå°†å½“å‰åç¨‹æŒ‚èµ·ï¼Œå»ºç«‹å¯¹åº”çš„ channel æ·»åŠ åˆ° connRequests ä¸­ï¼Œç­‰å¾…æœ‰è¿æ¥é‡Šæ”¾æ—¶è¢«å”¤é†’</p><p>4ã€æœªè¶…è¿‡åˆ™è°ƒç”¨å…¶å®ç°ç±»çš„ connector åˆ›å»ºæ–°è¿æ¥</p><p><a class=lightgallery href=../images/%e8%8e%b7%e5%8f%96%e8%bf%9e%e6%8e%a5.png title=database_sqlæ¥å£å…³ç³» data-thumbnail=../images/è·å–è¿æ¥.png><img class=lazyload src=/svg/loading.min.svg data-src=../images/%e8%8e%b7%e5%8f%96%e8%bf%9e%e6%8e%a5.png data-srcset="../images/%e8%8e%b7%e5%8f%96%e8%bf%9e%e6%8e%a5.png, ../images/%e8%8e%b7%e5%8f%96%e8%bf%9e%e6%8e%a5.png 1.5x, ../images/%e8%8e%b7%e5%8f%96%e8%bf%9e%e6%8e%a5.png 2x" data-sizes=auto alt=../images/è·å–è¿æ¥.png></a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>æ›´æ–°äº 2026-02-06</span></div><div id=page-views class=post-info-mod></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/database_sql/index.md target=_blank>é˜…è¯»åŸå§‹æ–‡æ¡£</a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/gorm/>GORM</a>,&nbsp;<a href=/tags/go/>Go</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>è¿”å›</a></span>&nbsp;|&nbsp;<span><a href=/>ä¸»é¡µ</a></span></section></div><div class=post-nav><a href=/func/ class=prev rel=prev title=Funcå‡½æ•°åº•å±‚å®ç°><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Funcå‡½æ•°åº•å±‚å®ç°</a>
<a href=/context/ class=next rel=next title=Context>Context<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app>Giscus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2026</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>zg</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=å›åˆ°é¡¶éƒ¨><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i></a></div><div id=fixed-buttons-hidden><a href=# id=view-comments class=fixed-button title=æŸ¥çœ‹è¯„è®º><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script src=/lib/autocomplete/autocomplete.min.js></script><script src=/lib/lunr/lunr.min.js></script><script src=/lib/lunr/lunr.stemmer.support.min.js></script><script src=/lib/lunr/lunr.zh.min.js></script><script src=/lib/lazysizes/lazysizes.min.js></script><script src=/lib/lightgallery/lightgallery.min.js></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js></script><script src=/lib/clipboard/clipboard.min.js></script><script src=/lib/typeit/index.umd.js></script><script src=/lib/katex/katex.min.js></script><script src=/lib/katex/contrib/auto-render.min.js></script><script src=/lib/katex/contrib/copy-tex.min.js></script><script src=/lib/katex/contrib/mhchem.min.js></script><script src=/lib/cookieconsent/cookieconsent.min.js></script><script>window.config={comment:{giscus:{category:"Announcements",categoryId:"DIC_kwDORJxhrc4C19KM",darkTheme:"dark",emitMetadata:"0",inputPosition:"bottom",lang:"zh-CN",lazyLoading:!1,lightTheme:"light",mapping:"pathname",reactionsEnabled:"1",repo:"guangzou/guangzou.github.io",repoId:"R_kgDORJxhrQ"}},cookieconsent:{content:{dismiss:"åŒæ„",link:"äº†è§£æ›´å¤š",message:"æœ¬ç½‘ç«™ä½¿ç”¨ Cookies æ¥æ”¹å–„æ‚¨çš„æµè§ˆä½“éªŒ."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},data:{"id-1":"zg's blog","id-2":"zg's blog"},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"æ²¡æœ‰æ‰¾åˆ°ç»“æœ",snippetLength:30,type:"lunr"},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"id-1":["id-1"],"id-2":["id-2"]},duration:-1,speed:100}}</script><script src=/js/theme.min.js></script></body></html>