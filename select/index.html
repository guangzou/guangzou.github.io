<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>select - zg blog</title><meta name=Description content="Stay hungry, stay foolish! ğŸš€"><meta property="og:url" content="https://guangzou.github.io/select/"><meta property="og:site_name" content="zg blog"><meta property="og:title" content="select"><meta property="og:description" content="ä»æºç è§’åº¦çœ‹ select çš„åº•å±‚å®ç°"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-02-03T16:44:51+08:00"><meta property="article:modified_time" content="2026-02-04T17:59:12+08:00"><meta property="article:tag" content="Go"><meta property="og:image" content="https://guangzou.github.io/logo.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://guangzou.github.io/logo.png"><meta name=twitter:title content="select"><meta name=twitter:description content="ä»æºç è§’åº¦çœ‹ select çš„åº•å±‚å®ç°"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=referrer content="no-referrer"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://guangzou.github.io/select/><link rel=next href=https://guangzou.github.io/panic/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/css/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"select","inLanguage":"zh-cn","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/guangzou.github.io\/select\/"},"genre":"posts","keywords":"Go","wordcount":8857,"url":"https:\/\/guangzou.github.io\/select\/","datePublished":"2026-02-03T16:44:51+08:00","dateModified":"2026-02-04T17:59:12+08:00","license":"xxx","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"zg"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script>const query=window.matchMedia("(prefers-color-scheme: dark)");function applyTheme(){let e=window.localStorage?.getItem("theme")||"auto",t=e==="dark"||e==="auto"&&query.matches;document.body.setAttribute("theme",t?"dark":"light"),document.body.setAttribute("cfg-theme",e)}applyTheme(),query.addEventListener("change",applyTheme)</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="zg blog"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span><span id=id-1 class=typeit></span><span class=header-title-post><i class='fas fa-book fa-fw'></i></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>æ–‡ç«  </a><a class=menu-item href=/tags/>æ ‡ç­¾ </a><a class=menu-item href=/categories/>åˆ†ç±» </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=æœç´¢><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=æ¸…ç©º><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="zg blog"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span><span id=id-2 class=typeit></span><span class=header-title-post><i class='fas fa-book fa-fw'></i></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=æœç´¢><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=æ¸…ç©º><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>å–æ¶ˆ</a></div><a class=menu-item href=/posts/ title>æ–‡ç« </a><a class=menu-item href=/tags/ title>æ ‡ç­¾</a><a class=menu-item href=/categories/ title>åˆ†ç±»</a><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>ç›®å½•</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">select</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>zg</a></span>&nbsp;<span class=post-category>æ”¶å½•äº <a href=/categories/go%E8%AF%AD%E8%A8%80/><i class="far fa-folder fa-fw" aria-hidden=true></i>Goè¯­è¨€</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2026-02-03>2026-02-03</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;çº¦ 8857 å­—&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;é¢„è®¡é˜…è¯» 18 åˆ†é’Ÿ&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/images/select%e5%ba%95%e5%b1%82%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90_banner.png data-srcset="/images/select%e5%ba%95%e5%b1%82%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90_banner.png, /images/select%e5%ba%95%e5%b1%82%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90_banner.png 1.5x, /images/select%e5%ba%95%e5%b1%82%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90_banner.png 2x" data-sizes=auto alt=/images/selectåº•å±‚æºç è§£æ_banner.png title=/images/selectåº•å±‚æºç è§£æ_banner.png></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>ç›®å½•</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#select>select</a><ul><li><a href=#1-ç¼–è¯‘æœŸé—´çš„-select>1. ç¼–è¯‘æœŸé—´çš„ select</a><ul><li><a href=#11-case1select-æ²¡æœ‰-case-åˆ†æ”¯>1.1. case1ï¼šselect æ²¡æœ‰ case åˆ†æ”¯</a></li><li><a href=#12-case2select-åªæœ‰ä¸€ä¸ªé-default-case>1.2. case2ï¼šselect åªæœ‰ä¸€ä¸ªé default case</a></li><li><a href=#13-case3select-æœ‰ä¸€ä¸ª-case-å’Œä¸€ä¸ª-default>1.3. case3ï¼šselect æœ‰ä¸€ä¸ª case å’Œä¸€ä¸ª default</a></li><li><a href=#14-case4select-æœ‰å¤šä¸ªå¯è¯»å†™çš„-case>1.4. case4ï¼šselect æœ‰å¤šä¸ªå¯è¯»å†™çš„ case</a></li></ul></li><li><a href=#2-è¿è¡Œæ—¶çš„-select>2. è¿è¡Œæ—¶çš„ select</a><ul><li><a href=#21-runtimeselectgo-å®ç°>2.1. runtime.selectgo å®ç°</a><ul><li><a href=#211-åˆå§‹åŒ–>2.1.1. åˆå§‹åŒ–</a></li><li><a href=#212-ç¬¬ä¸€é˜¶æ®µå¤„ç†>2.1.2. ç¬¬ä¸€é˜¶æ®µå¤„ç†</a></li><li><a href=#213-ç¬¬äºŒé˜¶æ®µå¤„ç†>2.1.3. ç¬¬äºŒé˜¶æ®µå¤„ç†</a></li><li><a href=#214-ç¬¬ä¸‰é˜¶æ®µå¤„ç†>2.1.4. ç¬¬ä¸‰é˜¶æ®µå¤„ç†</a></li><li><a href=#215-goto-æ ‡ç­¾>2.1.5. goto æ ‡ç­¾</a></li><li><a href=#216-å…¶ä»–>2.1.6. å…¶ä»–</a></li></ul></li></ul></li></ul></li></ul></nav></div></div><div class=content id=content><p>ä»æºç è§’åº¦çœ‹ select çš„åº•å±‚å®ç°</p><h1 id=select>select</h1><p>å‰è¨€ï¼š</p><p>ä¸€ä¸ª go ä»£ç ï¼Œä¼šç»è¿‡ç¼–è¯‘å™¨ç¼–è¯‘æˆä¸€ä¸ªå¯æ‰§è¡ŒäºŒè¿›åˆ¶ç¨‹åºï¼Œè¿è¡Œåœ¨ä¸åŒçš„ cpu æ¶æ„ä¸Šã€‚</p><p>ç¼–è¯‘å™¨ç¼–è¯‘ go ä»£ç çš„è¿‡ç¨‹åŒ…å«ä»¥ä¸‹è¿‡ç¨‹ï¼Œå…¶ä¸­å‰ä¸‰æ­¥åˆå«ç¼–è¯‘å‰ç«¯ï¼Œåä¸¤æ­¥å«ç¼–è¯‘åç«¯</p><p>è¯æ³•åˆ†æå™¨ &ndash;> è¯­æ³•åˆ†æå™¨ &ndash;> ç±»å‹æ£€æŸ¥ &ndash;> ä¸­é—´ä»£ç ç”Ÿæˆ &ndash;> æœºå™¨ç ç”Ÿæˆ</p><p>1ã€è¯æ³•åˆ†æå™¨é€šè¿‡å¯¹æ¯ä¸€è¡Œ go ä»£ç ï¼ŒæŒ‰ç…§æŸä¸ªç”Ÿäº§è§„åˆ™è¿›è¡Œåˆ†å‰²ï¼Œç»„è£…æˆä¸€ä¸ª Tokenï¼Œè¾“å…¥ç»™è¯­æ³•åˆ†æå™¨ã€‚ä¾‹å¦‚ï¼š<code>package</code>, <code>json</code>, <code>import</code>, <code>(</code>, <code>io</code>, <code>)</code>, â€¦ï¼Œè€Œè¯­æ³•åˆ†æä¼šæŠŠ Token åºåˆ—è½¬æ¢æˆæœ‰æ„ä¹‰çš„ç»“æ„ä½“ï¼Œå³è¯­æ³•æ ‘</p><p>2ã€ç±»å‹æ£€æŸ¥ä¼šæ£€æŸ¥å¸¸é‡ã€ç±»å‹ã€å‡½æ•°å£°æ˜ä»¥åŠå˜é‡èµ‹å€¼è¯­å¥çš„ç±»å‹ï¼Œ<code>src/cmd/compile/internal/typecheck</code>æ–‡ä»¶å¤¹ä¸‹èƒ½çœ‹åˆ°å…·ä½“çš„æ£€æŸ¥åŠ¨ä½œ</p><p>3ã€ç±»å‹æ£€æŸ¥åŒæ—¶è¿˜ä¼šå¯¹ go çš„å…³é”®å­—è¿›è¡Œæ›¿æ¢æ”¹å†™ï¼Œæ¯”å¦‚ Go è¯­è¨€ä¸­å¾ˆå¸¸è§çš„å†…ç½®å‡½æ•° <code>make</code>ï¼Œåœ¨ç±»å‹æ£€æŸ¥é˜¶æ®µä¹‹å‰ï¼Œæ— è®ºæ˜¯åˆ›å»ºåˆ‡ç‰‡ã€å“ˆå¸Œè¿˜æ˜¯ Channel ç”¨çš„éƒ½æ˜¯ <code>make</code> å…³é”®å­—ï¼Œä¸è¿‡åœ¨ç±»å‹æ£€æŸ¥é˜¶æ®µä¼šæ ¹æ®åˆ›å»ºçš„ç±»å‹å°† <code>make</code> æ›¿æ¢æˆç‰¹å®šçš„å‡½æ•°ï¼Œåé¢ç”Ÿæˆä¸­é—´ä»£ç çš„è¿‡ç¨‹å°±ä¸å†ä¼šå¤„ç† <code>OMAKE</code> ç±»å‹çš„èŠ‚ç‚¹äº†ï¼Œè€Œæ˜¯ä¼šä¾æ®ç”Ÿæˆçš„ç»†åˆ†ç±»å‹å¤„ç†ï¼›ç¼–è¯‘å™¨ä¼šå…ˆæ£€æŸ¥å…³é”®å­— <code>make</code> çš„ç¬¬ä¸€ä¸ªç±»å‹å‚æ•°ï¼Œæ ¹æ®ç±»å‹çš„ä¸åŒè¿›å…¥ä¸åŒåˆ†æ”¯ï¼Œåˆ‡ç‰‡åˆ†æ”¯ <code>TSLICE</code>ã€å“ˆå¸Œåˆ†æ”¯ <code>TMAP</code> å’Œ Channel åˆ†æ”¯ <code>TCHAN</code></p><p>4ã€åœ¨ç”Ÿæˆä¸­é—´ä»£ç ä¹‹å‰ï¼Œç¼–è¯‘å™¨è¿˜éœ€è¦æ›¿æ¢æŠ½è±¡è¯­æ³•æ ‘ä¸­èŠ‚ç‚¹çš„ä¸€äº›å…ƒç´ ï¼Œè¿™ä¸ªæ›¿æ¢çš„è¿‡ç¨‹æ˜¯é€šè¿‡ cmd/compile/internal/walk/expr.go å’Œcmd/compile/internal/walk/stmt.go å’Œç›¸å…³å‡½æ•°å®ç°çš„ï¼Œè¿™é‡Œç®€å•å±•ç¤ºå‡ ä¸ªå‡½æ•°çš„ç­¾åï¼š</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>walk</span><span class=p>(</span><span class=nx>fn</span><span class=w> </span><span class=o>*</span><span class=nx>Node</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>walkappend</span><span class=p>(</span><span class=nx>n</span><span class=w> </span><span class=o>*</span><span class=nx>Node</span><span class=p>,</span><span class=w> </span><span class=nx>init</span><span class=w> </span><span class=o>*</span><span class=nx>Nodes</span><span class=p>,</span><span class=w> </span><span class=nx>dst</span><span class=w> </span><span class=o>*</span><span class=nx>Node</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>Node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>walkrange</span><span class=p>(</span><span class=nx>n</span><span class=w> </span><span class=o>*</span><span class=nx>Node</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>Node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>walkselect</span><span class=p>(</span><span class=nx>sel</span><span class=w> </span><span class=o>*</span><span class=nx>Node</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>walkselectcases</span><span class=p>(</span><span class=nx>cases</span><span class=w> </span><span class=o>*</span><span class=nx>Nodes</span><span class=p>)</span><span class=w> </span><span class=p>[]</span><span class=o>*</span><span class=nx>Node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>walkstmt</span><span class=p>(</span><span class=nx>n</span><span class=w> </span><span class=o>*</span><span class=nx>Node</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>Node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>walkstmtlist</span><span class=p>(</span><span class=nx>s</span><span class=w> </span><span class=p>[]</span><span class=o>*</span><span class=nx>Node</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>walkswitch</span><span class=p>(</span><span class=nx>sw</span><span class=w> </span><span class=o>*</span><span class=nx>Node</span><span class=p>)</span></span></span></code></pre></div></div><p>è¿™äº›ç”¨äºéå†æŠ½è±¡è¯­æ³•æ ‘çš„å‡½æ•°ä¼šå°†ä¸€äº›å…³é”®å­—å’Œå†…å»ºå‡½æ•°è½¬æ¢æˆå‡½æ•°è°ƒç”¨ï¼Œä¾‹å¦‚ï¼š ä¸Šè¿°å‡½æ•°ä¼šå°† <code>panic</code>ã€<code>recover</code> ä¸¤ä¸ªå†…å»ºå‡½æ•°è½¬æ¢æˆ runtime.gopanic å’Œ runtime.gorecover ä¸¤ä¸ªçœŸæ­£è¿è¡Œæ—¶å‡½æ•°ï¼Œè€Œå…³é”®å­— <code>new</code> ä¹Ÿä¼šè¢«è½¬æ¢æˆè°ƒç”¨ runtime.newobject å‡½æ•°ã€‚</p><p>5ã€ç”Ÿæˆæœºå™¨ç </p><p>è¿™é‡Œä¸»è¦äº†è§£å¤§ä½“æµç¨‹ï¼Œä¸»è¦éœ€è¦å…³æ³¨çš„æ˜¯ç±»å‹æ£€æŸ¥å’Œä¸­é—´ç ç”Ÿæˆï¼Œåœ¨è¿™é‡Œèƒ½å¤Ÿææ¸… go ä»£ç çš„å…¥å£æ˜¯åœ¨å“ªé‡Œï¼Œä¸€ä¸ªå†…å»ºå‡½æ•°æ˜¯æ€ä¹ˆç”±ç¼–è¯‘å™¨è·Ÿè¿è¡Œæ—¶å…±åŒä½œç”¨ä¸‹å®ç°çš„</p><h2 id=1-ç¼–è¯‘æœŸé—´çš„-select>1. ç¼–è¯‘æœŸé—´çš„ select</h2><p>select è¯­å¥åœ¨ç¼–è¯‘æœŸé—´ä¼šè¢«è½¬æ¢æˆ ir.OSELECT ç±»å‹çš„èŠ‚ç‚¹ï¼Œè§ src/cmd/compile/internal/walk/stmt.go çš„ walkStmt() å‡½æ•°ï¼š</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>walkStmt</span><span class=p>(</span><span class=nx>n</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=p>)</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>OSELECT</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>n</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>n</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>SelectStmt</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>walkSelect</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>n</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>OSWITCH</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>n</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>n</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>SwitchStmt</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>walkSwitch</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>n</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>ORANGE</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>n</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>n</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>RangeStmt</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nf>walkRange</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>äº¤ç”±ï¼Œ<code>go/src/cmd/compile/internal/walk/select.go</code> å®ç°ï¼š</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>walkSelect</span><span class=p>(</span><span class=nx>sel</span><span class=w> </span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>SelectStmt</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>lno</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>SetPos</span><span class=p>(</span><span class=nx>sel</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>sel</span><span class=p>.</span><span class=nf>Walked</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>base</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;double walkSelect&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>sel</span><span class=p>.</span><span class=nf>SetWalked</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>init</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>TakeInit</span><span class=p>(</span><span class=nx>sel</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>init</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>init</span><span class=p>,</span><span class=w> </span><span class=nf>walkSelectCases</span><span class=p>(</span><span class=nx>sel</span><span class=p>.</span><span class=nx>Cases</span><span class=p>)</span><span class=o>...</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>sel</span><span class=p>.</span><span class=nx>Cases</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>sel</span><span class=p>.</span><span class=nx>Compiled</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>init</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>walkStmtList</span><span class=p>(</span><span class=nx>sel</span><span class=p>.</span><span class=nx>Compiled</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>lno</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>åœ¨ <code>walkSelect</code> ä¸­ä¸»è¦é€»è¾‘åœ¨ <code>walkSelectCases</code> ä¸­ï¼Œåœ¨ <code>walkSelectCases</code>ä¸­æ ¹æ®å¯¹ä¸åŒcaseåˆ†æ”¯æ¡ä»¶çš„å¤„ç†ï¼Œä¸åŒçš„æƒ…å†µä¼šè°ƒç”¨ä¸åŒçš„è¿è¡Œæ—¶å‡½æ•°ï¼Œå¤§è‡´åˆ†ä¸ºå¦‚ä¸‹å››ç±»ï¼š</p><p><a class=lightgallery href=../images/select.png title=img data-thumbnail=../images/select.png><img class=lazyload src=/svg/loading.min.svg data-src=../images/select.png data-srcset="../images/select.png, ../images/select.png 1.5x, ../images/select.png 2x" data-sizes=auto alt=../images/select.png></a></p><p>æ ¹æ®<code>walkSelectCases</code>å‡½æ•°çš„å…·ä½“ä»£ç æ¥çœ‹ï¼š</p><h3 id=11-case1select-æ²¡æœ‰-case-åˆ†æ”¯>1.1. case1ï¼šselect æ²¡æœ‰ case åˆ†æ”¯</h3><p>è¡¨ç°å½¢å¼å°±æ˜¯ï¼š</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>select</span><span class=p>{}</span></span></span></code></pre></div></div><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>walkSelectCases</span><span class=p>(</span><span class=nx>cases</span><span class=w> </span><span class=p>[]</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>CommClause</span><span class=p>)</span><span class=w> </span><span class=p>[]</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>ncas</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>cases</span><span class=p>)</span><span class=w>	</span><span class=c1>// caseåˆ†æ”¯çš„æ•°ç›®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>sellineno</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// optimization: zero-case select</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>ncas</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>[]</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=p>{</span><span class=nf>mkcallstmt</span><span class=p>(</span><span class=s>&#34;block&#34;</span><span class=p>)}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>è°ƒç”¨ runtime.block()ï¼Œä½äº<code>go/src/runtime/select.go</code></p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>block</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>gopark</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>waitReasonSelectNoCases</span><span class=p>,</span><span class=w> </span><span class=nx>traceBlockForever</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=c1>// forever</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>ä¼šç›´æ¥æŠ¥æ­»é”ï¼Œä¸ä¼šå¾—åˆ°æ‰§è¡Œ</p><h3 id=12-case2select-åªæœ‰ä¸€ä¸ªé-default-case>1.2. case2ï¼šselect åªæœ‰ä¸€ä¸ªé default case</h3><p>select åªæœ‰é default çš„åˆ†æ”¯æ—¶ï¼Œå®é™…ä¼šè¢«ç¼–è¯‘å™¨è½¬æ¢ä¸ºå¯¹ channel çš„è¯»å†™æ“ä½œï¼Œå®é™…è°ƒç”¨ <code>data := &lt;- ch</code> æˆ– <code>ch &lt;- data</code> å¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>ch</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>case</span><span class=w> </span><span class=nx>data</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=nx>ch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;ch data: %v\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>data</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>ä¼šè¢«ç¼–è¯‘å™¨è½¬æ¢ä¸º</span><span class=err>ï¼š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>data</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=nx>ch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;ch data: %v\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>data</span><span class=p>)</span></span></span></code></pre></div></div><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>walkSelectCases</span><span class=p>(</span><span class=nx>cases</span><span class=w> </span><span class=p>[]</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>CommClause</span><span class=p>)</span><span class=w> </span><span class=p>[]</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// optimization: one-case select: single op.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>ncas</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>cas</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>cases</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w>	</span><span class=c1>// åªæœ‰ä¸€ä¸ªcase</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>ir</span><span class=p>.</span><span class=nf>SetPos</span><span class=p>(</span><span class=nx>cas</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>l</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nf>Init</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>Comm</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// not default:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>n</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>Comm</span><span class=w>	</span><span class=c1>// è·å–caseçš„æ¡ä»¶è¯­å¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>l</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>l</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>TakeInit</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span><span class=o>...</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>switch</span><span class=w> </span><span class=nx>n</span><span class=p>.</span><span class=nf>Op</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>base</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;select %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>n</span><span class=p>.</span><span class=nf>Op</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>case</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>OSEND</span><span class=p>:</span><span class=w>	</span><span class=c1>// å¦‚æœæ˜¯å¾€chané‡Œå†™ï¼Œå³ ch &lt;- dataï¼Œä¸éœ€è¦ç¼–è¯‘å™¨åšè½¬æ¢ï¼Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// already ok</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>case</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>OSELRECV2</span><span class=p>:</span><span class=w>	</span><span class=c1>// ä»chanä¸­æ¥æ”¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>r</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>n</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>AssignListStmt</span><span class=p>)</span><span class=w>							</span><span class=c1>// æ¥æ”¶æ“ä½œå®Œæ•´å½¢å¼ï¼šd,ok := &lt;- ch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>IsBlank</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Lhs</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>IsBlank</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Lhs</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span><span class=w> </span><span class=p>{</span><span class=w>	</span><span class=c1>// å¦‚æœä¸å…³å¿ƒè¿”å›å€¼ï¼Œç›´æ¥è½¬æˆ &lt;- ch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nx>n</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nx>Rhs</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>r</span><span class=p>.</span><span class=nf>SetOp</span><span class=p>(</span><span class=nx>ir</span><span class=p>.</span><span class=nx>OAS2RECV</span><span class=p>)</span><span class=w>	</span><span class=c1>// å¦åˆ™ï¼Œæ˜¯ data, ok := &lt;- chan è¿™ç§å½¢å¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>l</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>l</span><span class=p>,</span><span class=w> </span><span class=nx>n</span><span class=p>)</span><span class=w>	</span><span class=c1>// æŠŠç¼–è¯‘å™¨å¤„ç†åçš„caseè¯­å¥æ¡ä»¶åŠ å…¥å¾…æ‰§è¡Œè¯­å¥åˆ—è¡¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>l</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>l</span><span class=p>,</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>Body</span><span class=o>...</span><span class=p>)</span><span class=w> </span><span class=c1>// æŠŠcaseæ¡ä»¶åè¦æ‰§è¡Œçš„è¯­å¥ä½“åŠ å…¥å¾…æ‰§è¡Œè¯­å¥åˆ—è¡¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>l</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>l</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewBranchStmt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>OBREAK</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>))</span><span class=w> </span><span class=c1>// é»˜è®¤åŠ å…¥breakç±»å‹è¯­å¥ï¼Œè·³å‡ºselect-caseè¯­å¥ä½“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>l</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>è¿™æ˜¯ä¸€ç§ç¼–è¯‘å™¨åœ¨è¯­æ³•æ ‘çº§åˆ«å¯¹ select è¯­å¥çš„é™æ€ä¼˜åŒ–ï¼Œå¯ä»¥æœ‰æ•ˆç®€åŒ–è¿è¡Œæ—¶çš„å¼€é”€ã€‚</p><h3 id=13-case3select-æœ‰ä¸€ä¸ª-case-å’Œä¸€ä¸ª-default>1.3. case3ï¼šselect æœ‰ä¸€ä¸ª case å’Œä¸€ä¸ª default</h3><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>ch</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=nx>ch</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=mi>1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;run case 1&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;run default&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>ä¼šè¢«ç¼–è¯‘å™¨æ›¿æ¢ä¸º</span><span class=err>ï¼š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=nf>selectnbsend</span><span class=p>(</span><span class=nx>ch</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;run case 1&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;run default&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>çœ‹ walkSelectCases çš„åç»­åˆ†æ”¯ï¼š</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>walkSelectCases</span><span class=p>(</span><span class=nx>cases</span><span class=w> </span><span class=p>[]</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>CommClause</span><span class=p>)</span><span class=w> </span><span class=p>[]</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// optimization: two-case select but one is default: single non-blocking op.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>ncas</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>dflt</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>cas</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>cases</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>cas</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>dflt</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>cas</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>cases</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>n</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>Comm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>ir</span><span class=p>.</span><span class=nf>SetPos</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>r</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewIfStmt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span><span class=w> </span><span class=c1>// åˆ›å»ºä¸€ä¸ªæ–°çš„ if è¯­å¥ rï¼Œç”¨äºè¡¨ç¤ºä¼˜åŒ–åçš„ä»£ç ç»“æ„ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>r</span><span class=p>.</span><span class=nf>SetInit</span><span class=p>(</span><span class=nx>cas</span><span class=p>.</span><span class=nf>Init</span><span class=p>())</span><span class=w>  </span><span class=c1>// å°†è¯¥ case çš„åˆå§‹åŒ–è¯­å¥è®¾ç½®ä¸º if è¯­å¥çš„åˆå§‹åŒ–éƒ¨åˆ†ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>var</span><span class=w> </span><span class=nx>cond</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>switch</span><span class=w> </span><span class=nx>n</span><span class=p>.</span><span class=nf>Op</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>base</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;select %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>n</span><span class=p>.</span><span class=nf>Op</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>OSEND</span><span class=p>:</span><span class=w>	</span><span class=c1>// å¾€chané‡Œå‘é€æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// if selectnbsend(c, v) { body } else { default body }</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>n</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>n</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>SendStmt</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>ch</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>n</span><span class=p>.</span><span class=nx>Chan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>cond</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>mkcall1</span><span class=p>(</span><span class=nf>chanfn</span><span class=p>(</span><span class=s>&#34;selectnbsend&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=nx>ch</span><span class=p>.</span><span class=nf>Type</span><span class=p>()),</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nx>Types</span><span class=p>[</span><span class=nx>types</span><span class=p>.</span><span class=nx>TBOOL</span><span class=p>],</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nf>PtrInit</span><span class=p>(),</span><span class=w> </span><span class=nx>ch</span><span class=p>,</span><span class=w> </span><span class=nx>n</span><span class=p>.</span><span class=nx>Value</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>OSELRECV2</span><span class=p>:</span><span class=w> </span><span class=c1>// ä»chané‡Œæ¥æ”¶æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>n</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>n</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>AssignListStmt</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>recv</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>n</span><span class=p>.</span><span class=nx>Rhs</span><span class=p>[</span><span class=mi>0</span><span class=p>].(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>UnaryExpr</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>ch</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>recv</span><span class=p>.</span><span class=nx>X</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>elem</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>n</span><span class=p>.</span><span class=nx>Lhs</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>IsBlank</span><span class=p>(</span><span class=nx>elem</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>elem</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>NodNil</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>cond</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>TempAt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>CurFunc</span><span class=p>,</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nx>Types</span><span class=p>[</span><span class=nx>types</span><span class=p>.</span><span class=nx>TBOOL</span><span class=p>])</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>fn</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>chanfn</span><span class=p>(</span><span class=s>&#34;selectnbrecv&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=nx>ch</span><span class=p>.</span><span class=nf>Type</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>call</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>mkcall1</span><span class=p>(</span><span class=nx>fn</span><span class=p>,</span><span class=w> </span><span class=nx>fn</span><span class=p>.</span><span class=nf>Type</span><span class=p>().</span><span class=nf>ResultsTuple</span><span class=p>(),</span><span class=w> </span><span class=nx>r</span><span class=p>.</span><span class=nf>PtrInit</span><span class=p>(),</span><span class=w> </span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=nx>ch</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>as</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewAssignListStmt</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nf>Pos</span><span class=p>(),</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>OAS2</span><span class=p>,</span><span class=w> </span><span class=p>[]</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=p>{</span><span class=nx>cond</span><span class=p>,</span><span class=w> </span><span class=nx>n</span><span class=p>.</span><span class=nx>Lhs</span><span class=p>[</span><span class=mi>1</span><span class=p>]},</span><span class=w> </span><span class=p>[]</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=p>{</span><span class=nx>call</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>r</span><span class=p>.</span><span class=nf>PtrInit</span><span class=p>().</span><span class=nf>Append</span><span class=p>(</span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>Stmt</span><span class=p>(</span><span class=nx>as</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>r</span><span class=p>.</span><span class=nx>Cond</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>Expr</span><span class=p>(</span><span class=nx>cond</span><span class=p>)</span><span class=w> </span><span class=c1>// å°†éé˜»å¡æ“ä½œçš„ç»“æœå¸ƒå°”å€¼ cond ä½œä¸º if è¯­å¥çš„æ¡ä»¶ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>r</span><span class=p>.</span><span class=nx>Body</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>Body</span><span class=w>	</span><span class=c1>// è®¾ç½® if çš„ä¸»ä½“ä¸ºé default åˆ†æ”¯çš„æ‰§è¡Œä½“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å°† default åˆ†æ”¯çš„åˆå§‹åŒ–è¯­å¥å’Œæ‰§è¡Œä½“ä½œä¸º else åˆ†æ”¯ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>r</span><span class=p>.</span><span class=nx>Else</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>dflt</span><span class=p>.</span><span class=nf>Init</span><span class=p>(),</span><span class=w> </span><span class=nx>dflt</span><span class=p>.</span><span class=nx>Body</span><span class=o>...</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ„é€ ä¸€ä¸ªåŒ…å« if è¯­å¥å’Œä¸€ä¸ª break è¯­å¥çš„è¯­æ³•æ ‘èŠ‚ç‚¹åˆ—è¡¨ï¼Œbreak è¯­å¥ç”¨äºè·³å‡º select çš„æ§åˆ¶æµ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>[]</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=p>{</span><span class=nx>r</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewBranchStmt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>OBREAK</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)}</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>ç¼–è¯‘å™¨ä¼šå°†å…¶è½¬ä¸ºè°ƒç”¨è¿è¡Œæ—¶ <code>runtime.selectnbrecv()</code> å‡½æ•°å’Œ<code>runtime.selectnbsend()</code>å‡½æ•°ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°ä¼šåˆ†åˆ«è°ƒç”¨<code>runtime.cahnrecv()</code>å‡½æ•°å’Œ<code>runtime.chansend()</code>å‡½æ•°ï¼Œä¼ å…¥è¿™ä¸¤ä¸ªå‡½æ•°çš„ block å‚æ•°ä¸º falseï¼Œä»£è¡¨éé˜»å¡ï¼Œä¸æˆåŠŸåˆ™ç›´æ¥è¿”å›ã€‚</p><h3 id=14-case4select-æœ‰å¤šä¸ªå¯è¯»å†™çš„-case>1.4. case4ï¼šselect æœ‰å¤šä¸ªå¯è¯»å†™çš„ case</h3><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>ch1</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>ch2</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=nx>ch1</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=mi>1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;run case 1&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=nx>data</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=nx>ch2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;run case 2, data is: %d&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>data</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>walkSelectCases</span><span class=p>(</span><span class=nx>cases</span><span class=w> </span><span class=p>[]</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>CommClause</span><span class=p>)</span><span class=w> </span><span class=p>[]</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>dflt</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>	</span><span class=c1>// è¿‡æ»¤æ‰defaultåˆ†æ”¯ï¼Œcaseæ•°ç›®å‡1ï¼Œä»¥ä¸‹é€»è¾‘åªå¯¹édefaultå¤šcaseåˆ†æ”¯é€‰æ‹©ï¼Œè‹¥å¤šchanåˆ†æ”¯éƒ½æ²¡å‡†å¤‡å¥½ï¼Œèµ°defaultåˆ†æ”¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>ncas</span><span class=o>--</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>casorder</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>([]</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>CommClause</span><span class=p>,</span><span class=w> </span><span class=nx>ncas</span><span class=p>)</span><span class=w> </span><span class=c1>// casorderä¸ºncaså¤§å°çš„caseè¯­å¥çš„æ•°ç»„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>nsends</span><span class=p>,</span><span class=w> </span><span class=nx>nrecvs</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w>	</span><span class=c1>// å¯¹æ¥æ”¶æ“ä½œå’Œå‘é€æ“ä½œåˆ†ç±»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>var</span><span class=w> </span><span class=nx>init</span><span class=w> </span><span class=p>[]</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=w>	</span><span class=c1>// å®šä¹‰initä¸ºå¤šcaseç¼–è¯‘åå¾…æ‰§è¡Œçš„è¯­å¥åˆ—è¡¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// generate sel-struct</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>sellineno</span><span class=w>	</span><span class=c1>// é€šè¿‡scasetype()æ„é€ é•¿åº¦åŒncasçš„scaseç»“æ„ä½“æ•°ç»„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>selv</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>TempAt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>CurFunc</span><span class=p>,</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nf>NewArray</span><span class=p>(</span><span class=nf>scasetype</span><span class=p>(),</span><span class=w> </span><span class=nb>int64</span><span class=p>(</span><span class=nx>ncas</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>init</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>init</span><span class=p>,</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>Stmt</span><span class=p>(</span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewAssignStmt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>selv</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// No initialization for order; runtime.selectgo is responsible for that.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å®šä¹‰orderä¸º2å€çš„ncasé•¿åº¦çš„TUINT16ç±»å‹çš„æ•°ç»„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åç»­è¿™ä¸¤è€…ï¼Œselvå’Œorderä½œä¸ºruntime.selectgo()å‡½æ•°çš„å…¥å‚ï¼Œå‰è€…å­˜æ”¾scaseåˆ—è¡¨å†…å­˜åœ°å€ï¼Œåè€…ç”¨æ¥åšscaseæ’åºä½¿ç”¨ï¼Œæ’åºæ˜¯ä¸ºäº†ä¾¿äºæŒ‘é€‰å‡ºå¾…æ‰§è¡Œçš„case</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>order</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>TempAt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>CurFunc</span><span class=p>,</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nf>NewArray</span><span class=p>(</span><span class=nx>types</span><span class=p>.</span><span class=nx>Types</span><span class=p>[</span><span class=nx>types</span><span class=p>.</span><span class=nx>TUINT16</span><span class=p>],</span><span class=w> </span><span class=mi>2</span><span class=o>*</span><span class=nb>int64</span><span class=p>(</span><span class=nx>ncas</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>var</span><span class=w> </span><span class=nx>pc0</span><span class=p>,</span><span class=w> </span><span class=nx>pcs</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>base</span><span class=p>.</span><span class=nx>Flag</span><span class=p>.</span><span class=nx>Race</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// ç«æ€åˆ†æ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>pcs</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>TempAt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>CurFunc</span><span class=p>,</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nf>NewArray</span><span class=p>(</span><span class=nx>types</span><span class=p>.</span><span class=nx>Types</span><span class=p>[</span><span class=nx>types</span><span class=p>.</span><span class=nx>TUINTPTR</span><span class=p>],</span><span class=w> </span><span class=nb>int64</span><span class=p>(</span><span class=nx>ncas</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>pc0</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>Expr</span><span class=p>(</span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>NodAddr</span><span class=p>(</span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewIndexExpr</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>pcs</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewInt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>))))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>pc0</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>NodNil</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// register cases å¼€å§‹æ³¨å†Œcaseï¼Œéå†ç”Ÿæˆscaseå¯¹è±¡æ”¾åˆ°selvä¸­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>cas</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>cases</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>ir</span><span class=p>.</span><span class=nf>SetPos</span><span class=p>(</span><span class=nx>cas</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>init</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>init</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>TakeInit</span><span class=p>(</span><span class=nx>cas</span><span class=p>)</span><span class=o>...</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>n</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>Comm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>n</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// default:è·³è¿‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>continue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=kd>var</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=kd>var</span><span class=w> </span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>elem</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>switch</span><span class=w> </span><span class=nx>n</span><span class=p>.</span><span class=nf>Op</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>base</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;select %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>n</span><span class=p>.</span><span class=nf>Op</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>OSEND</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>n</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>n</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>SendStmt</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>i</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>nsends</span><span class=w>  </span><span class=c1>// å¯¹å‘é€ç±»å‹çš„chanï¼Œi ä» 0 å¼€å§‹å¾€ ncas è®¡æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>nsends</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>n</span><span class=p>.</span><span class=nx>Chan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>elem</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>n</span><span class=p>.</span><span class=nx>Value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>OSELRECV2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>n</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>n</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>AssignListStmt</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>nrecvs</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>i</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>ncas</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nx>nrecvs</span><span class=w>	</span><span class=c1>// å¯¹æ¥æ”¶ç±»å‹çš„channï¼Œi ä» ncas å¾€å‰è®¡æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>recv</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>n</span><span class=p>.</span><span class=nx>Rhs</span><span class=p>[</span><span class=mi>0</span><span class=p>].(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>UnaryExpr</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>recv</span><span class=p>.</span><span class=nx>X</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>elem</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>n</span><span class=p>.</span><span class=nx>Lhs</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w>		</span><span class=c1>// data,ok := &lt;- ch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>casorder</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>cas</span><span class=w> </span><span class=c1>// ç¼–è¯‘å™¨å¯¹å¤šä¸ªcaseæ’åˆ—åï¼Œå‘é€chançš„caseåœ¨å·¦è¾¹ï¼Œæ¥æ”¶chançš„caseåœ¨å³è¾¹ï¼Œåœ¨selvä¸­ä¹Ÿæ˜¯å¦‚æ­¤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œå†™å…¥chanæˆ–elemåˆ°selvæ•°ç»„, å®é™…æ‰§è¡Œçš„æ˜¯selv[i]=f</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>setField</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=kd>func</span><span class=p>(</span><span class=nx>f</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>val</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>r</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewAssignStmt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewSelectorExpr</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>ODOT</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewIndexExpr</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>selv</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewInt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nb>int64</span><span class=p>(</span><span class=nx>i</span><span class=p>))),</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>Lookup</span><span class=p>(</span><span class=nx>f</span><span class=p>)),</span><span class=w> </span><span class=nx>val</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>init</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>init</span><span class=p>,</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>Stmt</span><span class=p>(</span><span class=nx>r</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å°†cæŒ‡é’ˆè½¬æ¢ä¸º unsafe.Pointer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>ConvNop</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nx>Types</span><span class=p>[</span><span class=nx>types</span><span class=p>.</span><span class=nx>TUNSAFEPTR</span><span class=p>])</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å†™å…¥ c ä»£è¡¨çš„ chan åˆ° selvï¼Œselv[c]=c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>setField</span><span class=p>(</span><span class=s>&#34;c&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>ir</span><span class=p>.</span><span class=nf>IsBlank</span><span class=p>(</span><span class=nx>elem</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>elem</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>ConvNop</span><span class=p>(</span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nx>Types</span><span class=p>[</span><span class=nx>types</span><span class=p>.</span><span class=nx>TUNSAFEPTR</span><span class=p>])</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// å†™å…¥ elem åˆ° selvï¼Œselv[elem]=elem</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nf>setField</span><span class=p>(</span><span class=s>&#34;elem&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>elem</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// TODO(mdempsky): There should be a cleaner way to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// handle this.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>base</span><span class=p>.</span><span class=nx>Flag</span><span class=p>.</span><span class=nx>Race</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>r</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>mkcallstmt</span><span class=p>(</span><span class=s>&#34;selectsetpc&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>NodAddr</span><span class=p>(</span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewIndexExpr</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>pcs</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewInt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nb>int64</span><span class=p>(</span><span class=nx>i</span><span class=p>)))))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>init</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>init</span><span class=p>,</span><span class=w> </span><span class=nx>r</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å‘é€ä¸æ¥æ”¶chanæ•°ç›®ä¸æ€»æ•°ç›®ä¸å¯¹ï¼Œpanic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>nsends</span><span class=o>+</span><span class=nx>nrecvs</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nx>ncas</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>base</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;walkSelectCases: miscount: %v + %v != %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>nsends</span><span class=p>,</span><span class=w> </span><span class=nx>nrecvs</span><span class=p>,</span><span class=w> </span><span class=nx>ncas</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// run the select</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>sellineno</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>chosen</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>TempAt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>CurFunc</span><span class=p>,</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nx>Types</span><span class=p>[</span><span class=nx>types</span><span class=p>.</span><span class=nx>TINT</span><span class=p>])</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>recvOK</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>TempAt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>CurFunc</span><span class=p>,</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nx>Types</span><span class=p>[</span><span class=nx>types</span><span class=p>.</span><span class=nx>TBOOL</span><span class=p>])</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>r</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewAssignListStmt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>OAS2</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>r</span><span class=p>.</span><span class=nx>Lhs</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>[]</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=p>{</span><span class=nx>chosen</span><span class=p>,</span><span class=w> </span><span class=nx>recvOK</span><span class=p>}</span><span class=w> </span><span class=c1>// å·¦è¾¹æœ‰åŒå€¼ï¼Œä¸€ä¸ªchosenï¼Œä¸€ä¸ªrecvOKï¼Œåˆ†åˆ«ä»£è¡¨é€‰æ‹©äº†å“ªä¸ªcaseåˆ†æ”¯ï¼Œæ˜¯å¦æ¥æ”¶æˆåŠŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>fn</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>LookupRuntime</span><span class=p>(</span><span class=s>&#34;selectgo&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// è°ƒç”¨ runtime.selectgo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>var</span><span class=w> </span><span class=nx>fnInit</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>Nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// rå³è¾¹è°ƒç”¨runtime.selectgoå‡½æ•°ï¼Œä¼ é€’ selvï¼Œorderï¼Œnsendï¼Œnrecvsï¼Œblockæ˜¯å¦é˜»å¡ç­‰å‚æ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>r</span><span class=p>.</span><span class=nx>Rhs</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>[]</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=p>{</span><span class=nf>mkcall1</span><span class=p>(</span><span class=nx>fn</span><span class=p>,</span><span class=w> </span><span class=nx>fn</span><span class=p>.</span><span class=nf>Type</span><span class=p>().</span><span class=nf>ResultsTuple</span><span class=p>(),</span><span class=w> </span><span class=o>&amp;</span><span class=nx>fnInit</span><span class=p>,</span><span class=w> </span><span class=nf>bytePtrToIndex</span><span class=p>(</span><span class=nx>selv</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>),</span><span class=w> </span><span class=nf>bytePtrToIndex</span><span class=p>(</span><span class=nx>order</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>),</span><span class=w> </span><span class=nx>pc0</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewInt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nb>int64</span><span class=p>(</span><span class=nx>nsends</span><span class=p>)),</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewInt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nb>int64</span><span class=p>(</span><span class=nx>nrecvs</span><span class=p>)),</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewBool</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>dflt</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=p>))}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>init</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>init</span><span class=p>,</span><span class=w> </span><span class=nx>fnInit</span><span class=o>...</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>init</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>init</span><span class=p>,</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>Stmt</span><span class=p>(</span><span class=nx>r</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// selv, order, and pcs (if race) are no longer alive after selectgo.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// dispatch cases åˆ†å‘caseï¼Œå®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œæ ¹æ®chosenç¡®å®šçš„caseåˆ†æ”¯ç”Ÿæˆifè¯­å¥ï¼Œæ‰§è¡Œè¯¥åˆ†æ”¯çš„è¯­å¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>dispatch</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=kd>func</span><span class=p>(</span><span class=nx>cond</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=p>,</span><span class=w> </span><span class=nx>cas</span><span class=w> </span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>CommClause</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=kd>var</span><span class=w> </span><span class=nx>list</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>Nodes</span><span class=w>	</span><span class=c1>// ä¸€ä¸ª ir.Nodes ç±»å‹çš„åˆ‡ç‰‡ï¼Œç”¨äºå­˜å‚¨è¯¥åˆ†æ”¯éœ€è¦æ‰§è¡Œçš„æ‰€æœ‰è¯­å¥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>n</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>Comm</span><span class=p>;</span><span class=w> </span><span class=nx>n</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>n</span><span class=p>.</span><span class=nf>Op</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>OSELRECV2</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>n</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>n</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>AssignListStmt</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// n.Lhs[1]è¡¨ç¤ºæ¥æ”¶è¯­å¥çš„ç¬¬äºŒä¸ªè¿”å›å€¼ï¼ˆå³ `ok`ï¼‰ï¼›å¦‚æœ ok ä¸æ˜¯ç©ºæ ‡è¯†ç¬¦ï¼ˆ`_`ï¼‰ï¼Œè¡¨ç¤ºæ¥æ”¶ç»“æœçš„çŠ¶æ€éœ€è¦è¢«ä¿å­˜</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>ir</span><span class=p>.</span><span class=nf>IsBlank</span><span class=p>(</span><span class=nx>n</span><span class=p>.</span><span class=nx>Lhs</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>x</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewAssignStmt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>n</span><span class=p>.</span><span class=nx>Lhs</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=w> </span><span class=nx>recvOK</span><span class=p>)</span><span class=cp>//åˆ›å»ºä¸€æ¡èµ‹å€¼è¯­å¥ï¼Œå°†recvOKçš„å€¼èµ‹ç»™n.Lhs[1]ï¼Œå³ok=recvOK</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>list</span><span class=p>.</span><span class=nf>Append</span><span class=p>(</span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>Stmt</span><span class=p>(</span><span class=nx>x</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å°† case çš„æ‰§è¡Œä½“ï¼ˆcas.Bodyï¼‰æ·»åŠ åˆ°listï¼Œå¹¶æ·»åŠ ä¸€ä¸ªbreakè¯­å¥ï¼ˆir.OBREAKï¼‰ï¼Œè·³å‡ºselectæ§åˆ¶å—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>list</span><span class=p>.</span><span class=nf>Append</span><span class=p>(</span><span class=nx>cas</span><span class=p>.</span><span class=nx>Body</span><span class=p>.</span><span class=nf>Take</span><span class=p>()</span><span class=o>...</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>list</span><span class=p>.</span><span class=nf>Append</span><span class=p>(</span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewBranchStmt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>OBREAK</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=kd>var</span><span class=w> </span><span class=nx>r</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>cond</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>cond</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>Expr</span><span class=p>(</span><span class=nx>cond</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>cond</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>DefaultLit</span><span class=p>(</span><span class=nx>cond</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// åˆ›å»ºä¸€ä¸ª if è¯­å¥ï¼Œæ¡ä»¶ä¸ºcondï¼Œæ‰§è¡Œä½“ä¸ºlist</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>r</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewIfStmt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>cond</span><span class=p>,</span><span class=w> </span><span class=nx>list</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// æ²¡æœ‰æ¡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªä»£ç å—èŠ‚ç‚¹ï¼ˆir.NewBlockStmtï¼‰ï¼Œè¡¨ç¤ºæ— æ¡ä»¶çš„ä»£ç å—ï¼Œé€šå¸¸æ˜¯æœ€åä¸€ä¸ªåˆ†æ”¯æˆ–è€…defaultåˆ†æ”¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>r</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewBlockStmt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>list</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å°†ç”Ÿæˆçš„ if æˆ–ä»£ç å—èŠ‚ç‚¹æ·»åŠ åˆ° init åˆ‡ç‰‡ä¸­ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// init æ˜¯æœ€ç»ˆç”Ÿæˆä»£ç çš„æŒ‡ä»¤åºåˆ—ï¼Œç”¨äºè¡¨ç¤ºselectçš„å®Œæ•´æ§åˆ¶æµã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>init</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>append</span><span class=p>(</span><span class=nx>init</span><span class=p>,</span><span class=w> </span><span class=nx>r</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¦‚æœå¤šcaseä¸­æœ‰defaultåˆ†æ”¯ï¼Œå¹¶ä¸”chosenå°äº0ï¼Œæ‰§è¡Œè¯¥defaultåˆ†æ”¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>dflt</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>ir</span><span class=p>.</span><span class=nf>SetPos</span><span class=p>(</span><span class=nx>dflt</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ir.NewBinaryExpräºŒå…ƒè¡¨è¾¾å¼ï¼Œir.OLTè¡¨ç¤º&lt;ï¼Œchosenå·¦æ“ä½œæ•°ï¼Œir.NewInt(base.Pos, 0)å³æ“ä½œæ•°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>dispatch</span><span class=p>(</span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewBinaryExpr</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>OLT</span><span class=p>,</span><span class=w> </span><span class=nx>chosen</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewInt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>)),</span><span class=w> </span><span class=nx>dflt</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¦‚æœæœ‰chosené€‰ä¸­çš„caseåˆ†æ”¯ï¼Œå³chosenç­‰äºiï¼Œåˆ™æ‰§è¡Œè¯¥åˆ†æ”¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=p>,</span><span class=w> </span><span class=nx>cas</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>casorder</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>ir</span><span class=p>.</span><span class=nf>SetPos</span><span class=p>(</span><span class=nx>cas</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>casorder</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nf>dispatch</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>cas</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>break</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ir.NewBinaryExpräºŒå…ƒè¡¨è¾¾å¼ï¼Œir.OEQè¡¨ç¤º==ï¼Œå·¦å³æ“ä½œæ•°chosen, ir.NewInt(base.Pos, int64(i))ï¼Œi==chosenï¼Ÿ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>dispatch</span><span class=p>(</span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewBinaryExpr</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>OEQ</span><span class=p>,</span><span class=w> </span><span class=nx>chosen</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewInt</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nb>int64</span><span class=p>(</span><span class=nx>i</span><span class=p>))),</span><span class=w> </span><span class=nx>cas</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>init</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>1ï¼‰è¿‡æ»¤ default åˆ†æ”¯ï¼Œåˆå§‹åŒ– <code>casoreder</code> æ•°ç»„ã€<code>nsends</code>ã€<code>nrecvs</code>ï¼Œå¯¹æ¥æ”¶ chan å’Œå‘é€ chan åˆ†å¼€è®¡æ•°</p><p>2ï¼‰ç”Ÿæˆ <code>selv</code> ç»“æ„ä½“æ•°ç»„ï¼ˆ<code>scase</code>ï¼‰å’Œ <code>order</code> uint16 ç±»å‹æ•°ç»„ï¼ˆé•¿åº¦ 2*len(ncas)ï¼‰ï¼Œä½œä¸º <code>runtime.selectgo</code> çš„å…¶ä¸­ä¸¤ä¸ªå…¥å‚</p><p>3ï¼‰éå†æ‰€æœ‰ caseï¼ŒåŒºåˆ†å‘é€ chan å’Œæ¥æ”¶ chanï¼Œsend ä» 0 å¼€å§‹è®¡æ•°ï¼Œrecv ä» ncas åˆ° 0 è®¡æ•°ï¼Œä¿å­˜åˆ° <code>casorder</code> ä¸­ï¼Œ[chansend1ï¼Œchansend2 &mldr; chanrecv1,chanrecv2]ï¼Œå¹¶ç»™ selv çš„æˆå‘˜å˜é‡é€šè¿‡ setField å‡½æ•°åŠ¨æ€èµ‹å€¼ï¼Œç»™ case åˆ†æ”¯æ‰§è¡Œåšæ•°æ®å‡†å¤‡</p><p>4ï¼‰ä¼ å…¥å‚æ•°ï¼ˆ<code>selvï¼Œorderï¼Œnsendï¼Œnrecvsï¼Œblockæ˜¯å¦é˜»å¡</code>ï¼‰ï¼Œè°ƒç”¨ <code>runtime.selectgo</code> å‡½æ•°é€‰æ‹©æ‰§è¡Œå“ªä¸ª case åˆ†æ”¯</p><p>5ï¼‰æ ¹æ®<code>runtime.selectgo</code>çš„è¿”å›å€¼ <code>chosen</code> å’Œ <code>recvOK</code>ï¼Œç”Ÿæˆ<code>if</code>è¯­å¥ï¼Œæ‰§è¡Œè¯¥åˆ†æ”¯çš„è¯­å¥ï¼Œç”± <code>dispatch</code>å‡½æ•°å®Œæˆã€‚å¦‚æœ <code>chosen&lt;0&&amp;default!=nil</code>ï¼Œåˆ™æ‰§è¡Œ <code>default</code> åˆ†æ”¯ï¼›å¦‚æœ <code>chosen==casoreder[i]</code> ï¼Œåˆ™æ‰§è¡Œé€‰ä¸­çš„ caseã€‚</p><p>6ï¼‰ç”Ÿæˆ break è¯­å¥ï¼Œè·³å‡º select æ§åˆ¶å—ã€‚</p><p>å‡å¦‚æœ‰ä»¥ä¸‹ä»£ç ï¼š</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>case</span><span class=w> </span><span class=nx>x</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>ch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;received&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>case</span><span class=w> </span><span class=nx>ch</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=nx>y</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;sent&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;default&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>dispatch å‡½æ•°ç”Ÿæˆä»£ç å¤§ä½“ç±»ä¼¼äºï¼š</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=nx>chosen</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// default åˆ†æ”¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;default&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>break</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=nx>chosen</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// case x, ok := &lt;-ch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>ok</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>recvOK</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;received&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>break</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=nx>chosen</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// case ch &lt;- y</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;sent&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>break</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>åœ¨ <code>src/cmd/compile/internal/walk/select.go</code>ä¸­é€šè¿‡ scasetype()åˆå§‹åŒ– scase ç»“æ„ä½“ï¼ŒåŒ…å« chan å’Œ elem ä¸¤ä¸ªå­—æ®µï¼ŒåŒ runtime ä¸­çš„ scase ç»“æ„ä½“ï¼Œå­˜å‚¨ case åˆ†æ”¯çš„å…ƒä¿¡æ¯ã€‚</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Keep in sync with src/runtime/select.go.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>scasetype</span><span class=p>()</span><span class=w> </span><span class=o>*</span><span class=nx>types</span><span class=p>.</span><span class=nx>Type</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>scase</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>n</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nf>NewDeclNameAt</span><span class=p>(</span><span class=nx>src</span><span class=p>.</span><span class=nx>NoXPos</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>OTYPE</span><span class=p>,</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>Pkgs</span><span class=p>.</span><span class=nx>Runtime</span><span class=p>.</span><span class=nf>Lookup</span><span class=p>(</span><span class=s>&#34;scase&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>scase</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nf>NewNamed</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>n</span><span class=p>.</span><span class=nf>SetType</span><span class=p>(</span><span class=nx>scase</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>n</span><span class=p>.</span><span class=nf>SetTypecheck</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>scase</span><span class=p>.</span><span class=nf>SetUnderlying</span><span class=p>(</span><span class=nx>types</span><span class=p>.</span><span class=nf>NewStruct</span><span class=p>([]</span><span class=o>*</span><span class=nx>types</span><span class=p>.</span><span class=nx>Field</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>types</span><span class=p>.</span><span class=nf>NewField</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>Lookup</span><span class=p>(</span><span class=s>&#34;c&#34;</span><span class=p>),</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nx>Types</span><span class=p>[</span><span class=nx>types</span><span class=p>.</span><span class=nx>TUNSAFEPTR</span><span class=p>]),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>types</span><span class=p>.</span><span class=nf>NewField</span><span class=p>(</span><span class=nx>base</span><span class=p>.</span><span class=nx>Pos</span><span class=p>,</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>Lookup</span><span class=p>(</span><span class=s>&#34;elem&#34;</span><span class=p>),</span><span class=w> </span><span class=nx>types</span><span class=p>.</span><span class=nx>Types</span><span class=p>[</span><span class=nx>types</span><span class=p>.</span><span class=nx>TUNSAFEPTR</span><span class=p>]),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>scase</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// Select case descriptor.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// Known to compiler.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// Changes here must also be made in src/cmd/compile/internal/walk/select.go&#39;s scasetype.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>scase</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=w>    </span><span class=o>*</span><span class=nx>hchan</span><span class=w>         </span><span class=c1>// chan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>elem</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span><span class=w> </span><span class=c1>// data element</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h2 id=2-è¿è¡Œæ—¶çš„-select>2. è¿è¡Œæ—¶çš„ select</h2><p><a class=lightgallery href=../images/selectgo.jpeg title=img data-thumbnail=../images/selectgo.jpeg><img class=lazyload src=/svg/loading.min.svg data-src=../images/selectgo.jpeg data-srcset="../images/selectgo.jpeg, ../images/selectgo.jpeg 1.5x, ../images/selectgo.jpeg 2x" data-sizes=auto alt=../images/selectgo.jpeg></a></p><h3 id=21-runtimeselectgo-å®ç°>2.1. runtime.selectgo å®ç°</h3><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// selectgo implements the select statement.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// cas0 points to an array of type [ncases]scase, and order0 points to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// an array of type [2*ncases]uint16 where ncases must be &lt;= 65536.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// Both reside on the goroutine&#39;s stack (regardless of any escaping in</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// selectgo).</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// For race detector builds, pc0 points to an array of type</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// [ncases]uintptr (also on the stack); for other builds, it&#39;s set to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// nil.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// selectgo returns the index of the chosen scase, which matches the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// ordinal position of its respective select{recv,send,default} call.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// Also, if the chosen scase was a receive operation, it reports whether</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// a value was received.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>selectgo</span><span class=p>(</span><span class=nx>cas0</span><span class=w> </span><span class=o>*</span><span class=nx>scase</span><span class=p>,</span><span class=w> </span><span class=nx>order0</span><span class=w> </span><span class=o>*</span><span class=kt>uint16</span><span class=p>,</span><span class=w> </span><span class=nx>pc0</span><span class=w> </span><span class=o>*</span><span class=kt>uintptr</span><span class=p>,</span><span class=w> </span><span class=nx>nsends</span><span class=p>,</span><span class=w> </span><span class=nx>nrecvs</span><span class=w> </span><span class=kt>int</span><span class=p>,</span><span class=w> </span><span class=nx>block</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>,</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// NOTE: In order to maintain a lean stack size, the number of scases</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// is capped at 65536.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>cas1</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=p>[</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>16</span><span class=p>]</span><span class=nx>scase</span><span class=p>)(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=nx>cas0</span><span class=p>))</span><span class=w>	</span><span class=c1>// 64kb cas1,128kb order1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>order1</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=p>[</span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>17</span><span class=p>]</span><span class=kt>uint16</span><span class=p>)(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=nx>order0</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>ncases</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>nsends</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nx>nrecvs</span><span class=w>	</span><span class=c1>// ncasesä¸ªæ•°æ˜¯å‘é€chanä¸ªæ•°nsendsåŠ ä¸Šæ¥æ”¶chanä¸ªæ•°nrecvs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>scases</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>cas1</span><span class=p>[:</span><span class=nx>ncases</span><span class=p>:</span><span class=nx>ncases</span><span class=p>]</span><span class=w>	</span><span class=c1>// scasesåˆ‡ç‰‡æ˜¯ä¸Šé¢åˆ†é…cas1æ•°ç»„çš„å‰ncasesä¸ªå…ƒç´ ,å¹¶ä¸”æ•°ç»„å®¹é‡ä¹Ÿä¸ºncases</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>pollorder</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>order1</span><span class=p>[:</span><span class=nx>ncases</span><span class=p>:</span><span class=nx>ncases</span><span class=p>]</span><span class=w>	</span><span class=c1>// pollorderæ˜¯order1æ•°ç»„çš„å‰ncasesä¸ªå…ƒç´ ï¼Œä¸lockorderå…±ç”¨ä¸€ä¸ªåº•å±‚æ•°ç»„ï¼Œé¿å…å¤šæ¬¡åˆ†é…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>lockorder</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>order1</span><span class=p>[</span><span class=nx>ncases</span><span class=p>:][:</span><span class=nx>ncases</span><span class=p>:</span><span class=nx>ncases</span><span class=p>]</span><span class=w>	</span><span class=cp>//åŠ é”åˆ—è¡¨lockorderæ˜¯order1æ•°ç»„çš„ç¬¬äºŒæ‰¹ncaseä¸ªå…ƒç´ </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>norder</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>scases</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>cas</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>scases</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// Omit cases without channels from the poll and lock orders.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=c1>// allow GC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>continue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>j</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>cheaprandn</span><span class=p>(</span><span class=nb>uint32</span><span class=p>(</span><span class=nx>norder</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>pollorder</span><span class=p>[</span><span class=nx>norder</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>pollorder</span><span class=p>[</span><span class=nx>j</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>pollorder</span><span class=p>[</span><span class=nx>j</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>uint16</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>norder</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>pollorder</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>pollorder</span><span class=p>[:</span><span class=nx>norder</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>lockorder</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>lockorder</span><span class=p>[:</span><span class=nx>norder</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// sort the cases by Hchan address to get the locking order.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// simple heap sort, to guarantee n log n time and constant stack footprint.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>lockorder</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>j</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>i</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// Start with the pollorder to permute cases on the same channel.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>scases</span><span class=p>[</span><span class=nx>pollorder</span><span class=p>[</span><span class=nx>i</span><span class=p>]].</span><span class=nx>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>for</span><span class=w> </span><span class=nx>j</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>scases</span><span class=p>[</span><span class=nx>lockorder</span><span class=p>[(</span><span class=nx>j</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span><span class=p>]].</span><span class=nx>c</span><span class=p>.</span><span class=nf>sortkey</span><span class=p>()</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nf>sortkey</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>k</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=p>(</span><span class=nx>j</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>lockorder</span><span class=p>[</span><span class=nx>j</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>lockorder</span><span class=p>[</span><span class=nx>k</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>j</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>k</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>lockorder</span><span class=p>[</span><span class=nx>j</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>pollorder</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>lockorder</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=o>--</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>o</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>lockorder</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>scases</span><span class=p>[</span><span class=nx>o</span><span class=p>].</span><span class=nx>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>lockorder</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>lockorder</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>j</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>for</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>k</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>j</span><span class=o>*</span><span class=mi>2</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>k</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>break</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>k</span><span class=o>+</span><span class=mi>1</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>scases</span><span class=p>[</span><span class=nx>lockorder</span><span class=p>[</span><span class=nx>k</span><span class=p>]].</span><span class=nx>c</span><span class=p>.</span><span class=nf>sortkey</span><span class=p>()</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>scases</span><span class=p>[</span><span class=nx>lockorder</span><span class=p>[</span><span class=nx>k</span><span class=o>+</span><span class=mi>1</span><span class=p>]].</span><span class=nx>c</span><span class=p>.</span><span class=nf>sortkey</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>k</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nf>sortkey</span><span class=p>()</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>scases</span><span class=p>[</span><span class=nx>lockorder</span><span class=p>[</span><span class=nx>k</span><span class=p>]].</span><span class=nx>c</span><span class=p>.</span><span class=nf>sortkey</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>lockorder</span><span class=p>[</span><span class=nx>j</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>lockorder</span><span class=p>[</span><span class=nx>k</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>j</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>k</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>continue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>break</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>lockorder</span><span class=p>[</span><span class=nx>j</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>o</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// lock all the channels involved in the select</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>sellock</span><span class=p>(</span><span class=nx>scases</span><span class=p>,</span><span class=w> </span><span class=nx>lockorder</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h4 id=211-åˆå§‹åŒ–>2.1.1. åˆå§‹åŒ–</h4><p>1ï¼‰<strong>pollorder</strong> å’Œ <strong>lockorder</strong>ï¼Œç”¨äºå­˜å‚¨ select è¯­å¥ä¸­é€šé“çš„<strong>éšæœºé¡ºåº</strong>å’Œ<strong>é”å®šé¡ºåº</strong>ï¼›åˆå§‹åŒ– <strong>lockorder</strong> å’Œ <strong>pollorder</strong>ï¼Œé‡‡ç”¨éšæœºæ•°ç”Ÿæˆå™¨å°†éšæœºåŒ–åçš„ case ç´¢å¼•å­˜å‚¨åœ¨ <strong>pollorder</strong> ä¸­ï¼Œå¯ä»¥é¿å… channel çš„é¥¥é¥¿é—®é¢˜ï¼Œä¿è¯å…¬å¹³æ€§ï¼Œåç»­éå†è¯¥æ•°ç»„è¿›è€Œéå†æ‰€æœ‰ case åˆ†æ”¯</p><p>2ï¼‰æ„å»ºä¸€ä¸ªæœ€å¤§å †ï¼Œé€šè¿‡å †æ’åºä¸‹æ²‰çš„æ“ä½œï¼Œæ¯æ¬¡è°ƒæ•´å †ç»“æ„ï¼Œä¿è¯æŒ‰ç…§é€šé“çš„åœ°å€å€¼ä»å¤§åˆ°å°æ’åºï¼Œå¹¶å°†å¯¹åº”çš„ scase æ•°ç»„çš„ä¸‹æ ‡ç´¢å¼•å­˜åœ¨ <strong>lockorder</strong> ä¸­ã€‚</p><p>3ï¼‰è°ƒç”¨<code>sellock</code>ä¾æ¬¡å¯¹<code>lockorder</code>ä¸­çš„æ‰€æœ‰ case çš„ chan è¿›è¡Œä¸Šé”ï¼Œé¿å…å¹¶å‘æ—¶å‘ç”Ÿæ­»é”ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¦é¡ºåºä¸Šé”çš„åŸå› </p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// åŠ é”ï¼Œæ­£åº</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>sellock</span><span class=p>(</span><span class=nx>scases</span><span class=w> </span><span class=p>[]</span><span class=nx>scase</span><span class=p>,</span><span class=w> </span><span class=nx>lockorder</span><span class=w> </span><span class=p>[]</span><span class=kt>uint16</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>hchan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>o</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>lockorder</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>c0</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>scases</span><span class=p>[</span><span class=nx>o</span><span class=p>].</span><span class=nx>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// è·³è¿‡é‡å¤åŠ é”ï¼Œå¹¶æ›´æ–°cä¸ºå‰ä¸€ä¸ª</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>c0</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nx>c</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>c0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nf>lock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>lock</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// è§£é”ï¼Œå€’å™</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>selunlock</span><span class=p>(</span><span class=nx>scases</span><span class=w> </span><span class=p>[]</span><span class=nx>scase</span><span class=p>,</span><span class=w> </span><span class=nx>lockorder</span><span class=w> </span><span class=p>[]</span><span class=kt>uint16</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>lockorder</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=o>--</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>c</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>scases</span><span class=p>[</span><span class=nx>lockorder</span><span class=p>[</span><span class=nx>i</span><span class=p>]].</span><span class=nx>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>scases</span><span class=p>[</span><span class=nx>lockorder</span><span class=p>[</span><span class=nx>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]].</span><span class=nx>c</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>continue</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>lock</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h4 id=212-ç¬¬ä¸€é˜¶æ®µå¤„ç†>2.1.2. ç¬¬ä¸€é˜¶æ®µå¤„ç†</h4><p>4ï¼‰å¼€å§‹ç¬¬ä¸€è½®æŸ¥è¯¢</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>selectgo</span><span class=p>(</span><span class=nx>cas0</span><span class=w> </span><span class=o>*</span><span class=nx>scase</span><span class=p>,</span><span class=w> </span><span class=nx>order0</span><span class=w> </span><span class=o>*</span><span class=kt>uint16</span><span class=p>,</span><span class=w> </span><span class=nx>pc0</span><span class=w> </span><span class=o>*</span><span class=kt>uintptr</span><span class=p>,</span><span class=w> </span><span class=nx>nsends</span><span class=p>,</span><span class=w> </span><span class=nx>nrecvs</span><span class=w> </span><span class=kt>int</span><span class=p>,</span><span class=w> </span><span class=nx>block</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>,</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>gp</span><span class=w>     </span><span class=o>*</span><span class=nx>g</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>sg</span><span class=w>     </span><span class=o>*</span><span class=nx>sudog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=w>      </span><span class=o>*</span><span class=nx>hchan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>k</span><span class=w>      </span><span class=o>*</span><span class=nx>scase</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>sglist</span><span class=w> </span><span class=o>*</span><span class=nx>sudog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>sgnext</span><span class=w> </span><span class=o>*</span><span class=nx>sudog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>qp</span><span class=w>     </span><span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>nextp</span><span class=w>  </span><span class=o>**</span><span class=nx>sudog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// pass 1 - look for something already waiting</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>casi</span><span class=w> </span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>cas</span><span class=w> </span><span class=o>*</span><span class=nx>scase</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>caseSuccess</span><span class=w> </span><span class=kt>bool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>caseReleaseTime</span><span class=w> </span><span class=kt>int64</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=o>-</span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>recvOK</span><span class=w> </span><span class=kt>bool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>casei</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>pollorder</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>casi</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=nx>casei</span><span class=p>)</span><span class=w>	</span><span class=c1>// caseçš„ç´¢å¼•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>cas</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>scases</span><span class=p>[</span><span class=nx>casi</span><span class=p>]</span><span class=w>	</span><span class=c1>// å½“å‰case</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å› ä¸ºä»ç¼–è¯‘å™¨ä¿è¯äº†ä¼ è¿›æ¥çš„scaseæ•°ç»„æ˜¯æŒ‰ç…§sendåœ¨å‰ï¼Œrecvåœ¨åçš„é¡ºåºï¼Œå¹¶ä¸”ä¸åŒ…å«defaultåˆ†æ”¯</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>casi</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=nx>nsends</span><span class=w> </span><span class=p>{</span><span class=w>      </span><span class=c1>// æ‰€ä»¥è¯´æ˜è¯¥caseæ˜¯æ¥æ”¶chanï¼Œå¦å¤–ä¸‹é¢è¿™å‡ ä¸ªifçš„å‰åé¡ºåºä¹Ÿæœ‰è®²ç©¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>sg</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>sendq</span><span class=p>.</span><span class=nf>dequeue</span><span class=p>()</span><span class=w>	 </span><span class=c1>// åœ¨è¯¥chançš„å‘é€é˜Ÿåˆ—æœ‰é˜»å¡ç­‰å¾…å‘é€çš„gï¼Œåˆ™gotoåˆ°recvä»ç¼“å†²åŒºè¯»å–æ•°æ®åå°†ç­‰å¾…goroutineä¸­çš„æ•°æ®æ”¾å…¥åˆ°ç¼“å†²åŒºä¸­ç›¸åŒçš„ä½ç½®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>sg</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>goto</span><span class=w> </span><span class=nx>recv</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>qcount</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>	</span><span class=c1>// å½“å‰chanæ˜¯æœ‰ç¼“å†²chanï¼Œç¼“å†²åŒºæœ‰æ•°æ®ï¼Œgotoåˆ°bufrecvï¼Œä»ç¼“å†²åŒºæ¥æ”¶æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>goto</span><span class=w> </span><span class=nx>bufrecv</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>closed</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>	</span><span class=c1>// å½“å‰chanå·²è¢«closeï¼Œgotoåˆ°rclose</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>goto</span><span class=w> </span><span class=nx>rclose</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>		</span><span class=c1>// elseåˆ†æ”¯è¡¨æ˜è¯¥caseæ˜¯å‘é€chanï¼Œå¦å¤–ä¸‹é¢è¿™å‡ ä¸ªifçš„å‰åé¡ºåºä¹Ÿæœ‰è®²ç©¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>raceenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nf>racereadpc</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nf>raceaddr</span><span class=p>(),</span><span class=w> </span><span class=nf>casePC</span><span class=p>(</span><span class=nx>casi</span><span class=p>),</span><span class=w> </span><span class=nx>chansendpc</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>closed</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>	</span><span class=c1>// å½“å‰chanå·²è¢«closeï¼Œgoto sclose</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>goto</span><span class=w> </span><span class=nx>sclose</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>sg</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>recvq</span><span class=p>.</span><span class=nf>dequeue</span><span class=p>()</span><span class=w>	</span><span class=c1>// ä»å½“å‰chançš„æ¥æ”¶ç­‰å¾…é˜Ÿåˆ—ä¸­è·å¾—ä¸€ä¸ªgï¼Œgotoåˆ°send</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>sg</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>goto</span><span class=w> </span><span class=nx>send</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>qcount</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>dataqsiz</span><span class=w> </span><span class=p>{</span><span class=w>	</span><span class=c1>// å½“å‰chanæ˜¯æœ‰ç¼“å†²chanï¼Œä¸”ç¼“å†²åŒºæœªæ»¡ï¼Œgotoåˆ°bufsendï¼Œå¾€ç¼“å†²åŒºå‘é€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>goto</span><span class=w> </span><span class=nx>bufsend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// éé˜»å¡æ¨¡å¼ï¼Œå³åŒ…å«defaultåˆ†æ”¯ï¼Œä¼šè§£é”æ‰€æœ‰ Channel å¹¶è¿”å›ï¼Œcasi = -1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>block</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>selunlock</span><span class=p>(</span><span class=nx>scases</span><span class=p>,</span><span class=w> </span><span class=nx>lockorder</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>casi</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=o>-</span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>goto</span><span class=w> </span><span class=nx>retc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><ul><li><p>éå† pollorderï¼Œä¾æ¬¡æ£€æŸ¥æ¯ä¸ª case åˆ†æ”¯çš„é€šé“çŠ¶æ€ï¼š</p></li><li><ul><li><strong>casi >= nsends æ˜¯æ¥æ”¶æ“ä½œ</strong>:</li></ul></li></ul><ol><li><ol><li><ol><li>æœ‰ç­‰å¾…å‘é€æ–¹ -> æ‰§è¡Œrecvã€‚è¿™ç§æƒ…å†µè¯´æ˜è‹¥æ˜¯å¸¦ç¼“å†²çš„ chanï¼Œæ­¤æ—¶ç¼“å†²åŒºä¸€å®šæ˜¯æ»¡äº†çš„ï¼Œåªæœ‰ç¼“å†²åŒºæ»¡çš„æƒ…å†µä¸‹æ‰ä¼šå…¥å‘é€ç­‰å¾…é˜Ÿåˆ—</li><li>ç¼“å†²åŒºæœ‰æ•°æ® -> æ‰§è¡Œç¼“å†²åŒºæ¥æ”¶ bufrecvã€‚</li><li>é€šé“å…³é—­ -> æ‰§è¡Œå…³é—­æ¥æ”¶ rcloseã€‚å¯èƒ½åœ¨å…³é—­çš„åŒæ—¶æœ‰å…¶ä»– g å¾€é‡Œå†™äº†æ•°æ®ï¼Œæœ‰æœªæ¥å¾—åŠå¤„ç†çš„æ•°æ®</li></ol></li></ol></li></ol><ul><li><ul><li><strong>casi &lt; nsends æ˜¯å‘é€æ“ä½œ</strong>:</li></ul></li></ul><ol><li><ol><li><ol><li>é€šé“å…³é—­ -> æ‰§è¡Œ sclose</li><li>æœ‰ç­‰å¾…æ¥æ”¶æ–¹ -> æ‰§è¡Œå‘é€ send</li><li>ç¼“å†²åŒºæœ‰ç©ºé—´ -> æ‰§è¡Œå¾€ç¼“å†²åŒºå‘é€ï¼Œbufsend</li></ol></li></ol></li></ol><p>éé˜»å¡æ¨¡å¼ï¼Œå³åŒ…å«defaultåˆ†æ”¯ï¼Œä¼šè§£é”æ‰€æœ‰ Channel å¹¶è¿”å›ï¼Œcasi = -1</p><h4 id=213-ç¬¬äºŒé˜¶æ®µå¤„ç†>2.1.3. ç¬¬äºŒé˜¶æ®µå¤„ç†</h4><p>5ï¼‰å½“å‰æ²¡æœ‰èƒ½å¤Ÿå¤„ç†çš„ chanï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µçš„å¤„ç†ï¼Œå°†å½“å‰ g åŠ å…¥åˆ° chan çš„æ”¶å‘ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…å…¶ä»– g çš„å”¤é†’</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>selectgo</span><span class=p>(</span><span class=nx>cas0</span><span class=w> </span><span class=o>*</span><span class=nx>scase</span><span class=p>,</span><span class=w> </span><span class=nx>order0</span><span class=w> </span><span class=o>*</span><span class=kt>uint16</span><span class=p>,</span><span class=w> </span><span class=nx>pc0</span><span class=w> </span><span class=o>*</span><span class=kt>uintptr</span><span class=p>,</span><span class=w> </span><span class=nx>nsends</span><span class=p>,</span><span class=w> </span><span class=nx>nrecvs</span><span class=w> </span><span class=kt>int</span><span class=p>,</span><span class=w> </span><span class=nx>block</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>,</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// pass 2 - enqueue on all chans</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>gp</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>getg</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>gp</span><span class=p>.</span><span class=nx>waiting</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>throw</span><span class=p>(</span><span class=s>&#34;gp.waiting != nil&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>nextp</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>gp</span><span class=p>.</span><span class=nx>waiting</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>casei</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>lockorder</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>casi</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=nx>casei</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>cas</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>scases</span><span class=p>[</span><span class=nx>casi</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>sg</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>acquireSudog</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>sg</span><span class=p>.</span><span class=nx>g</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>gp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>sg</span><span class=p>.</span><span class=nx>isSelect</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// No stack splits between assigning elem and enqueuing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// sg on gp.waiting where copystack can find it.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>sg</span><span class=p>.</span><span class=nx>elem</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>sg</span><span class=p>.</span><span class=nx>releasetime</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>t0</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>sg</span><span class=p>.</span><span class=nx>releasetime</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=o>-</span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>sg</span><span class=p>.</span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Construct waiting list in lock order.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å°† sg æ·»åŠ åˆ°å½“å‰ Goroutine çš„ç­‰å¾…é“¾è¡¨ä¸­ï¼Œé“¾è¡¨é€šè¿‡ gp.waiting å­—æ®µé“¾æ¥ï¼Œwaitlink æ˜¯é“¾è¡¨çš„ä¸‹ä¸€èŠ‚ç‚¹æŒ‡é’ˆã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// gp.waiting æ˜¯é“¾è¡¨çš„å¤´ï¼Œnextp é€æ­¥é“¾æ¥æ¯ä¸ª Sudog èŠ‚ç‚¹ï¼Œæ„é€ å‡º Goroutine å¯¹æ‰€æœ‰é€šé“æ“ä½œçš„ç­‰å¾…é“¾è¡¨ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// é€šè¿‡ gp.waiting é“¾è¡¨ï¼ŒGo runtime èƒ½å¤Ÿå¿«é€Ÿæ‰¾åˆ°å½“å‰ Goroutine æ­£åœ¨ç­‰å¾…çš„æ‰€æœ‰é€šé“æ“ä½œï¼›</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å½“æŸä¸ªé€šé“æ“ä½œæˆåŠŸæ—¶ï¼Œè°ƒåº¦å™¨å¯ä»¥é¡ºç€ gp.waiting é“¾è¡¨æ‰¾åˆ°ä¸è¯¥æ“ä½œç›¸å…³çš„ Sudogï¼Œå¹¶å”¤é†’å¯¹åº”çš„ Goroutineã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>*</span><span class=nx>nextp</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>sg</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>nextp</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>sg</span><span class=p>.</span><span class=nx>waitlink</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>casi</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>nsends</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>c</span><span class=p>.</span><span class=nx>sendq</span><span class=p>.</span><span class=nf>enqueue</span><span class=p>(</span><span class=nx>sg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>c</span><span class=p>.</span><span class=nx>recvq</span><span class=p>.</span><span class=nf>enqueue</span><span class=p>(</span><span class=nx>sg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// wait for someone to wake us up</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>gp</span><span class=p>.</span><span class=nx>param</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Signal to anyone trying to shrink our stack that we&#39;re about</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// to park on a channel. The window between when this G&#39;s status</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// changes and when we set gp.activeStackChans is not safe for</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// stack shrinking.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>gp</span><span class=p>.</span><span class=nx>parkingOnChan</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>gopark</span><span class=p>(</span><span class=nx>selparkcommit</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>waitReasonSelect</span><span class=p>,</span><span class=w> </span><span class=nx>traceBlockSelect</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>gp</span><span class=p>.</span><span class=nx>activeStackChans</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>sellock</span><span class=p>(</span><span class=nx>scases</span><span class=p>,</span><span class=w> </span><span class=nx>lockorder</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>gp</span><span class=p>.</span><span class=nx>selectDone</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>sg</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>sudog</span><span class=p>)(</span><span class=nx>gp</span><span class=p>.</span><span class=nx>param</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>gp</span><span class=p>.</span><span class=nx>param</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>...</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>æ„é€  goroutine çš„ sudog ç­‰å¾…é˜Ÿåˆ—é“¾è¡¨ï¼Œæ¯ä¸€ä¸ª sudog ä»£è¡¨äº†è¯¥ goroutine åœ¨ä¸€ä¸ªé€šé“ä¸Šçš„ç­‰å¾…æ“ä½œ</p><p>å°†èƒ½ä»£è¡¨ goroutine çš„ sudog åŠ å…¥åˆ° chan æ”¶å‘é˜Ÿåˆ—ä¸­ï¼Œè®©å‡ºè°ƒåº¦æƒï¼Œç­‰å¾…è¢«å…¶ä»– g å”¤é†’</p><h4 id=214-ç¬¬ä¸‰é˜¶æ®µå¤„ç†>2.1.4. ç¬¬ä¸‰é˜¶æ®µå¤„ç†</h4><p>6ï¼‰ç¬¬ä¸‰é˜¶æ®µ</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>selectgo</span><span class=p>(</span><span class=nx>cas0</span><span class=w> </span><span class=o>*</span><span class=nx>scase</span><span class=p>,</span><span class=w> </span><span class=nx>order0</span><span class=w> </span><span class=o>*</span><span class=kt>uint16</span><span class=p>,</span><span class=w> </span><span class=nx>pc0</span><span class=w> </span><span class=o>*</span><span class=kt>uintptr</span><span class=p>,</span><span class=w> </span><span class=nx>nsends</span><span class=p>,</span><span class=w> </span><span class=nx>nrecvs</span><span class=w> </span><span class=kt>int</span><span class=p>,</span><span class=w> </span><span class=nx>block</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>,</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¯¹æ‰€æœ‰é€šé“åŠ é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>sellock</span><span class=p>(</span><span class=nx>scases</span><span class=p>,</span><span class=w> </span><span class=nx>lockorder</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>gp</span><span class=p>.</span><span class=nx>selectDone</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>sg</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>sudog</span><span class=p>)(</span><span class=nx>gp</span><span class=p>.</span><span class=nx>param</span><span class=p>)</span><span class=w>	</span><span class=c1>// è®°å½•æ˜¯è¢«å“ªä¸ªé€šé“å”¤é†’äº†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>gp</span><span class=p>.</span><span class=nx>param</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// pass 3 - dequeue from unsuccessful chans</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// otherwise they stack up on quiet channels</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// record the successful case, if any.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// We singly-linked up the SudoGs in lock order.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>casi</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=o>-</span><span class=mi>1</span><span class=w>	</span><span class=c1>// æ¸…ç©ºå˜é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>cas</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>caseSuccess</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>sglist</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>gp</span><span class=p>.</span><span class=nx>waiting</span><span class=w>	 </span><span class=c1>// æŒ‡å‘ Goroutine ç­‰å¾…çš„ sudog é“¾è¡¨ï¼ˆgp.waitingï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Clear all elem before unlinking from gp.waitingï¼Œéå† gp.waiting é“¾è¡¨ï¼Œæ¸…ç©ºæ¯ä¸ª sudog çš„å±æ€§</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>sg1</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>gp</span><span class=p>.</span><span class=nx>waiting</span><span class=p>;</span><span class=w> </span><span class=nx>sg1</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=p>;</span><span class=w> </span><span class=nx>sg1</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>sg1</span><span class=p>.</span><span class=nx>waitlink</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>sg1</span><span class=p>.</span><span class=nx>isSelect</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>sg1</span><span class=p>.</span><span class=nx>elem</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>sg1</span><span class=p>.</span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>gp</span><span class=p>.</span><span class=nx>waiting</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>	</span><span class=c1>// å°†å½“å‰gçš„ç­‰å¾…é“¾è¡¨æ¸…ç©ºï¼Œè¡¨ç¤º Goroutine ä¸å†ç­‰å¾…ä»»ä½•æ“ä½œã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// éå† lockorderï¼ˆæŒ‰ç…§åŠ é”é¡ºåºï¼‰ä¸­çš„æ¯ä¸ªé€šé“ï¼Œå¤„ç†æ¯ä¸ª case</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>casei</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>lockorder</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>k</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>scases</span><span class=p>[</span><span class=nx>casei</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>sg</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>sglist</span><span class=w> </span><span class=p>{</span><span class=w>	</span><span class=c1>// åˆ¤æ–­å½“å‰ sudog èŠ‚ç‚¹ sg æ˜¯å¦æ˜¯ gp.param æŒ‡å®šçš„èŠ‚ç‚¹ï¼ˆå”¤é†’èŠ‚ç‚¹ï¼‰ï¼Œè‹¥æ˜¯ï¼Œåˆ™è¯´æ˜goroutineæ˜¯è¢«å½“å‰caseçš„channelæ”¶å‘æ“ä½œå”¤é†’çš„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// sg has already been dequeued by the G that woke us up.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>casi</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=nx>casei</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>cas</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>k</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>caseSuccess</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>sglist</span><span class=p>.</span><span class=nx>success</span><span class=w>	</span><span class=c1>// æ ‡è®°é€šé“æ“ä½œæˆåŠŸ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>sglist</span><span class=p>.</span><span class=nx>releasetime</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>caseReleaseTime</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>sglist</span><span class=p>.</span><span class=nx>releasetime</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>	</span><span class=c1>// å¦‚æœä¸æ˜¯ï¼Œåˆ™æ¸…ç†æœªè¢«å”¤é†’çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œä»chançš„æ”¶å‘é˜Ÿåˆ—ä¸­å‡ºé˜Ÿ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>k</span><span class=p>.</span><span class=nx>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=nx>casei</span><span class=p>)</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>nsends</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>c</span><span class=p>.</span><span class=nx>sendq</span><span class=p>.</span><span class=nf>dequeueSudoG</span><span class=p>(</span><span class=nx>sglist</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>c</span><span class=p>.</span><span class=nx>recvq</span><span class=p>.</span><span class=nf>dequeueSudoG</span><span class=p>(</span><span class=nx>sglist</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c1>// è®°å½•ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ sgnextã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	 </span><span class=c1>// å°†å½“å‰èŠ‚ç‚¹çš„ waitlink æ¸…ç©ºã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	 </span><span class=c1>// é‡Šæ”¾å½“å‰ sudogï¼Œå›æ”¶èµ„æºï¼ˆreleaseSudogï¼‰ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	 </span><span class=c1>// æ›´æ–° sglist ä¸ºä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç»§ç»­å¤„ç†ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>sgnext</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>sglist</span><span class=p>.</span><span class=nx>waitlink</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>sglist</span><span class=p>.</span><span class=nx>waitlink</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>releaseSudog</span><span class=p>(</span><span class=nx>sglist</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>sglist</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>sgnext</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>cas</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>throw</span><span class=p>(</span><span class=s>&#34;selectgo: bad wakeup&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>debugSelect</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>print</span><span class=p>(</span><span class=s>&#34;wait-return: cas0=&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>cas0</span><span class=p>,</span><span class=w> </span><span class=s>&#34; c=&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=s>&#34; cas=&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>cas</span><span class=p>,</span><span class=w> </span><span class=s>&#34; send=&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>casi</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>nsends</span><span class=p>,</span><span class=w> </span><span class=s>&#34;\n&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// éªŒè¯å”¤é†’åçš„é€šé“caseï¼Œåˆ¤æ–­å”¤é†’çš„æ“ä½œæ˜¯å¦æ˜¯å‘é€æ“ä½œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>casi</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>nsends</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>caseSuccess</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>goto</span><span class=w> </span><span class=nx>sclose</span><span class=w>  	</span><span class=cp>//æ˜¯å‘é€æ“ä½œä¸” caseSuccess == falseï¼Œè¯´æ˜å‘é€æ“ä½œå¤±è´¥äº†ï¼ˆä¾‹å¦‚é€šé“å·²å…³é—­ï¼‰ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>recvOK</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>caseSuccess</span><span class=w>	</span><span class=cp>//å”¤é†’çš„æ˜¯æ¥æ”¶æ“ä½œï¼ˆcasi &gt;= nsendsï¼‰ï¼Œè®°å½•æ“ä½œæˆåŠŸçŠ¶æ€åˆ° recvOK</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>raceenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>casi</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>nsends</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nf>raceReadObjectPC</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=nf>casePC</span><span class=p>(</span><span class=nx>casi</span><span class=p>),</span><span class=w> </span><span class=nx>chansendpc</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nf>raceWriteObjectPC</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=nf>casePC</span><span class=p>(</span><span class=nx>casi</span><span class=p>),</span><span class=w> </span><span class=nx>chanrecvpc</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>msanenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>casi</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>nsends</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nf>msanread</span><span class=p>(</span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>.</span><span class=nx>Size_</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nf>msanwrite</span><span class=p>(</span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>.</span><span class=nx>Size_</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>asanenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>casi</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>nsends</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nf>asanread</span><span class=p>(</span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>.</span><span class=nx>Size_</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nf>asanwrite</span><span class=p>(</span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>.</span><span class=nx>Size_</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// è§£é”ï¼Œè¿”å›</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>selunlock</span><span class=p>(</span><span class=nx>scases</span><span class=p>,</span><span class=w> </span><span class=nx>lockorder</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>goto</span><span class=w> </span><span class=nx>retc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>ä¸»è¦åšäº†ï¼š</p><ol><li>æ¸…ç©ºå½“å‰ goroutine çš„ sudog ç­‰å¾…é˜Ÿåˆ—ï¼Œå› ä¸º goroutine å·²ç»è¢«å”¤é†’äº†</li><li>éå†å…¨éƒ¨ case çš„ sudogï¼Œæ‰¾åˆ°å”¤é†’å½“å‰ goroutine çš„ case çš„ç´¢å¼•ï¼Œå¹¶éªŒè¯å…¶æœ‰æ•ˆæ€§ï¼Œè®°å½•æ“ä½œçŠ¶æ€</li><li>å‰©ä¸‹çš„ä¸æ˜¯å”¤é†’å½“å‰ goroutine çš„ caseï¼Œéœ€è¦å°†å½“å‰ goroutine ä»è¿™äº› case çš„å‘é€é˜Ÿåˆ—æˆ–æ¥æ”¶é˜Ÿåˆ—å‡ºé˜Ÿï¼Œå¹¶é‡Šæ”¾è¿™äº› case çš„ sudog</li></ol><h4 id=215-goto-æ ‡ç­¾>2.1.5. goto æ ‡ç­¾</h4><p>æœ€åæ˜¯ä¸€äº› goto æ ‡ç­¾ä»£ç ï¼š</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>selectgo</span><span class=p>(</span><span class=nx>cas0</span><span class=w> </span><span class=o>*</span><span class=nx>scase</span><span class=p>,</span><span class=w> </span><span class=nx>order0</span><span class=w> </span><span class=o>*</span><span class=kt>uint16</span><span class=p>,</span><span class=w> </span><span class=nx>pc0</span><span class=w> </span><span class=o>*</span><span class=kt>uintptr</span><span class=p>,</span><span class=w> </span><span class=nx>nsends</span><span class=p>,</span><span class=w> </span><span class=nx>nrecvs</span><span class=w> </span><span class=kt>int</span><span class=p>,</span><span class=w> </span><span class=nx>block</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>,</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>bufrecv</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// can receive from buffer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>raceenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nf>raceWriteObjectPC</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=nf>casePC</span><span class=p>(</span><span class=nx>casi</span><span class=p>),</span><span class=w> </span><span class=nx>chanrecvpc</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>racenotify</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>msanenabled</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>msanwrite</span><span class=p>(</span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>.</span><span class=nx>Size_</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>asanenabled</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>asanwrite</span><span class=p>(</span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>.</span><span class=nx>Size_</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>recvOK</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>qp</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>chanbuf</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>typedmemmove</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=nx>qp</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>typedmemclr</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span><span class=w> </span><span class=nx>qp</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>dataqsiz</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>.</span><span class=nx>qcount</span><span class=o>--</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>selunlock</span><span class=p>(</span><span class=nx>scases</span><span class=p>,</span><span class=w> </span><span class=nx>lockorder</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>goto</span><span class=w> </span><span class=nx>retc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>bufsend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// can send to buffer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>raceenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>racenotify</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>sendx</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>raceReadObjectPC</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=nf>casePC</span><span class=p>(</span><span class=nx>casi</span><span class=p>),</span><span class=w> </span><span class=nx>chansendpc</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>msanenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>msanread</span><span class=p>(</span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>.</span><span class=nx>Size_</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>asanenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>asanread</span><span class=p>(</span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>.</span><span class=nx>Size_</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>typedmemmove</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span><span class=w> </span><span class=nf>chanbuf</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>sendx</span><span class=p>),</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>.</span><span class=nx>sendx</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>sendx</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>dataqsiz</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=p>.</span><span class=nx>sendx</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>.</span><span class=nx>qcount</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>selunlock</span><span class=p>(</span><span class=nx>scases</span><span class=p>,</span><span class=w> </span><span class=nx>lockorder</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>goto</span><span class=w> </span><span class=nx>retc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>recv</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// can receive from sleeping sender (sg)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>recv</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>sg</span><span class=p>,</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nf>selunlock</span><span class=p>(</span><span class=nx>scases</span><span class=p>,</span><span class=w> </span><span class=nx>lockorder</span><span class=p>)</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>debugSelect</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nb>print</span><span class=p>(</span><span class=s>&#34;syncrecv: cas0=&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>cas0</span><span class=p>,</span><span class=w> </span><span class=s>&#34; c=&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=s>&#34;\n&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>recvOK</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>goto</span><span class=w> </span><span class=nx>retc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>rclose</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// read at end of closed channel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>selunlock</span><span class=p>(</span><span class=nx>scases</span><span class=p>,</span><span class=w> </span><span class=nx>lockorder</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>recvOK</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>typedmemclr</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>raceenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>raceacquire</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nf>raceaddr</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>goto</span><span class=w> </span><span class=nx>retc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>send</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// can send to a sleeping receiver (sg)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>raceenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>raceReadObjectPC</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=nf>casePC</span><span class=p>(</span><span class=nx>casi</span><span class=p>),</span><span class=w> </span><span class=nx>chansendpc</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>msanenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>msanread</span><span class=p>(</span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>.</span><span class=nx>Size_</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>asanenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>asanread</span><span class=p>(</span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>.</span><span class=nx>Size_</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>send</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>sg</span><span class=p>,</span><span class=w> </span><span class=nx>cas</span><span class=p>.</span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nf>selunlock</span><span class=p>(</span><span class=nx>scases</span><span class=p>,</span><span class=w> </span><span class=nx>lockorder</span><span class=p>)</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>debugSelect</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nb>print</span><span class=p>(</span><span class=s>&#34;syncsend: cas0=&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>cas0</span><span class=p>,</span><span class=w> </span><span class=s>&#34; c=&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=s>&#34;\n&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>goto</span><span class=w> </span><span class=nx>retc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>retc</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>caseReleaseTime</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>blockevent</span><span class=p>(</span><span class=nx>caseReleaseTime</span><span class=o>-</span><span class=nx>t0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>casi</span><span class=p>,</span><span class=w> </span><span class=nx>recvOK</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>sclose</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// send on closed channel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>selunlock</span><span class=p>(</span><span class=nx>scases</span><span class=p>,</span><span class=w> </span><span class=nx>lockorder</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nb>panic</span><span class=p>(</span><span class=nf>plainError</span><span class=p>(</span><span class=s>&#34;send on closed channel&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>ç»¼åˆä¸Šé¢çš„åˆ†æï¼Œæ€»ç»“å¦‚ä¸‹ï¼š</p><p><strong>ç¼–è¯‘å™¨ä¼šå¯¹selectæœ‰ä¸åŒçš„caseçš„æƒ…å†µè¿›è¡Œä¼˜åŒ–ä»¥æé«˜æ€§èƒ½</strong>ï¼Œä¸»è¦æ˜¯åŒ…å«ä»¥ä¸‹å››ç±»ï¼š</p><ol><li>select æ²¡æœ‰ case &ndash;> è°ƒç”¨ runtime.block å‡ºè®©è°ƒåº¦æƒï¼Œé™·å…¥æ­»é”</li><li>select æœ‰å• case &ndash;> è½¬æ¢ä¸ºå¯¹ channel çš„è¯»å†™æ“ä½œï¼Œå®é™…è°ƒç”¨ <code>data := &lt;- ch</code> æˆ– <code>ch &lt;- data</code> å¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«</li><li>select æœ‰å•ä¸€ case å’Œ default &ndash;> è½¬æ¢ä¸ºè°ƒç”¨<code>runtime.selectnbrecv()</code> å‡½æ•°å’Œ<code>runtime.selectnbsend()</code>å‡½æ•°ï¼Œéé˜»å¡è°ƒç”¨</li><li>select æœ‰å¤šä¸ªå¯è¯»å†™ case &ndash;> è°ƒç”¨ <code>runtime.selectgo()</code> å‡½æ•°éšæœºè·å–ä¸€ä¸ªå·²å‡†å¤‡å¥½çš„ case åˆ†æ”¯ç´¢å¼•ï¼Œå¹¶ç”Ÿæˆ if è¯­å¥æ‰§è¡Œè¯¥ case çš„ä»£ç ã€‚è‹¥éƒ½æ²¡æœ‰å‡†å¤‡å¥½ï¼Œé™·å…¥ç­‰å¾…ï¼Œè‹¥æ­¤æ—¶æœ‰ default åˆ†æ”¯ï¼Œåˆ™æ‰§è¡Œ default åˆ†æ”¯ã€‚</li></ol><p><code>runtime.selectgo()</code> å‡½æ•°å®ç°æ­¥éª¤ï¼š</p><ol><li>ç”Ÿæˆä¸€ä¸ªå…·æœ‰éšæœºæ€§çš„ pollorder æ•°ç»„ï¼Œè¯¥æ•°ç»„å­˜æ”¾ç€å„ä¸ªæ‰§è¡Œ case çš„ç´¢å¼•ï¼Œåç»­éå†è¯¥æ•°ç»„æ¥éå†æ‰€æœ‰ caseï¼Œéšæœºæ€§èƒ½å¤Ÿä¿è¯åœ¨æœ‰å¤šä¸ª chan åŒæ—¶å‡†å¤‡å¥½èƒ½å¤Ÿè¯»å†™çš„æƒ…å†µä¸‹ï¼Œéƒ½æœ‰è¢«æ‰§è¡Œçš„æœºä¼šï¼Œé¿å… chan é¥¥é¥¿ï¼Œä¿è¯å…¬å¹³æ€§</li><li>æ ¹æ® chan çš„åœ°å€ç”ŸæˆåŠ é”é¡ºåºçš„æ•°ç»„ lockorderï¼Œæ•°ç»„ä¸­ä¿å­˜çš„ caseï¼ŒæŒ‰éå†é¡ºåºä¾æ¬¡åŠ é”ï¼Œèƒ½å¤Ÿé¿å…æ­»é”å’Œé‡å¤åŠ é”ã€‚</li><li>éå† pollorder æ•°ç»„ï¼Œé¡ºåºæŸ¥æ‰¾ scases æ˜¯å¦å­˜åœ¨èƒ½å¤Ÿç«‹å³è¿›è¡Œæ”¶å‘æ“ä½œçš„ chanï¼Œæœ‰çš„è¯è·å– case ç´¢å¼•è¿›è¡Œå¤„ç†</li><li>å¦‚æœæ­¤æ—¶æ²¡æœ‰ï¼Œåˆ™å°†å½“å‰ goroutine åŠ å…¥å„ case çš„ chan å¯¹åº”çš„æ”¶å‘é˜Ÿåˆ—ä¸­ï¼Œè®©å‡ºè°ƒåº¦æƒï¼Œç­‰å¾…å…¶ä»– goroutine å”¤é†’</li><li>è°ƒåº¦å™¨å”¤é†’å½“å‰ goroutine åï¼Œä¼šå†æ¬¡éå† lockorderï¼ŒæŒ‰é¡ºåºå¯¹ case ä¸­çš„ chan åŠ é”ï¼Œå¹¶ä»ä¸­æ‰¾åˆ°éœ€è¦è¢«å¤„ç†çš„ case åˆ†æ”¯çš„ç´¢å¼•ï¼ŒéªŒè¯å…¶æœ‰æ•ˆæ€§ï¼Œè·³è½¬åˆ°æ”¶å‘æ“ä½œçš„ goto æ ‡ç­¾è¿›è¡Œå¤„ç†ï¼›åŒæ—¶ï¼Œä»æ‰€æœ‰ case çš„æ”¶å‘ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤å½“å‰ goroutine</li></ol><h4 id=216-å…¶ä»–>2.1.6. å…¶ä»–</h4><p>1ã€pollorder éšæœºæ€§éªŒè¯ï¼š</p><p>ä¸¾ä¾‹å­éªŒè¯ï¼š</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>å‡è®¾éšæœºæ•°æ’ä¸º</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=nx>çš„å®Œæ•´æ¡ˆä¾‹åˆ†æ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>åˆå§‹çŠ¶æ€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>pollorder</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>[</span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=p>]</span><span class=err>ï¼Œ</span><span class=nx>norder</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>0</span><span class=err>ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>ç¬¬</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=nx>æ¬¡è¿­ä»£</span><span class=w> </span><span class=p>(</span><span class=nx>i</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>0</span><span class=p>):</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=err>â€¢</span><span class=w>	</span><span class=nx>cas</span><span class=p>.</span><span class=nx>c</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=err>ï¼Œ</span><span class=nx>è¿›å…¥é€»è¾‘</span><span class=err>ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=err>â€¢</span><span class=w>	</span><span class=nx>j</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>cheaprandn</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=err>â€¢</span><span class=w>	</span><span class=nx>æ“ä½œ</span><span class=err>ï¼š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>pollorder</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>pollorder</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w>  </span><span class=c1>// æ²¡æœ‰å½±å“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>pollorder</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>0</span><span class=w>            </span><span class=c1>// æ’å…¥å½“å‰ç´¢å¼•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>æ›´æ–°</span><span class=err>ï¼š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>pollorder</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>norder</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>ç¬¬</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=nx>æ¬¡è¿­ä»£</span><span class=w> </span><span class=p>(</span><span class=nx>i</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>1</span><span class=p>):</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=err>â€¢</span><span class=w>	</span><span class=nx>cas</span><span class=p>.</span><span class=nx>c</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=err>ï¼Œ</span><span class=nx>è¿›å…¥é€»è¾‘</span><span class=err>ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=err>â€¢</span><span class=w>	</span><span class=nx>j</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>cheaprandn</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>1</span><span class=err>ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=err>â€¢</span><span class=w>	</span><span class=nx>æ“ä½œ</span><span class=err>ï¼š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>pollorder</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>pollorder</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=w>  </span><span class=c1>// æ— å½±å“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>pollorder</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>1</span><span class=w>            </span><span class=c1>// æ’å…¥å½“å‰ç´¢å¼•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>æ›´æ–°</span><span class=err>ï¼š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>pollorder</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>norder</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>ç¬¬</span><span class=w> </span><span class=mi>3</span><span class=w> </span><span class=nx>æ¬¡è¿­ä»£</span><span class=w> </span><span class=p>(</span><span class=nx>i</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>2</span><span class=p>):</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=err>â€¢</span><span class=w>	</span><span class=nx>cas</span><span class=p>.</span><span class=nx>c</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=err>ï¼Œ</span><span class=nx>è¿›å…¥é€»è¾‘</span><span class=err>ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=err>â€¢</span><span class=w>	</span><span class=nx>j</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>cheaprandn</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>1</span><span class=err>ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=err>â€¢</span><span class=w>	</span><span class=nx>æ“ä½œ</span><span class=err>ï¼š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>pollorder</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>pollorder</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=w>  </span><span class=c1>// pollorder[2] = 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>pollorder</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>2</span><span class=w>            </span><span class=c1>// pollorder[1] è¢«è¦†ç›–ä¸ºå½“å‰ç´¢å¼•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>æ›´æ–°</span><span class=err>ï¼š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>pollorder</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>norder</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>ç¬¬</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=nx>æ¬¡è¿­ä»£</span><span class=w> </span><span class=p>(</span><span class=nx>i</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>3</span><span class=p>):</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=err>â€¢</span><span class=w>	</span><span class=nx>cas</span><span class=p>.</span><span class=nx>c</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=err>ï¼Œ</span><span class=nx>è¿›å…¥é€»è¾‘</span><span class=err>ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=err>â€¢</span><span class=w>	</span><span class=nx>j</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>cheaprandn</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>1</span><span class=err>ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=err>â€¢</span><span class=w>	</span><span class=nx>æ“ä½œ</span><span class=err>ï¼š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>pollorder</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>pollorder</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=w>  </span><span class=c1>// pollorder[3] = 2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>pollorder</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>3</span><span class=w>            </span><span class=c1>// pollorder[1] è¢«è¦†ç›–ä¸ºå½“å‰ç´¢å¼•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>æ›´æ–°</span><span class=err>ï¼š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>pollorder</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>norder</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>ç»“æœåˆ†æ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>pollorder</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>åŒ…å«æ‰€æœ‰æœ‰æ•ˆç´¢å¼•</span><span class=w> </span><span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>]</span><span class=err>ï¼Œ</span><span class=nx>é¡ºåºè¢«éšæœºåŒ–</span><span class=err>ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>å³ä½¿éšæœºæ•°æ€»æ˜¯è¿”å›</span><span class=w> </span><span class=mi>1</span><span class=err>ï¼Œ</span><span class=nx>ç”±äº</span><span class=w> </span><span class=nx>pollorder</span><span class=w> </span><span class=nx>çš„æ’å…¥æ“ä½œæ€»æ˜¯éµå¾ªéšæœºäº¤æ¢é€»è¾‘</span><span class=err>ï¼Œ</span><span class=nx>æœ€ç»ˆç»“æœä»ç„¶åŒ…å«æ‰€æœ‰æœ‰æ•ˆçš„</span><span class=w> </span><span class=k>case</span><span class=w> </span><span class=nx>ç´¢å¼•</span><span class=err>ï¼Œ</span><span class=nx>ä¸ä¼šä¸¢å¤±ç´¢å¼•æˆ–è¶…å‡ºèŒƒå›´</span><span class=err>ã€‚</span></span></span></code></pre></div></div><p>2ã€ å‚è€ƒé“¾æ¥ï¼š</p><p><a href=https://cloud.tencent.com/developer/article/2205909 target=_blank rel="noopener noreffer">https://cloud.tencent.com/developer/article/2205909</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>æ›´æ–°äº 2026-02-04</span></div><div id=page-views class=post-info-mod></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/select/index.md target=_blank>é˜…è¯»åŸå§‹æ–‡æ¡£</a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/go/>Go</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>è¿”å›</a></span>&nbsp;|&nbsp;<span><a href=/>ä¸»é¡µ</a></span></section></div><div class=post-nav><a href=/panic/ class=next rel=next title=Panic>Panic<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2026</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>zg</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=å›åˆ°é¡¶éƒ¨><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i></a></div><div id=fixed-buttons-hidden><a href=# id=view-comments class=fixed-button title=æŸ¥çœ‹è¯„è®º><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script src=/lib/autocomplete/autocomplete.min.js></script><script src=/lib/lunr/lunr.min.js></script><script src=/lib/lunr/lunr.stemmer.support.min.js></script><script src=/lib/lunr/lunr.zh.min.js></script><script src=/lib/lazysizes/lazysizes.min.js></script><script src=/lib/lightgallery/lightgallery.min.js></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js></script><script src=/lib/clipboard/clipboard.min.js></script><script src=/lib/typeit/index.umd.js></script><script src=/lib/katex/katex.min.js></script><script src=/lib/katex/contrib/auto-render.min.js></script><script src=/lib/katex/contrib/copy-tex.min.js></script><script src=/lib/katex/contrib/mhchem.min.js></script><script src=/lib/cookieconsent/cookieconsent.min.js></script><script>window.config={comment:{},cookieconsent:{content:{dismiss:"åŒæ„",link:"äº†è§£æ›´å¤š",message:"æœ¬ç½‘ç«™ä½¿ç”¨ Cookies æ¥æ”¹å–„æ‚¨çš„æµè§ˆä½“éªŒ."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},data:{"id-1":"zg's blog","id-2":"zg's blog"},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"æ²¡æœ‰æ‰¾åˆ°ç»“æœ",snippetLength:30,type:"lunr"},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"id-1":["id-1"],"id-2":["id-2"]},duration:-1,speed:100}}</script><script src=/js/theme.min.js></script></body></html>