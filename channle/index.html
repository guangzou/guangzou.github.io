<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Channelè§£æ - zg blog</title><meta name=Description content="Stay hungry, stay foolish! ğŸš€"><meta property="og:url" content="https://guangzou.github.io/channle/"><meta property="og:site_name" content="zg blog"><meta property="og:title" content="Channelè§£æ"><meta property="og:description" content="åŸºäº go1.22.6 æºç è§£æ channel åº•å±‚æºç "><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-02-03T16:44:51+08:00"><meta property="article:modified_time" content="2026-02-04T17:59:12+08:00"><meta property="article:tag" content="Go"><meta property="og:image" content="https://guangzou.github.io/logo.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://guangzou.github.io/logo.png"><meta name=twitter:title content="Channelè§£æ"><meta name=twitter:description content="åŸºäº go1.22.6 æºç è§£æ channel åº•å±‚æºç "><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=referrer content="no-referrer"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://guangzou.github.io/channle/><link rel=prev href=https://guangzou.github.io/context/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/css/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Channelè§£æ","inLanguage":"zh-cn","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/guangzou.github.io\/channle\/"},"genre":"posts","keywords":"Go","wordcount":10733,"url":"https:\/\/guangzou.github.io\/channle\/","datePublished":"2026-02-03T16:44:51+08:00","dateModified":"2026-02-04T17:59:12+08:00","license":"xxx","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"zg"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script>const query=window.matchMedia("(prefers-color-scheme: dark)");function applyTheme(){let e=window.localStorage?.getItem("theme")||"auto",t=e==="dark"||e==="auto"&&query.matches;document.body.setAttribute("theme",t?"dark":"light"),document.body.setAttribute("cfg-theme",e)}applyTheme(),query.addEventListener("change",applyTheme)</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="zg blog"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span><span id=id-1 class=typeit></span><span class=header-title-post><i class='fas fa-book fa-fw'></i></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>æ–‡ç«  </a><a class=menu-item href=/tags/>æ ‡ç­¾ </a><a class=menu-item href=/categories/>åˆ†ç±» </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=æœç´¢><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=æ¸…ç©º><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="zg blog"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span><span id=id-2 class=typeit></span><span class=header-title-post><i class='fas fa-book fa-fw'></i></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=æœç´¢><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=æ¸…ç©º><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>å–æ¶ˆ</a></div><a class=menu-item href=/posts/ title>æ–‡ç« </a><a class=menu-item href=/tags/ title>æ ‡ç­¾</a><a class=menu-item href=/categories/ title>åˆ†ç±»</a><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>ç›®å½•</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Channelè§£æ</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>zg</a></span>&nbsp;<span class=post-category>æ”¶å½•äº <a href=/categories/go%E8%AF%AD%E8%A8%80/><i class="far fa-folder fa-fw" aria-hidden=true></i>Goè¯­è¨€</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2026-02-03>2026-02-03</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;çº¦ 10733 å­—&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;é¢„è®¡é˜…è¯» 22 åˆ†é’Ÿ&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/images/channel%e5%ba%95%e5%b1%82%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90_banner.png data-srcset="/images/channel%e5%ba%95%e5%b1%82%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90_banner.png, /images/channel%e5%ba%95%e5%b1%82%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90_banner.png 1.5x, /images/channel%e5%ba%95%e5%b1%82%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90_banner.png 2x" data-sizes=auto alt=/images/channelåº•å±‚æºç è§£æ_banner.png title=/images/channelåº•å±‚æºç è§£æ_banner.png></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>ç›®å½•</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1å†…éƒ¨æ•°æ®ç»“æ„>1ã€å†…éƒ¨æ•°æ®ç»“æ„</a></li><li><a href=#2æ„é€ å‡½æ•°>2ã€æ„é€ å‡½æ•°</a><ul><li><a href=#21-å†…å­˜å¯¹é½è¯´æ˜>2.1 å†…å­˜å¯¹é½è¯´æ˜ï¼š</a></li></ul></li><li><a href=#3å†™æ“ä½œ>3ã€å†™æ“ä½œ</a><ul><li><a href=#31-å‚æ•°è§£é‡Š>3.1 å‚æ•°è§£é‡Šï¼š</a></li><li><a href=#32-æ•´ä½“æµç¨‹>3.2 æ•´ä½“æµç¨‹</a><ul><li><a href=#321-send-å‡½æ•°>3.2.1 send å‡½æ•°</a></li><li><a href=#322-keeplive-å‡½æ•°è¯´æ˜>3.2.2 KeepLive å‡½æ•°è¯´æ˜</a></li></ul></li></ul></li><li><a href=#4è¯»æ“ä½œ>4ã€è¯»æ“ä½œ</a><ul><li><a href=#41-å‚æ•°è§£é‡Š>4.1 å‚æ•°è§£é‡Š</a></li><li><a href=#42-æ•´ä½“æµç¨‹>4.2 æ•´ä½“æµç¨‹</a><ul><li><a href=#421-recv-å‡½æ•°>4.2.1 recv å‡½æ•°</a></li></ul></li></ul></li><li><a href=#5å…³é—­-chan>5ã€å…³é—­ chan</a><ul><li><a href=#51-å…³é”®å…¥å£ä¸æ‰§è¡Œè·¯å¾„>5.1 å…³é”®å…¥å£ä¸æ‰§è¡Œè·¯å¾„</a></li><li><a href=#52-æµç¨‹>5.2 æµç¨‹</a></li></ul></li><li><a href=#6å…¶ä»–è¡¥å……çŸ¥è¯†>6ã€å…¶ä»–è¡¥å……çŸ¥è¯†</a><ul><li><a href=#61-sudog>6.1 sudog</a></li><li><a href=#62-chanrecv-ä¸-chansend-çš„å¿«é€Ÿè·¯å¾„åˆ¤æ–­>6.2 chanrecv ä¸ chansend çš„å¿«é€Ÿè·¯å¾„åˆ¤æ–­</a></li><li><a href=#63-é˜»å¡æ¨¡å¼ä¸-éé˜»å¡æ¨¡å¼>6.3 é˜»å¡æ¨¡å¼ä¸ éé˜»å¡æ¨¡å¼</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>åŸºäº go1.22.6 æºç è§£æ channel åº•å±‚æºç </p><h1 id=1å†…éƒ¨æ•°æ®ç»“æ„>1ã€å†…éƒ¨æ•°æ®ç»“æ„</h1><p>æ‰€åœ¨ä½ç½®<code>/usr/local/go/src/runtime/chan.go</code></p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>hchan</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>qcount</span><span class=w>   </span><span class=kt>uint</span><span class=w>           </span><span class=c1>// å½“å‰channelä¸­å­˜åœ¨å…ƒç´ çš„æ•°é‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>dataqsiz</span><span class=w> </span><span class=kt>uint</span><span class=w>           </span><span class=c1>// å½“å‰channelç¯å½¢é˜Ÿåˆ—çš„å®¹é‡ï¼ˆbuffered channel çš„å¤§å°ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>buf</span><span class=w>      </span><span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span><span class=w> </span><span class=c1>// ç¯å½¢é˜Ÿåˆ—çš„æŒ‡é’ˆï¼ˆå­˜å‚¨å…ƒç´ çš„åœ°æ–¹ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>elemsize</span><span class=w> </span><span class=kt>uint16</span><span class=w>			</span><span class=c1>// channelä¸­æ¯ä¸ªå…ƒç´ çš„å¤§å°</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>closed</span><span class=w>   </span><span class=kt>uint32</span><span class=w>			</span><span class=c1>// è¡¨ç¤º channel æ˜¯å¦å·²å…³é—­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>elemtype</span><span class=w> </span><span class=o>*</span><span class=nx>_type</span><span class=w> </span><span class=c1>// channelä¸­å…ƒç´ ç±»å‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>sendx</span><span class=w>    </span><span class=kt>uint</span><span class=w>   </span><span class=c1>// ç¯å½¢é˜Ÿåˆ—çš„å‘é€ç´¢å¼•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>recvx</span><span class=w>    </span><span class=kt>uint</span><span class=w>   </span><span class=c1>// ç¯å½¢é˜Ÿåˆ—çš„æ¥æ”¶ç´¢å¼•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>recvq</span><span class=w>    </span><span class=nx>waitq</span><span class=w>  </span><span class=c1>// ç­‰å¾…æ¥æ”¶çš„ goroutine é˜Ÿåˆ—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>sendq</span><span class=w>    </span><span class=nx>waitq</span><span class=w>  </span><span class=c1>// ç­‰å¾…å‘é€çš„ goroutine é˜Ÿåˆ—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// lock protects all fields in hchan, as well as several</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// fields in sudogs blocked on this channel.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>	// Do not change another G&#39;s status while holding this lock</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// (in particular, do not ready a G), as this can deadlock</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// with stack shrinking.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>lock</span><span class=w> </span><span class=nx>mutex</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>waitq</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>first</span><span class=w> </span><span class=o>*</span><span class=nx>sudog</span><span class=w>	</span><span class=c1>// é˜Ÿåˆ—å¤´éƒ¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>last</span><span class=w>  </span><span class=o>*</span><span class=nx>sudog</span><span class=w>	</span><span class=c1>// é˜Ÿåˆ—å°¾éƒ¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// sudog æ˜¯ä¸€ä¸ª ä¼ªgï¼Œè¡¨ç¤ºç­‰å¾…åˆ—è¡¨ä¸­çš„ gï¼Œç”¨äºåŒ…è£…åç¨‹çš„èŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// ä¸€ä¸ª g å¯ä»¥å‡ºç°åœ¨å¤šä¸ªç­‰å¾…åˆ—è¡¨ä¸­ï¼Œå› æ­¤ä¸€ä¸ª g å¯èƒ½æœ‰å¤šä¸ª sudogï¼›</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// å¹¶ä¸”å¾ˆå¤šgså¯èƒ½åœ¨ç­‰å¾…åŒä¸€ä¸ªåŒæ­¥å¯¹è±¡ï¼Œå› æ­¤ä¸€ä¸ªå¯¹è±¡å¯èƒ½æœ‰å¾ˆå¤šsudogã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>sudog</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// The following fields are protected by the hchan.lock of the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// channel this sudog is blocking on. shrinkstack depends on</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// this for sudogs involved in channel ops.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>g</span><span class=w> </span><span class=o>*</span><span class=nx>g</span><span class=w>	</span><span class=c1>// åç¨‹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>next</span><span class=w> </span><span class=o>*</span><span class=nx>sudog</span><span class=w> </span><span class=c1>// é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>prev</span><span class=w> </span><span class=o>*</span><span class=nx>sudog</span><span class=w> </span><span class=c1>// é˜Ÿåˆ—ä¸­çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>elem</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span><span class=w> </span><span class=c1>// data element (may point to stack)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>c</span><span class=w>        </span><span class=o>*</span><span class=nx>hchan</span><span class=w> </span><span class=c1>// æ ‡è¯†ä¸å½“å‰sudogäº¤äº’çš„channel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><a class=lightgallery href=../images/chan%e5%86%85%e9%83%a8%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84.png title=img data-thumbnail=../images/chanå†…éƒ¨æ•°æ®ç»“æ„.png><img class=lazyload src=/svg/loading.min.svg data-src=../images/chan%e5%86%85%e9%83%a8%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84.png data-srcset="../images/chan%e5%86%85%e9%83%a8%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84.png, ../images/chan%e5%86%85%e9%83%a8%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84.png 1.5x, ../images/chan%e5%86%85%e9%83%a8%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84.png 2x" data-sizes=auto alt=../images/chanå†…éƒ¨æ•°æ®ç»“æ„.png></a></p><h1 id=2æ„é€ å‡½æ•°>2ã€æ„é€ å‡½æ•°</h1><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>makechan</span><span class=p>(</span><span class=nx>t</span><span class=w> </span><span class=o>*</span><span class=nx>chantype</span><span class=p>,</span><span class=w> </span><span class=nx>size</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>hchan</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>elem</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>t</span><span class=p>.</span><span class=nx>Elem</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// compiler checks this but be safe.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>elem</span><span class=p>.</span><span class=nx>Size_</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=mi>16</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>throw</span><span class=p>(</span><span class=s>&#34;makechan: invalid channel element type&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>hchanSize</span><span class=o>%</span><span class=nx>maxAlign</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>elem</span><span class=p>.</span><span class=nx>Align_</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=nx>maxAlign</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>throw</span><span class=p>(</span><span class=s>&#34;makechan: bad alignment&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>mem</span><span class=p>,</span><span class=w> </span><span class=nx>overflow</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>math</span><span class=p>.</span><span class=nf>MulUintptr</span><span class=p>(</span><span class=nx>elem</span><span class=p>.</span><span class=nx>Size_</span><span class=p>,</span><span class=w> </span><span class=nb>uintptr</span><span class=p>(</span><span class=nx>size</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>overflow</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>mem</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=nx>maxAlloc</span><span class=o>-</span><span class=nx>hchanSize</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>size</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nb>panic</span><span class=p>(</span><span class=nf>plainError</span><span class=p>(</span><span class=s>&#34;makechan: size out of range&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Hchan does not contain pointers interesting for GC when elements stored in buf do not contain pointers.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// buf points into the same allocation, elemtype is persistent.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// SudoG&#39;s are referenced from their owning thread so they can&#39;t be collected.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// TODO(dvyukov,rlh): Rethink when collector can move allocated objects.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>var</span><span class=w> </span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>hchan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>switch</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>case</span><span class=w> </span><span class=nx>mem</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// Queue or element size is zero.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>hchan</span><span class=p>)(</span><span class=nf>mallocgc</span><span class=p>(</span><span class=nx>hchanSize</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// Race detector uses this location for synchronization.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=p>.</span><span class=nx>buf</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nf>raceaddr</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>case</span><span class=w> </span><span class=nx>elem</span><span class=p>.</span><span class=nx>PtrBytes</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// Elements do not contain pointers.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// Allocate hchan and buf in one call.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>hchan</span><span class=p>)(</span><span class=nf>mallocgc</span><span class=p>(</span><span class=nx>hchanSize</span><span class=o>+</span><span class=nx>mem</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=p>.</span><span class=nx>buf</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>add</span><span class=p>(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=nx>c</span><span class=p>),</span><span class=w> </span><span class=nx>hchanSize</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// Elements contain pointers.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>new</span><span class=p>(</span><span class=nx>hchan</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=p>.</span><span class=nx>buf</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>mallocgc</span><span class=p>(</span><span class=nx>mem</span><span class=p>,</span><span class=w> </span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemsize</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>uint16</span><span class=p>(</span><span class=nx>elem</span><span class=p>.</span><span class=nx>Size_</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>elem</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>.</span><span class=nx>dataqsiz</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>uint</span><span class=p>(</span><span class=nx>size</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>lockInit</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>lock</span><span class=p>,</span><span class=w> </span><span class=nx>lockRankHchan</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>debugChan</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nb>print</span><span class=p>(</span><span class=s>&#34;makechan: chan=&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=s>&#34;; elemsize=&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>elem</span><span class=p>.</span><span class=nx>Size_</span><span class=p>,</span><span class=w> </span><span class=s>&#34;; dataqsiz=&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>size</span><span class=p>,</span><span class=w> </span><span class=s>&#34;\n&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>1ï¼‰æ ¡éªŒå…ƒç´ å¤§å°å’Œå†…å­˜å¯¹é½ï¼Œæ£€æŸ¥å…ƒç´ çš„å¯¹é½éœ€æ±‚æ˜¯å¦è¶…è¿‡é€šé“æ”¯æŒçš„æœ€å¤§å¯¹é½ï¼ˆ8 å­—èŠ‚ï¼‰ã€‚</p><p>2ï¼‰æ ¡éªŒå†…å­˜éœ€æ±‚æ˜¯å¦è¶…é™</p><ul><li><code>mem = elem.Size_ * uintptr(size)</code>ï¼šè®¡ç®—ç¯å½¢é˜Ÿåˆ—æ€»çš„å†…å­˜éœ€æ±‚ï¼›<code>overflow</code>ï¼šæ£€æŸ¥æ˜¯å¦å‘ç”Ÿæ•´æ•°æº¢å‡º</li><li><code>overflow</code>ï¼šå¦‚æœå†…å­˜æº¢å‡ºï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</li><li><code>mem > maxAlloc-hchanSize</code>ï¼šå¦‚æœæ€»å†…å­˜éœ€æ±‚è¶…è¿‡å¯åˆ†é…çš„æœ€å¤§å€¼ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</li><li><code>size &lt; 0</code>ï¼šå¦‚æœé€šé“çš„å®¹é‡æ˜¯è´Ÿæ•°ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</li></ul><p>3ï¼‰æŒ‰ç…§ä¸‰ç§æ ¼å¼åˆ†é…å†…å­˜ï¼Œä¸‰ç§æ–¹å¼éƒ½æŒ‡å®šäº†åˆ†é…çš„å†…å­˜ä¸åŒ…å«æŒ‡é’ˆï¼Œé¿å… gc æ‰«æè¿™å—å†…å­˜ï¼š</p><ul><li>1ã€æ— ç¼“å†²é€šé“ï¼šä»…åˆ†é… hchanSize</li><li>2ã€æœ‰ç¼“å†²çš„ struct ç±»å‹ï¼šåŒæ—¶åˆ†é… <code>hchanSize</code> å’Œç¯å½¢ç¼“å†²åŒºçš„å†…å­˜ï¼Œä¼˜åŒ–åˆ†é…æ€§èƒ½ï¼Œå¹¶ä¸”è°ƒæ•´ chan çš„ buf æŒ‡å‘ mem çš„èµ·å§‹ä½ç½®ï¼›æ­¤æ—¶ä¸¤è€…æ˜¯è¿ç»­çš„ï¼Œåœ¨ä¸€å—è¿ç»­çš„å†…å­˜ä¸­ï¼›å…¶ä¸­ <code>mallocgc</code> å‚æ•° nil è¡¨ç¤ºå†…å­˜ä¸­ä¸åŒ…å«æŒ‡é’ˆï¼ŒGC ä¸éœ€è¦æ‰«æè¿™å—å†…å­˜ï¼Œå¦‚æœç¼“å†²åŒºä¸­å­˜å‚¨çš„å…ƒç´ åŒ…å«æŒ‡é’ˆï¼Œåˆ™ä¼šä¼ é€’å…ƒç´ ç±»å‹ä¿¡æ¯ï¼ˆé nilï¼‰ã€‚</li><li>3ã€æœ‰ç¼“å†²çš„æŒ‡é’ˆç±»å‹ï¼šåˆ†åˆ«åˆ†é… <code>hchanSize</code> å’Œç¯å½¢ç¼“å†²åŒºçš„å†…å­˜ã€‚ä¸¤è€…æ— éœ€è¿ç»­ï¼Œ<code>mallocgc</code> å‚æ•°éœ€è¦æŒ‡å®šå…ƒç´ ç±»å‹ï¼Œæ¯”å¦‚è¿™é‡Œçš„<code>c.buf = mallocgc(mem, elem, true)</code>ã€‚</li></ul><p>4ï¼‰å¯¹ channel çš„å…¶ä½™å­—æ®µè¿›è¡Œåˆå§‹åŒ–ï¼ŒåŒ…æ‹¬å…ƒç´ ç±»å‹å¤§å°ã€å…ƒç´ ç±»å‹ã€å®¹é‡ä»¥åŠé”çš„åˆå§‹åŒ–ã€‚</p><h2 id=21-å†…å­˜å¯¹é½è¯´æ˜>2.1 å†…å­˜å¯¹é½è¯´æ˜ï¼š</h2><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>maxAlign</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>hchanSize</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Sizeof</span><span class=p>(</span><span class=nx>hchan</span><span class=p>{})</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>uintptr</span><span class=p>(</span><span class=o>-</span><span class=nb>int</span><span class=p>(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Sizeof</span><span class=p>(</span><span class=nx>hchan</span><span class=p>{}))</span><span class=o>&amp;</span><span class=p>(</span><span class=nx>maxAlign</span><span class=o>-</span><span class=mi>1</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=nx>hchanSize</span><span class=o>%</span><span class=nx>maxAlign</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>elem</span><span class=p>.</span><span class=nx>Align_</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=nx>maxAlign</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>throw</span><span class=p>(</span><span class=s>&#34;makechan: bad alignment&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><ol><li><strong>maxAlign = 8</strong>:</li></ol><ul><li><ul><li>æœ€å¤§å¯¹é½å€¼ï¼Œé€šé“çš„ç»“æ„ä½“éœ€è¦å¯¹é½åˆ° 8 å­—èŠ‚çš„è¾¹ç•Œã€‚</li><li>è¿™æ˜¯ Go ä¸­çš„é€šç”¨å†…å­˜å¯¹é½ç­–ç•¥ï¼Œé’ˆå¯¹ 64 ä½æ¶æ„ã€‚</li></ul></li></ul><ol><li><strong>unsafe.Sizeof(hchan{})</strong>:</li></ol><ul><li><ul><li>è®¡ç®— <code>hchan</code> ç»“æ„ä½“çš„å¤§å°ã€‚</li><li>è¿™éƒ¨åˆ†æ˜¯æœªå¯¹é½çš„å¤§å°ã€‚</li></ul></li></ul><ol><li><strong>å¯¹é½è®¡ç®—</strong>ï¼š</li></ol><ul><li><ul><li><code>uintptr(-int(unsafe.Sizeof(hchan{})) & (maxAlign-1))</code>æ˜¯ç”¨äºå¯¹é½çš„ä½æ“ä½œã€‚</li><li>å®ƒç¡®ä¿ <code>hchanSize</code>æ˜¯<code> maxAlign</code> çš„å€æ•°ã€‚</li></ul></li></ul><p>å‡è®¾<code>unsafe.Sizeof(hchan{})=70</code>ï¼Œåˆ™<code>uintptr(-int(unsafe.Sizeof(hchan{}))&(maxAlign-1)) = -70 & 7</code></p><ol><li><strong>-70 çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼ˆä»¥è¡¥ç å½¢å¼è¡¨ç¤ºï¼‰ï¼š</strong></li></ol><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-powershell"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>åŸç </span><span class=err>ï¼ˆ</span><span class=mf>70</span><span class=err>ï¼‰ï¼š</span>     <span class=mf>0000</span> <span class=mf>0000</span> <span class=mf>0000</span> <span class=mf>0000</span> <span class=mf>0000</span> <span class=mf>0000</span> <span class=mf>0100</span> <span class=mf>0110</span>
</span></span><span class=line><span class=cl><span class=n>åç </span><span class=err>ï¼ˆ</span><span class=n>å–å</span><span class=err>ï¼‰ï¼š</span>    <span class=mf>1111</span> <span class=mf>1111</span> <span class=mf>1111</span> <span class=mf>1111</span> <span class=mf>1111</span> <span class=mf>1111</span> <span class=mf>1011</span> <span class=mf>1001</span>
</span></span><span class=line><span class=cl><span class=n>è¡¥ç </span><span class=err>ï¼ˆ</span><span class=mf>+1</span><span class=err>ï¼‰ï¼š</span>     <span class=mf>1111</span> <span class=mf>1111</span> <span class=mf>1111</span> <span class=mf>1111</span> <span class=mf>1111</span> <span class=mf>1111</span> <span class=mf>1011</span> <span class=mf>1010</span><span class=err>ï¼ˆ</span><span class=n>å³</span> <span class=mf>-70</span><span class=err>ï¼‰</span></span></span></code></pre></div></div><ol><li><strong>æ©ç ï¼ˆ7 çš„äºŒè¿›åˆ¶ï¼‰ï¼š</strong></li></ol><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-shell"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0111</span></span></span></code></pre></div></div><ol><li><strong>æŒ‰ä½ä¸ï¼š</strong></li></ol><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-shell"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=m>1111</span> <span class=m>1111</span> <span class=m>1111</span> <span class=m>1111</span> <span class=m>1111</span> <span class=m>1111</span> <span class=m>1011</span> <span class=m>1010</span>
</span></span><span class=line><span class=cl><span class=p>&amp;</span>
</span></span><span class=line><span class=cl><span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0111</span>
</span></span><span class=line><span class=cl>---------------------------------------
</span></span><span class=line><span class=cl><span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0000</span> <span class=m>0010</span></span></span></code></pre></div></div><p>ç»“æœä¸º 2ï¼Œè¡¨ç¤ºéœ€è¦è¡¥é½ <strong>2 å­—èŠ‚</strong>ã€‚å¯¹é½åçš„ <code>hchanSize</code> æ˜¯ 72ï¼Œæ˜¯ <strong>8 çš„æ•´æ•°å€</strong>ï¼Œç¬¦åˆå¯¹é½è¦æ±‚ã€‚</p><h1 id=3å†™æ“ä½œ>3ã€å†™æ“ä½œ</h1><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=cp>//go:nosplit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>chansend1</span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>hchan</span><span class=p>,</span><span class=w> </span><span class=nx>elem</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>chansend</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=nf>getcallerpc</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>chansend</span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>hchan</span><span class=p>,</span><span class=w> </span><span class=nx>ep</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span><span class=p>,</span><span class=w> </span><span class=nx>block</span><span class=w> </span><span class=kt>bool</span><span class=p>,</span><span class=w> </span><span class=nx>callerpc</span><span class=w> </span><span class=kt>uintptr</span><span class=p>)</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¼‚å¸¸case1:é€šé“æœªåˆå§‹åŒ–ï¼Œå¾€é‡Œå†™ä¼šè¢«æŒ‚èµ·ï¼Œæ­»é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>block</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>gopark</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>waitReasonChanSendNilChan</span><span class=p>,</span><span class=w> </span><span class=nx>traceBlockForever</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>throw</span><span class=p>(</span><span class=s>&#34;unreachable&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>debugChan</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>print</span><span class=p>(</span><span class=s>&#34;chansend: chan=&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=s>&#34;\n&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>raceenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>racereadpc</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nf>raceaddr</span><span class=p>(),</span><span class=w> </span><span class=nx>callerpc</span><span class=p>,</span><span class=w> </span><span class=nx>abi</span><span class=p>.</span><span class=nf>FuncPCABIInternal</span><span class=p>(</span><span class=nx>chansend</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Fast path: check for failed non-blocking operation without acquiring the lock.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>block</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>closed</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nf>full</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>t0</span><span class=w> </span><span class=kt>int64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>blockprofilerate</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>t0</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>cputicks</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>lock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>lock</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¼‚å¸¸case2:å¾€å…³é—­äº†çš„é€šé“ä¸­å†™ï¼Œpanic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>closed</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>lock</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>panic</span><span class=p>(</span><span class=nf>plainError</span><span class=p>(</span><span class=s>&#34;send on closed channel&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ­£å¸¸case1: ç­‰å¾…æ¥æ”¶çš„ goroutine é˜Ÿåˆ—ä¸ä¸ºç©º</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>sg</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>recvq</span><span class=p>.</span><span class=nf>dequeue</span><span class=p>();</span><span class=w> </span><span class=nx>sg</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Found a waiting receiver. We pass the value we want to send</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// directly to the receiver, bypassing the channel buffer (if any).</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>send</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>sg</span><span class=p>,</span><span class=w> </span><span class=nx>ep</span><span class=p>,</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nf>unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>lock</span><span class=p>)</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=mi>3</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ­£å¸¸case2: ç¼“å†²åŒºè¿˜æœ‰ç©ºé—´ï¼Œæ‰¾åˆ°sendxæ‰€åœ¨ä½ç½®å°†æ•°æ®å‘é€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>qcount</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>dataqsiz</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Space is available in the channel buffer. Enqueue the element to send.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>qp</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>chanbuf</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>sendx</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>raceenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nf>racenotify</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>sendx</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>typedmemmove</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span><span class=w> </span><span class=nx>qp</span><span class=p>,</span><span class=w> </span><span class=nx>ep</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>c</span><span class=p>.</span><span class=nx>sendx</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>sendx</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>dataqsiz</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>c</span><span class=p>.</span><span class=nx>sendx</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>c</span><span class=p>.</span><span class=nx>qcount</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>lock</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ­£å¸¸case3: æ­¤æ—¶è¯´æ˜æ²¡æœ‰ç­‰å¾…æ¥æ”¶çš„gï¼Œç¼“å†²åŒºä¹Ÿæ²¡æœ‰ç©ºé—´ï¼ˆæˆ–æ— ç¼“å†²channelï¼‰ï¼Œéé˜»å¡æ¨¡å¼ç›´æ¥è¿”å›</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>block</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>lock</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ­£å¸¸case4: è¿›å…¥é˜»å¡æ¨¡å¼ï¼Œgoparkè®©å‡ºåç¨‹çš„è°ƒåº¦æƒ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Block on the channel. Some receiver will complete our operation for us.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>gp</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>getg</span><span class=p>()</span><span class=w>	</span><span class=c1>// ä»çº¿ç¨‹çš„å±€éƒ¨å­˜å‚¨TLSä¸­è·å–å½“å‰gçš„æŒ‡é’ˆ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>mysg</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>acquireSudog</span><span class=p>()</span><span class=w>  </span><span class=c1>// å‡†å¤‡ä¸€ä¸ªä¼ªgï¼Œä»£è¡¨å¤„äºç­‰å¾…åˆ—è¡¨ä¸­çš„ g</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>mysg</span><span class=p>.</span><span class=nx>releasetime</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>t0</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>mysg</span><span class=p>.</span><span class=nx>releasetime</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=o>-</span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// No stack splits between assigning elem and enqueuing mysg</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// on gp.waiting where copystack can find it.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>mysg</span><span class=p>.</span><span class=nx>elem</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>ep</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>mysg</span><span class=p>.</span><span class=nx>waitlink</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>mysg</span><span class=p>.</span><span class=nx>g</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>gp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>mysg</span><span class=p>.</span><span class=nx>isSelect</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>mysg</span><span class=p>.</span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>gp</span><span class=p>.</span><span class=nx>waiting</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>mysg</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>gp</span><span class=p>.</span><span class=nx>param</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>c</span><span class=p>.</span><span class=nx>sendq</span><span class=p>.</span><span class=nf>enqueue</span><span class=p>(</span><span class=nx>mysg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Signal to anyone trying to shrink our stack that we&#39;re about</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// to park on a channel. The window between when this G&#39;s status</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// changes and when we set gp.activeStackChans is not safe for</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// stack shrinking.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>gp</span><span class=p>.</span><span class=nx>parkingOnChan</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>gopark</span><span class=p>(</span><span class=nx>chanparkcommit</span><span class=p>,</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>lock</span><span class=p>),</span><span class=w> </span><span class=nx>waitReasonChanSend</span><span class=p>,</span><span class=w> </span><span class=nx>traceBlockChanSend</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Ensure the value being sent is kept alive until the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// receiver copies it out. The sudog has a pointer to the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// stack object, but sudogs aren&#39;t considered as roots of the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// stack tracer.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>KeepAlive</span><span class=p>(</span><span class=nx>ep</span><span class=p>)</span><span class=w>  </span><span class=c1>// ä¸»è¦åŠŸèƒ½æ˜¯ç¡®ä¿ä¸€ä¸ªå˜é‡åœ¨è°ƒç”¨ç‚¹ä¹‹å‰ä¸ä¼šè¢« GC å›æ”¶</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// someone woke us up.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>mysg</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nx>gp</span><span class=p>.</span><span class=nx>waiting</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>throw</span><span class=p>(</span><span class=s>&#34;G waiting list is corrupted&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>gp</span><span class=p>.</span><span class=nx>waiting</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>gp</span><span class=p>.</span><span class=nx>activeStackChans</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>closed</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=p>!</span><span class=nx>mysg</span><span class=p>.</span><span class=nx>success</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>gp</span><span class=p>.</span><span class=nx>param</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>mysg</span><span class=p>.</span><span class=nx>releasetime</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>blockevent</span><span class=p>(</span><span class=nx>mysg</span><span class=p>.</span><span class=nx>releasetime</span><span class=o>-</span><span class=nx>t0</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>mysg</span><span class=p>.</span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>releaseSudog</span><span class=p>(</span><span class=nx>mysg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>closed</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>closed</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nf>throw</span><span class=p>(</span><span class=s>&#34;chansend: spurious wakeup&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>panic</span><span class=p>(</span><span class=nf>plainError</span><span class=p>(</span><span class=s>&#34;send on closed channel&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><a class=lightgallery href=../images/chan%e5%86%99%e6%93%8d%e4%bd%9c.png title=img data-thumbnail=../images/chanå†™æ“ä½œ.png><img class=lazyload src=/svg/loading.min.svg data-src=../images/chan%e5%86%99%e6%93%8d%e4%bd%9c.png data-srcset="../images/chan%e5%86%99%e6%93%8d%e4%bd%9c.png, ../images/chan%e5%86%99%e6%93%8d%e4%bd%9c.png 1.5x, ../images/chan%e5%86%99%e6%93%8d%e4%bd%9c.png 2x" data-sizes=auto alt=../images/chanå†™æ“ä½œ.png></a></p><p>é˜»å¡å‘é€ï¼š</p><p><a class=lightgallery href=../images/chan%e9%98%bb%e5%a1%9e%e5%8f%91%e9%80%81.png title=img data-thumbnail=../images/chané˜»å¡å‘é€.png><img class=lazyload src=/svg/loading.min.svg data-src=../images/chan%e9%98%bb%e5%a1%9e%e5%8f%91%e9%80%81.png data-srcset="../images/chan%e9%98%bb%e5%a1%9e%e5%8f%91%e9%80%81.png, ../images/chan%e9%98%bb%e5%a1%9e%e5%8f%91%e9%80%81.png 1.5x, ../images/chan%e9%98%bb%e5%a1%9e%e5%8f%91%e9%80%81.png 2x" data-sizes=auto alt=../images/chané˜»å¡å‘é€.png></a></p><h2 id=31-å‚æ•°è§£é‡Š>3.1 å‚æ•°è§£é‡Šï¼š</h2><ul><li><p><strong>c *hchan</strong>ï¼šæŒ‡å‘é€šé“çš„å†…éƒ¨ç»“æ„ã€‚</p></li><li><p><strong>ep unsafe.Pointer</strong>ï¼šå¾…å‘é€çš„æ•°æ®åœ°å€ã€‚</p></li><li><p><strong>block bool</strong>ï¼šæ˜¯å¦é˜»å¡å‘é€æ“ä½œï¼š</p></li><li><ul><li>trueï¼šé˜»å¡æ“ä½œç›´åˆ°æ•°æ®å‘é€æˆåŠŸã€‚</li><li>falseï¼šéé˜»å¡æ“ä½œï¼Œå¦‚æœæ— æ³•å‘é€ç«‹å³è¿”å›ã€‚</li></ul></li><li><p><strong>callerpc uintptr</strong>ï¼šè°ƒç”¨è€…çš„ç¨‹åºè®¡æ•°å™¨ï¼ˆç”¨äºç«æ€æ£€æµ‹ï¼‰ã€‚</p></li></ul><h2 id=32-æ•´ä½“æµç¨‹>3.2 æ•´ä½“æµç¨‹</h2><p>1ï¼‰å¯¹äºæœªåˆå§‹åŒ–çš„ chan</p><ul><li>éé˜»å¡æ¨¡å¼ç›´æ¥è¿”å› falseã€‚</li><li>é˜»å¡æ¨¡å¼è°ƒç”¨ gopark å°†å½“å‰ Goroutine æ°¸ä¹…æŒ‚èµ·ï¼ˆå› ä¸ºå¯¹ nil é€šé“çš„å‘é€æ— æ³•å®Œæˆï¼‰ã€‚</li></ul><p>2ï¼‰å¦‚æœå¯ç”¨äº†ç«æ€æ£€æµ‹ï¼Œè®°å½•å¯¹é€šé“çš„è¯»å–æ“ä½œï¼Œç”¨äºåç»­åˆ†æã€‚</p><p>3ï¼‰éé˜»å¡æ¨¡å¼çš„å¿«é€Ÿè·¯å¾„</p><ul><li><p><strong>éé˜»å¡æ¨¡å¼</strong>ï¼š</p></li><li><ul><li>å¦‚æœé€šé“æœªå…³é—­ï¼ˆc.closed == 0ï¼‰ä¸”ç¼“å†²åŒºå·²æ»¡ï¼ˆ<code>full(c)</code>ï¼‰ï¼Œç›´æ¥è¿”å› falseï¼Œè¡¨ç¤ºå‘é€å¤±è´¥ã€‚</li></ul></li><li><p><strong>ä¼˜åŒ–ç‚¹</strong>ï¼š</p></li><li><ul><li>é€šè¿‡å¿«é€Ÿè·¯å¾„é¿å…é”ç«äº‰ï¼Œæé«˜æ€§èƒ½ã€‚</li></ul></li></ul><p>4ï¼‰å¦‚æœå¯ç”¨äº†æ€§èƒ½åˆ†æï¼ˆ<code>blockprofilerate > 0</code>ï¼‰ï¼Œè®°å½•å½“å‰ CPU æ—¶é—´æˆ³ï¼ˆ<code>cputicks()</code>ï¼‰ï¼Œä»¥ä¾¿åç»­åˆ†æé˜»å¡æ—¶é—´ã€‚</p><p>5ï¼‰åŠ é”</p><p>6ï¼‰å¯¹å·²å…³é—­çš„ channel å†™å…¥ï¼Œä¼šè§¦å‘ panic</p><p>7ï¼‰å¦‚æœæ¥æ”¶é˜Ÿåˆ—ä¸­å­˜åœ¨ç­‰å¾…æ¥æ”¶çš„ Goroutineï¼ˆ<code>recvq</code> éç©ºï¼‰ï¼Œè°ƒç”¨ <code>send</code> å°†æ•°æ®ç›´æ¥å‘é€ç»™æ¥æ”¶ Goroutineï¼Œè·³è¿‡é€šé“ç¼“å†²åŒºï¼Œç›´æ¥å®Œæˆå‘é€æ“ä½œã€‚</p><p>8ï¼‰å¦‚æœç¼“å†²åŒºæœªæ»¡ï¼ˆ<code>c.qcount &lt; c.dataqsiz</code>ï¼‰ï¼š</p><ul><li><ul><li>å°†æ•°æ®å†™å…¥ç¼“å†²åŒºï¼ˆ<code>chanbuf(c, c.sendx)</code> æŒ‡å‘ç¼“å†²åŒºçš„å‘é€ä½ç½®ï¼‰</li><li>æ›´æ–°å‘é€ç´¢å¼•ï¼ˆ<code>c.sendx</code>ï¼‰ï¼Œå¹¶ç»´æŠ¤ç¯å½¢é˜Ÿåˆ—</li><li>å¢åŠ å…ƒç´ è®¡æ•°ï¼ˆ<code>c.qcount++</code>ï¼‰</li><li>è§£é”å¹¶è¿”å› trueï¼Œè¡¨ç¤ºå‘é€æˆåŠŸ</li></ul></li></ul><p>9ï¼‰éé˜»å¡æ¨¡å¼ï¼Œä¸”æ— æ³•å‘é€ï¼ˆæ¥æ”¶é˜Ÿåˆ—ä¸ºç©ºï¼Œç¼“å†²åŒºå·²æ»¡ï¼‰ï¼Œè§£é”å¹¶è¿”å› false</p><p>10ï¼‰æ¥ä¸‹æ¥è¿›å…¥ï¼Œé˜»å¡æ¨¡å¼ï¼Œé˜»å¡ä½ã€‚</p><ul><li><p><strong>å°†å½“å‰ Goroutine æŒ‚èµ·</strong>ï¼š</p></li><li><ul><li>è·å–ä¸€ä¸ª sudogï¼ˆä»£è¡¨å½“å‰ Goroutine çš„è°ƒåº¦æ•°æ®ç»“æ„ï¼‰ï¼Œå®ŒæˆæŒ‡é’ˆæŒ‡å‘ï¼Œå»ºç«‹ sudogã€goroutineã€channel ä¹‹é—´çš„æŒ‡å‘å…³ç³»</li><li>å°†å½“å‰ Goroutine æ”¾å…¥é€šé“çš„å‘é€é˜Ÿåˆ—ï¼ˆsendqï¼‰ï¼Œæ’å…¥é˜Ÿå°¾ã€‚</li><li>è°ƒç”¨ gopark æŒ‚èµ· Goroutineï¼Œç­‰å¾…æ¥æ”¶æ–¹å”¤é†’ã€‚</li></ul></li></ul><p>11ï¼‰å€˜è‹¥åç¨‹ä» park ä¸­è¢«å”¤é†’ï¼Œåˆ™å›æ”¶ sudogï¼ˆsudogèƒ½è¢«å”¤é†’ï¼Œå…¶å¯¹åº”çš„å…ƒç´ å¿…ç„¶å·²ç»è¢«è¯»åç¨‹å–èµ°ï¼‰ï¼›</p><p>12ï¼‰å”¤é†’åæ£€æŸ¥ï¼Œè‹¥é€šé“å…³é—­ï¼Œåˆ™ panic</p><p><a class=lightgallery href=../images/%e5%86%99chan%e6%b5%81%e7%a8%8b.png title=img data-thumbnail=../images/å†™chanæµç¨‹.png><img class=lazyload src=/svg/loading.min.svg data-src=../images/%e5%86%99chan%e6%b5%81%e7%a8%8b.png data-srcset="../images/%e5%86%99chan%e6%b5%81%e7%a8%8b.png, ../images/%e5%86%99chan%e6%b5%81%e7%a8%8b.png 1.5x, ../images/%e5%86%99chan%e6%b5%81%e7%a8%8b.png 2x" data-sizes=auto alt=../images/å†™chanæµç¨‹.png></a></p><h3 id=321-send-å‡½æ•°>3.2.1 send å‡½æ•°</h3><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>send</span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>hchan</span><span class=p>,</span><span class=w> </span><span class=nx>sg</span><span class=w> </span><span class=o>*</span><span class=nx>sudog</span><span class=p>,</span><span class=w> </span><span class=nx>ep</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span><span class=p>,</span><span class=w> </span><span class=nx>unlockf</span><span class=w> </span><span class=kd>func</span><span class=p>(),</span><span class=w> </span><span class=nx>skip</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>raceenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>dataqsiz</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nf>racesync</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>sg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// Pretend we go through the buffer, even though</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// we copy directly. Note that we need to increment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// the head/tail locations only when raceenabled.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nf>racenotify</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nf>racenotify</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=p>,</span><span class=w> </span><span class=nx>sg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>dataqsiz</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>c</span><span class=p>.</span><span class=nx>sendx</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=w> </span><span class=c1>// c.sendx = (c.sendx+1) % c.dataqsiz</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>sg</span><span class=p>.</span><span class=nx>elem</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>sendDirect</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span><span class=w> </span><span class=nx>sg</span><span class=p>,</span><span class=w> </span><span class=nx>ep</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>sg</span><span class=p>.</span><span class=nx>elem</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>gp</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>sg</span><span class=p>.</span><span class=nx>g</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>unlockf</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>gp</span><span class=p>.</span><span class=nx>param</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=nx>sg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>sg</span><span class=p>.</span><span class=nx>success</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>sg</span><span class=p>.</span><span class=nx>releasetime</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>sg</span><span class=p>.</span><span class=nx>releasetime</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>cputicks</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>goready</span><span class=p>(</span><span class=nx>gp</span><span class=p>,</span><span class=w> </span><span class=nx>skip</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>å‚æ•°è§£é‡Šï¼š</p><ul><li><strong>c *hchan</strong>ï¼šé€šé“ã€‚</li><li><strong>sg *sudog</strong>ï¼šæ¥æ”¶ Goroutine çš„è°ƒåº¦ç»“æ„ã€‚</li><li><strong>ep unsafe.Pointer</strong>ï¼šå¾…å‘é€æ•°æ®çš„åœ°å€ã€‚</li><li><strong>unlockf func()</strong>ï¼šé‡Šæ”¾é”çš„å›è°ƒå‡½æ•°ã€‚</li><li><strong>skip int</strong>ï¼šè°ƒç”¨å †æ ˆæ·±åº¦ï¼ˆç”¨äºè°ƒè¯•ï¼‰ã€‚</li></ul><p>1ï¼‰å¦‚æœå¼€å¯äº†ç«æ€æ£€æµ‹ï¼Œè®°å½•ç¼“å†²åŒºçš„è¯»å†™æ“ä½œ</p><p>2ï¼‰å¦‚æœæ¥æ”¶ Goroutine çš„ elem å­—æ®µä¸ä¸º nilï¼Œå°†æ•°æ®ç›´æ¥å¤åˆ¶åˆ°æ¥æ”¶æ–¹</p><p>3ï¼‰è§£é”åï¼Œè°ƒç”¨ goready å”¤é†’æ¥æ”¶ Goroutine å¹¶æ ‡è®°æ“ä½œæˆåŠŸ</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>sendDirect</span><span class=p>(</span><span class=nx>t</span><span class=w> </span><span class=o>*</span><span class=nx>_type</span><span class=p>,</span><span class=w> </span><span class=nx>sg</span><span class=w> </span><span class=o>*</span><span class=nx>sudog</span><span class=p>,</span><span class=w> </span><span class=nx>src</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// src is on our stack, dst is a slot on another stack.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Once we read sg.elem out of sg, it will no longer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// be updated if the destination&#39;s stack gets copied (shrunk).</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// So make sure that no preemption points can happen between read &amp; use.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// è¯»å–ç›®æ ‡åœ°å€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>dst</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>sg</span><span class=p>.</span><span class=nx>elem</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å†™å±éšœï¼Œé€šçŸ¥ GC ç›‘è§†ç›®æ ‡ä½ç½®çš„æ•°æ®å†™å…¥ï¼Œä»¥é˜²æ­¢åƒåœ¾å›æ”¶æœŸé—´çš„æ•°æ®ä¸¢å¤±æˆ–ä¸ä¸€è‡´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>typeBitsBulkBarrier</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span><span class=w> </span><span class=nb>uintptr</span><span class=p>(</span><span class=nx>dst</span><span class=p>),</span><span class=w> </span><span class=nb>uintptr</span><span class=p>(</span><span class=nx>src</span><span class=p>),</span><span class=w> </span><span class=nx>t</span><span class=p>.</span><span class=nx>Size_</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// No need for cgo write barrier checks because dst is always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Go memory.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å°†æ•°æ®ä» srcï¼ˆå‘é€æ–¹çš„æ ˆä½ç½®ï¼‰å¤åˆ¶åˆ° dstï¼ˆæ¥æ”¶æ–¹çš„æ ˆä½ç½®ï¼‰ã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>memmove</span><span class=p>(</span><span class=nx>dst</span><span class=p>,</span><span class=w> </span><span class=nx>src</span><span class=p>,</span><span class=w> </span><span class=nx>t</span><span class=p>.</span><span class=nx>Size_</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>sendDirect</code> æ˜¯ Go runtime ä¸­ç”¨äºå®ç°<strong>æ— ç¼“å†²é€šé“</strong>ï¼ˆunbuffered channelï¼‰æˆ–<strong>ç¼“å†²ä¸ºç©ºçš„é€šé“</strong>ä¸­çš„ç›´æ¥å‘é€æ“ä½œçš„ä½çº§å‡½æ•°ã€‚è¿™ç§ç›´æ¥å‘é€æ“ä½œçš„ç‰¹ç‚¹æ˜¯å‘é€æ–¹å’Œæ¥æ”¶æ–¹çš„ goroutine å¿…é¡»åä½œé…åˆï¼Œæ•°æ®ä»ä¸€ä¸ª goroutine çš„æ ˆä¸Šç›´æ¥ç§»åŠ¨åˆ°å¦ä¸€ä¸ª goroutine çš„æ ˆä¸Šã€‚</p><p>åœ¨ goroutine çš„æ ˆä¹‹é—´ç›´æ¥æ“ä½œå†…å­˜ï¼Œéœ€è¦ä¿è¯æ•°æ®ä¸€è‡´æ€§å’Œå®‰å…¨æ€§ï¼Œå°¤å…¶æ˜¯ï¼š</p><ol><li><strong>é˜²æ­¢æ•°æ®ç«äº‰ï¼š</strong>
é¿å…å› ä¸º goroutine æ ˆè¢«ç§»åŠ¨æˆ–è¢«é¢„å ï¼ˆå¦‚åœ¨åƒåœ¾å›æ”¶æˆ– goroutine è°ƒåº¦ä¸­ï¼‰è€Œå¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´ã€‚</li><li><strong>ä¿è¯åƒåœ¾å›æ”¶ï¼ˆGCï¼‰çš„æ­£ç¡®æ€§ï¼š</strong>
å› ä¸º GC å‡è®¾åªæœ‰å½“å‰ goroutine ä¼šå†™å…¥è‡ªå·±çš„æ ˆï¼Œè€Œæ­¤å‡½æ•°æ‰“ç ´äº†è¿™ä¸€å‡è®¾ï¼Œå› æ­¤éœ€è¦å¼•å…¥<strong>å†™å±éšœ</strong>ã€‚</li></ol><p><strong>ä¸ºä»€ä¹ˆéœ€è¦ç‰¹æ®Šå¤„ç†ï¼Ÿ</strong></p><p>åœ¨æ— ç¼“å†²é€šé“æˆ–ç¼“å†²ä¸ºç©ºçš„æƒ…å†µä¸‹ï¼š</p><ul><li>å‘é€å’Œæ¥æ”¶ goroutine éœ€è¦ç›´æ¥äº¤æ¢æ•°æ®ï¼Œç›´æ¥åœ¨ä¸¤ä¸ªæ ˆä¹‹é—´ç§»åŠ¨æ•°æ®æ¯”é€šè¿‡ä¸­é—´ç¼“å†²åŒºï¼ˆå¦‚å †åˆ†é…ï¼‰æ›´é«˜æ•ˆï¼Œå‡å°‘äº†å†…å­˜åˆ†é…å’Œå›æ”¶çš„å¼€é”€ã€‚ç‰¹åˆ«æ˜¯å¯¹äºæ— ç¼“å†²é€šé“ï¼ˆç›´æ¥ç‚¹å¯¹ç‚¹ä¼ é€’æ•°æ®ï¼‰æ¥è¯´ï¼Œç›´æ¥æ‹·è´æ˜¯æœ€å¿«çš„æ–¹å¼ã€‚</li><li>æ­¤æ“ä½œæ¶‰åŠç›´æ¥æ“ä½œä¸¤ä¸ª goroutine çš„æ ˆï¼Œè¿™ç§è¡Œä¸ºå¯¹åƒåœ¾å›æ”¶å™¨ï¼ˆGCï¼‰æ¥è¯´æ˜¯ç‰¹æ®Šçš„ï¼Œå› ä¸º GC å‡è®¾æ¯ä¸ª goroutine çš„æ ˆåªç”±è¯¥ goroutine è‡ªå·±å†™å…¥ã€‚</li></ul><p>åœ¨ <strong><code>sendDirect</code></strong> ä¸­ï¼Œ<strong><code>dst</code></strong> æ˜¯ç›®æ ‡ goroutine çš„æ ˆä¸Šçš„åœ°å€ã€‚ä¸ºäº†é¿å…å…¶ä»–å‡½æ•°æ“ä½œç›®æ ‡æ ˆå¹¶å¯¼è‡´åœ°å€ä¸ç¨³å®šï¼ŒGo è¿è¡Œæ—¶é‡‡å–äº†ä¸€äº›ä¸¥æ ¼çš„æªæ–½ã€‚è¿™äº›æªæ–½åŒ…æ‹¬é˜²æ­¢æ ˆçš„åŠ¨æ€è°ƒæ•´ï¼ˆå¦‚ä¼¸ç¼©æˆ–ç§»åŠ¨ï¼‰å½±å“å½“å‰çš„æ“ä½œã€‚ä»¥ä¸‹æ˜¯å¯èƒ½å¯¼è‡´æ ˆä¼¸ç¼©çš„æƒ…å†µï¼Œä»¥åŠä¸ºä»€ä¹ˆ <strong><code>sendDirect</code></strong> æ˜¯å®‰å…¨çš„ï¼š</p><ol><li><strong>æ ˆçš„åŠ¨æ€è°ƒæ•´</strong></li></ol><p>Go è¿è¡Œæ—¶æ”¯æŒ goroutine æ ˆçš„åŠ¨æ€è°ƒæ•´ï¼ˆå¢é•¿æˆ–æ”¶ç¼©ï¼‰ï¼Œä½†è¿™ç§è°ƒæ•´é€šå¸¸åœ¨ä»¥ä¸‹æƒ…å†µä¸‹å‘ç”Ÿï¼š</p><ul><li><strong>æ ˆä¸è¶³</strong>ï¼šå½“ goroutine åˆ†é…çš„æ ˆç©ºé—´ä¸è¶³æ—¶ï¼Œè¿è¡Œæ—¶ä¼šè§¦å‘æ ˆå¢é•¿ã€‚</li><li><strong>åƒåœ¾å›æ”¶</strong>ï¼šåƒåœ¾å›æ”¶æœŸé—´å¯èƒ½ä¼šç§»åŠ¨æ ˆä»¥å‹ç¼©å†…å­˜ã€‚</li></ul><p>åœ¨ <strong><code>sendDirect</code></strong> ä¸­ï¼Œ<strong><code>dst</code></strong> çš„åœ°å€é€šè¿‡ <strong><code>sudog.elem</code></strong> è·å–ã€‚å¦‚æœç›®æ ‡æ ˆåœ¨æ“ä½œæœŸé—´å‘ç”Ÿäº†åŠ¨æ€è°ƒæ•´ï¼Œé‚£ä¹ˆä¹‹å‰è·å–çš„ <strong><code>dst</code></strong> åœ°å€å¯èƒ½ä¼šå¤±æ•ˆã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong> <strong><code>sendDirect</code></strong> çš„è®¾è®¡ä¿è¯åœ¨è·å– <strong><code>dst</code></strong> åœ°å€åï¼Œç¡®ä¿æ“ä½œä¸å¯ä¸­æ–­ï¼ˆæ²¡æœ‰æŠ¢å ç‚¹ï¼‰ï¼Œç›´åˆ°æ•°æ®æ‹·è´å®Œæˆã€‚è¿™é¿å…äº†åœ¨æ ˆè°ƒæ•´è¿‡ç¨‹ä¸­ä½¿ç”¨æ— æ•ˆåœ°å€ã€‚</p><ol start=2><li><strong>å…¶ä»–å‡½æ•°æ˜¯å¦ä¼šæ“ä½œ <code>dst</code> çš„æ ˆï¼Ÿ</strong></li></ol><ul><li>é€šå¸¸ï¼Œåªæœ‰è¿è¡Œæ—¶æˆ–ç›®æ ‡ goroutine è‡ªå·±ä¼šæ“ä½œç›®æ ‡æ ˆã€‚å¸¸è§å‡½æ•°è°ƒç”¨ä¸ä¼šç›´æ¥å½±å“ç›®æ ‡æ ˆä¸Šçš„æ•°æ®ã€‚</li><li>åœ¨ sendDirect ä¸­ï¼Œè·¨æ ˆå†™æ“ä½œæ˜¯æ˜ç¡®è®¾è®¡çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶é€šè¿‡å†™å±éšœå’Œå†…å­˜ç®¡ç†å±éšœï¼ˆå¦‚ <strong><code>typeBitsBulkBarrier</code></strong>ï¼‰ç¡®ä¿æ ˆåœ°å€çš„æ­£ç¡®æ€§ã€‚</li></ul><ol start=3><li><strong>ä¸ºä½•å…¶ä»–å‡½æ•°ä¸ä¼šå¯¼è‡´é—®é¢˜ï¼Ÿ</strong></li></ol><ul><li><p><strong>éš”ç¦»æ€§</strong>ï¼šGo çš„ goroutine æ ˆæ˜¯ç‹¬ç«‹çš„ï¼Œæ™®é€šå‡½æ•°è°ƒç”¨åªèƒ½æ“ä½œè°ƒç”¨ goroutine çš„æ ˆï¼Œæ— æ³•ç›´æ¥æ“ä½œå…¶ä»– goroutine çš„æ ˆã€‚</p></li><li><p><strong>æŠ¢å å®‰å…¨æ€§</strong>ï¼šGo è¿è¡Œæ—¶åœ¨è·¨æ ˆæ“ä½œæœŸé—´ç¦ç”¨äº†å¯èƒ½å¯¼è‡´æ ˆç§»åŠ¨çš„æŠ¢å ç‚¹ï¼Œç¡®ä¿æ ˆåœ¨æ“ä½œæœŸé—´ä¿æŒç¨³å®šã€‚</p></li><li><p><strong>å†™å±éšœæœºåˆ¶</strong>ï¼šå†™å±éšœï¼ˆ<code>typeBitsBulkBarrier</code>ç­‰ï¼‰å’Œå†…å­˜ç®¡ç†é€»è¾‘ç¡®ä¿å³ä½¿åƒåœ¾å›æ”¶å‘ç”Ÿï¼Œä¹Ÿå¯ä»¥æ­£ç¡®è¿½è¸ªå’Œæ›´æ–°ç›®æ ‡åœ°å€ã€‚</p></li></ul><h3 id=322-keeplive-å‡½æ•°è¯´æ˜>3.2.2 KeepLive å‡½æ•°è¯´æ˜</h3><p>æ ˆå¯¹è±¡çš„å­˜æ´» åœ¨ Goroutine çš„æ ˆä¸Šåˆ†é…çš„å¯¹è±¡ï¼ˆå¦‚å±€éƒ¨å˜é‡ï¼‰ï¼Œå¯èƒ½ä¼šåœ¨ç¨‹åºé€»è¾‘ä¸­å¼•ç”¨åˆ°ï¼Œä½†å¦‚æœè¿™äº›å¼•ç”¨åªå­˜åœ¨äºä¸€äº›è¿è¡Œæ—¶æ•°æ®ç»“æ„ï¼ˆå¦‚ <code>sudog</code>ï¼‰ä¸­ï¼ŒGC å¯èƒ½ä¼šé”™è¯¯åœ°å°†å…¶å›æ”¶ã€‚KeepAlive æ˜ç¡®å‘ŠçŸ¥ GCï¼Œè¿™ä¸ªå˜é‡å¿…é¡»å­˜æ´»åˆ° KeepAlive è°ƒç”¨çš„ä½ç½®ã€‚</p><p>åœ¨é€šé“çš„å‘é€é€»è¾‘ä¸­ï¼Œ<code>ep</code> æ˜¯ä¸€ä¸ªæŒ‡å‘å¾…å‘é€æ•°æ®çš„æŒ‡é’ˆã€‚å¦‚æœè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘çš„æ˜¯ä¸€ä¸ªæ ˆä¸Šçš„å±€éƒ¨å˜é‡ï¼ŒGC å¯èƒ½ä¼šåœ¨å‘é€å®Œæˆå‰å›æ”¶è¿™ä¸ªå˜é‡ã€‚<code>sudog</code> ä¸è¢«è§†ä¸º GC çš„æ ¹å¯¹è±¡ï¼ˆrootï¼‰ï¼Œè¿™æ˜¯å› ä¸º<code>sudog</code>ç”¨äºä¸´æ—¶å­˜å‚¨ä¿¡æ¯ï¼ˆå¦‚å½“å‰ç­‰å¾…çš„é€šé“ï¼‰ã€‚è™½ç„¶å®ƒåŒ…å«äº†æŒ‡å‘ <code>ep</code> çš„æŒ‡é’ˆï¼Œç„¶è€Œï¼ŒGC ä¸ä¼šæ‰«æ <code>sudog</code>ï¼Œå› æ­¤ä¸ä¼šè®¤ä¸º <code>ep</code> æ˜¯æ´»è·ƒçš„å¯¹è±¡ã€‚</p><p>éœ€è¦æ‰‹åŠ¨é€šè¿‡ <code>KeepAlive</code> ç¡®ä¿ <code>ep</code> çš„ç”Ÿå‘½å‘¨æœŸã€‚</p><h1 id=4è¯»æ“ä½œ>4ã€è¯»æ“ä½œ</h1><p>ä¸¤ç§ä» channel ä¸­æ¥æ”¶æ•°æ®çš„æ–¹å¼ï¼Œéƒ½æ˜¯ä¼šå»è°ƒç”¨ chanrecv å‡½æ•°</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>i</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=nx>ch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>i</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=nx>ch</span><span class=w> </span><span class=c1>// å¸¦é€šé“åˆ¤æ–­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=cp>//go:nosplit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>chanrecv1</span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>hchan</span><span class=p>,</span><span class=w> </span><span class=nx>elem</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>chanrecv</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=cp>//go:nosplit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>chanrecv2</span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>hchan</span><span class=p>,</span><span class=w> </span><span class=nx>elem</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>received</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>received</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>chanrecv</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// chanrecv receives on channel c and writes the received data to ep.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// ep may be nil, in which case received data is ignored.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// If block == false and no elements are available, returns (false, false).</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// Otherwise, if c is closed, zeros *ep and returns (true, false).</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// Otherwise, fills in *ep with an element and returns (true, true).</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// A non-nil ep must point to the heap or the caller&#39;s stack.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>chanrecv</span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>hchan</span><span class=p>,</span><span class=w> </span><span class=nx>ep</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span><span class=p>,</span><span class=w> </span><span class=nx>block</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>selected</span><span class=p>,</span><span class=w> </span><span class=nx>received</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>debugChan</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nb>print</span><span class=p>(</span><span class=s>&#34;chanrecv: chan=&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=s>&#34;\n&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>block</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>gopark</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>waitReasonChanReceiveNilChan</span><span class=p>,</span><span class=w> </span><span class=nx>traceBlockForever</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>throw</span><span class=p>(</span><span class=s>&#34;unreachable&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Fast path: check for failed non-blocking operation without acquiring the lock.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>block</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nf>empty</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// After observing that the channel is not ready for receiving, we observe whether the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// channel is closed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>		// Reordering of these checks could lead to incorrect behavior when racing with a close.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// For example, if the channel was open and not empty, was closed, and then drained,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// reordered reads could incorrectly indicate &#34;open and empty&#34;. To prevent reordering,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// we use atomic loads for both checks, and rely on emptying and closing to happen in</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// separate critical sections under the same lock.  This assumption fails when closing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// an unbuffered channel with a blocked send, but that is an error condition anyway.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>atomic</span><span class=p>.</span><span class=nf>Load</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>closed</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// Because a channel cannot be reopened, the later observation of the channel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// being not closed implies that it was also not closed at the moment of the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// first observation. We behave as if we observed the channel at that moment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// and report that the receive cannot proceed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// The channel is irreversibly closed. Re-check whether the channel has any pending data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// to receive, which could have arrived between the empty and closed checks above.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// Sequential consistency is also required here, when racing with such a send.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å†æ¬¡æ£€æŸ¥æ˜¯å¦ä¸ºç©º</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æœ‰åœºæ™¯ï¼šå¯èƒ½å› ä¸ºåœ¨åˆ¤æ–­é€šé“å…³é—­çš„åŒæ—¶æœ‰å¦ä¸€ä¸ªgå¾€é€šé“å‘é€äº†æ•°æ®ï¼Œå¦‚æœæ­¤æ—¶æ²¡æœ‰æ£€æŸ¥ç›´æ¥è¿”å›å°±ä¼šæ¼æ‰é€šé“ä¸­çš„æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nf>empty</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// The channel is irreversibly closed and empty.ä¸å¯é€†è½¬çš„å…³é—­ä¸”ä¸ºç©º</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>raceenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nf>raceacquire</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nf>raceaddr</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>ep</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nf>typedmemclr</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span><span class=w> </span><span class=nx>ep</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>var</span><span class=w> </span><span class=nx>t0</span><span class=w> </span><span class=kt>int64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>blockprofilerate</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>t0</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>cputicks</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>lock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>lock</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>closed</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>qcount</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>raceenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nf>raceacquire</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nf>raceaddr</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nf>unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>lock</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>ep</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nf>typedmemclr</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span><span class=w> </span><span class=nx>ep</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// The channel has been closed, but the channel&#39;s buffer have data.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// Just found waiting sender with not closed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>sg</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>sendq</span><span class=p>.</span><span class=nf>dequeue</span><span class=p>();</span><span class=w> </span><span class=nx>sg</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// Found a waiting sender. If buffer is size 0, receive value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// directly from sender. Otherwise, receive from head of queue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// and add sender&#39;s value to the tail of the queue (both map to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// the same buffer slot because the queue is full).</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nf>recv</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>sg</span><span class=p>,</span><span class=w> </span><span class=nx>ep</span><span class=p>,</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nf>unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>lock</span><span class=p>)</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=mi>3</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>qcount</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// Receive directly from queue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>qp</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>chanbuf</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>raceenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nf>racenotify</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>ep</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nf>typedmemmove</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span><span class=w> </span><span class=nx>ep</span><span class=p>,</span><span class=w> </span><span class=nx>qp</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>typedmemclr</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span><span class=w> </span><span class=nx>qp</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>dataqsiz</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=p>.</span><span class=nx>qcount</span><span class=o>--</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>lock</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>block</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>lock</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// no sender available: block on this channel.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>gp</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>getg</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>mysg</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>acquireSudog</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>mysg</span><span class=p>.</span><span class=nx>releasetime</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>t0</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>mysg</span><span class=p>.</span><span class=nx>releasetime</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=o>-</span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// No stack splits between assigning elem and enqueuing mysg</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// on gp.waiting where copystack can find it.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>mysg</span><span class=p>.</span><span class=nx>elem</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>ep</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>mysg</span><span class=p>.</span><span class=nx>waitlink</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>gp</span><span class=p>.</span><span class=nx>waiting</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>mysg</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>mysg</span><span class=p>.</span><span class=nx>g</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>gp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>mysg</span><span class=p>.</span><span class=nx>isSelect</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>mysg</span><span class=p>.</span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>gp</span><span class=p>.</span><span class=nx>param</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>.</span><span class=nx>recvq</span><span class=p>.</span><span class=nf>enqueue</span><span class=p>(</span><span class=nx>mysg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Signal to anyone trying to shrink our stack that we&#39;re about</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// to park on a channel. The window between when this G&#39;s status</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// changes and when we set gp.activeStackChans is not safe for</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// stack shrinking.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>gp</span><span class=p>.</span><span class=nx>parkingOnChan</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>gopark</span><span class=p>(</span><span class=nx>chanparkcommit</span><span class=p>,</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>lock</span><span class=p>),</span><span class=w> </span><span class=nx>waitReasonChanReceive</span><span class=p>,</span><span class=w> </span><span class=nx>traceBlockChanRecv</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// someone woke us up</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>mysg</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nx>gp</span><span class=p>.</span><span class=nx>waiting</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>throw</span><span class=p>(</span><span class=s>&#34;G waiting list is corrupted&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>gp</span><span class=p>.</span><span class=nx>waiting</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>gp</span><span class=p>.</span><span class=nx>activeStackChans</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>mysg</span><span class=p>.</span><span class=nx>releasetime</span><span class=w> </span><span class=p>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>blockevent</span><span class=p>(</span><span class=nx>mysg</span><span class=p>.</span><span class=nx>releasetime</span><span class=o>-</span><span class=nx>t0</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>success</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>mysg</span><span class=p>.</span><span class=nx>success</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>gp</span><span class=p>.</span><span class=nx>param</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>mysg</span><span class=p>.</span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>releaseSudog</span><span class=p>(</span><span class=nx>mysg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=nx>success</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><a class=lightgallery href=../images/chan%e7%bc%93%e5%86%b2%e5%8c%ba%e8%af%bb%e5%8f%96.png title=img data-thumbnail=../images/chanç¼“å†²åŒºè¯»å–.png><img class=lazyload src=/svg/loading.min.svg data-src=../images/chan%e7%bc%93%e5%86%b2%e5%8c%ba%e8%af%bb%e5%8f%96.png data-srcset="../images/chan%e7%bc%93%e5%86%b2%e5%8c%ba%e8%af%bb%e5%8f%96.png, ../images/chan%e7%bc%93%e5%86%b2%e5%8c%ba%e8%af%bb%e5%8f%96.png 1.5x, ../images/chan%e7%bc%93%e5%86%b2%e5%8c%ba%e8%af%bb%e5%8f%96.png 2x" data-sizes=auto alt=../images/chanç¼“å†²åŒºè¯»å–.png></a></p><h2 id=41-å‚æ•°è§£é‡Š>4.1 å‚æ•°è§£é‡Š</h2><p><code>c *hchan</code>: æŒ‡å‘ç›®æ ‡ channel çš„æŒ‡é’ˆã€‚</p><p><code>ep unsafe.Pointer</code>: æ¥æ”¶æ•°æ®çš„åœ°å€æŒ‡é’ˆã€‚å¦‚æœä¸º nilï¼Œè¡¨ç¤ºå¿½ç•¥æ¥æ”¶åˆ°çš„æ•°æ®ã€‚</p><p><code>block bool</code>: è¡¨ç¤ºæ˜¯å¦å…è®¸é˜»å¡ã€‚å¦‚æœä¸º falseï¼Œè¡¨ç¤ºéé˜»å¡æ¨¡å¼ã€‚<code>v &lt;- ch</code>å’Œ<code>v, ok &lt;- ch</code>ä¸¤ç§éƒ½æ˜¯é˜»å¡çš„ï¼Œå¯¹äºä½¿ç”¨selectè¯­å¥ä»channelä¸­æ¥æ”¶æ•°æ®æ—¶ï¼Œè°ƒç”¨çš„æ˜¯<code>runtime.selectnbrecv</code>ï¼Œselectnbrecvè¡¨ç¤ºéé˜»å¡æ¥æ”¶ã€‚selectnbrecvçš„å®ç°ä¹Ÿæ˜¯è°ƒç”¨çš„<code>runtime.chanrecv</code>ï¼Œåªæ˜¯ä¼ å‚çš„æ—¶å€™<code>block=false</code>ã€‚å› æ­¤è¿™ä¸ªblockå‚æ•°ä¸»è¦æ˜¯åŒºåˆ†æ˜¯å¦æ˜¯<code>select receive</code>ã€‚</p><p>è¿”å›å€¼ï¼š</p><p><code>selected bool</code>: è¡¨ç¤ºå½“å‰é€šé“çš„æ¥æ”¶æ“ä½œæ˜¯å¦è¢«æˆåŠŸé€‰æ‹©æ‰§è¡Œã€‚åœ¨å¤šè·¯é€‰æ‹©åœºæ™¯ä¸‹ï¼Œç”¨äºæ ‡è¯†å½“å‰é€šé“æ˜¯å¦æ˜¯è¢«é€‰ä¸­æ‰§è¡Œçš„é€šé“æ“ä½œã€‚</p><p><code>received bool</code>: æ˜¯å¦æˆåŠŸæ¥æ”¶åˆ°å€¼ã€‚å½“é€šé“å·²å…³é—­ä¸”æ— æ•°æ®å¯æ¥æ”¶æ—¶ï¼Œè¿”å› <code>false</code>ã€‚</p><h2 id=42-æ•´ä½“æµç¨‹>4.2 æ•´ä½“æµç¨‹</h2><p>1ï¼‰å¦‚æœé€šé“ä¸ºç©ºï¼Œéé˜»å¡æ¨¡å¼ç›´æ¥è¿”å›ï¼Œé˜»å¡æ¨¡å¼ä¼šè°ƒç”¨ gopark å‡ºè®©è°ƒåº¦æƒï¼Œé™·å…¥æ­»é”ã€‚fatal error: all goroutines are asleep - deadlock!</p><p>2ï¼‰è¿›å…¥éé˜»å¡æ¨¡å¼çš„å¿«é€Ÿè·¯å¾„åˆ¤æ–­ï¼Œå…ˆåˆ¤æ–­ chan æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºè¿›å…¥ä»¥ä¸‹é€»è¾‘å¤„ç†</p><ul><li>åŠ åŸå­é”åˆ¤æ–­æ˜¯å¦å·²å…³é—­ï¼Œè‹¥æœªå…³é—­ï¼Œæ­¤æ—¶ chan çŠ¶æ€æ˜¯æœªå…³é—­ä¸”ä¸ºç©ºï¼Œè¿”å› ï¼ˆfalseï¼Œfalseï¼‰</li><li>åŠ åŸå­é”åˆ¤æ–­æ˜¯å¦å·²å…³é—­ï¼Œè‹¥å·²å…³é—­ï¼Œåˆ™å†æ¬¡åˆ¤æ–­æ˜¯å¦ä¸ºç©ºï¼Œè‹¥ä¸ºç©ºï¼Œæ­¤æ—¶çŠ¶æ€æ˜¯å·²å…³é—­ä¸”ä¸ºç©ºï¼Œåˆ™è¿”å› (true, false)ï¼Œå¹¶å°†æ¥æ”¶ç¼“å†²åŒºæ¸…é›¶ã€‚ä¸ä¸ºç©ºåˆ™ç»§ç»­ä¸‹é¢çš„é€»è¾‘ï¼Œè¡¨ç¤ºç¼“å­˜åŒºæœ‰æ•°æ®ï¼Œå°½ç®¡ chan å·²ç»è¢«å…³é—­ï¼Œä»ç„¶è¦å¤„ç†</li></ul><p>3ï¼‰å¦‚æœå¯ç”¨äº†æ€§èƒ½åˆ†æï¼Œè®°å½•å½“å‰æ—¶é—´æˆ³ t0ï¼Œç”¨äºåç»­è®¡ç®—é˜»å¡æ—¶é—´ã€‚</p><p>4ï¼‰åŠ é”</p><p>5ï¼‰å¦‚æœ channel å·²å…³é—­ä¸”ç¼“å†²åŒºä¸ºç©ºï¼š</p><ul><li>è§£é”ã€‚</li><li>å¦‚æœ ep ä¸ä¸ºç©ºï¼Œå°†ç›®æ ‡å†…å­˜æ¸…é›¶ã€‚</li><li>è¿”å› (true, false)ã€‚</li></ul><p>6ï¼‰æœªå…³é—­ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ç­‰å¾…å‘é€çš„ goroutineï¼Œæœ‰åˆ™è°ƒç”¨ recv å‡½æ•°ä»å‘é€æ–¹ç›´æ¥æ¥æ”¶æ•°æ®ï¼Œè§£é”å¹¶è¿”å› (true, true)ã€‚</p><p>7ï¼‰å¦‚æœç¼“å†²åŒºæœ‰æ•°æ®ï¼š</p><ul><li>è®¡ç®—å‡ºä¸‹ä¸€ä¸ªæ¥æ”¶ä½ç½® qpã€‚</li><li>å¦‚æœ ep ä¸ä¸º nilï¼Œå°†æ•°æ®ç§»åŠ¨åˆ°æ¥æ”¶åœ°å€ã€‚</li><li>æ¸…ç©ºç¼“å†²åŒºä½ç½®ï¼Œæ›´æ–°ç´¢å¼•å’Œè®¡æ•°ã€‚</li><li>è§£é”å¹¶è¿”å› (true, true)ã€‚</li></ul><p>8ï¼‰å¦‚æœæ˜¯éé˜»å¡æ¨¡å¼ï¼Œä½†æ­¤æ—¶æ²¡æœ‰æ•°æ®ï¼Œä¹Ÿæ²¡æœ‰ç­‰å¾…çš„å‘é€è€…ï¼Œç›´æ¥è¿”å› (false, false)</p><p>9ï¼‰é˜»å¡æ¨¡å¼å°†å½“å‰ goroutine åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼š</p><ul><li>å½“å‰ goroutineè·å–ä¸€ä¸ª sudogã€‚</li><li>è®¾ç½® sudog çš„å­—æ®µï¼ˆä¾‹å¦‚ç›®æ ‡åœ°å€ã€å…³è”çš„ goroutine ç­‰ï¼‰ã€‚</li><li>å°† sudog åŠ å…¥ recvq é˜Ÿåˆ—ã€‚</li><li>è°ƒç”¨ gopark å‡ºè®©è°ƒåº¦æƒ</li></ul><p>10ï¼‰è¢«å”¤é†’åï¼šæ£€æŸ¥ <code>sudog</code> æ˜¯å¦ä»ç„¶ä¸å½“å‰ goroutine å…³è”ã€‚ä» <code>sudog</code> ä¸­æå–ç»“æœå¹¶é‡Šæ”¾èµ„æºï¼Œè¿”å›æ¥æ”¶ç»“æœ</p><h3 id=421-recv-å‡½æ•°>4.2.1 recv å‡½æ•°</h3><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>recv</span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>hchan</span><span class=p>,</span><span class=w> </span><span class=nx>sg</span><span class=w> </span><span class=o>*</span><span class=nx>sudog</span><span class=p>,</span><span class=w> </span><span class=nx>ep</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span><span class=p>,</span><span class=w> </span><span class=nx>unlockf</span><span class=w> </span><span class=kd>func</span><span class=p>(),</span><span class=w> </span><span class=nx>skip</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>dataqsiz</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>raceenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nf>racesync</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>sg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>ep</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=c1>// copy data from sender</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nf>recvDirect</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span><span class=w> </span><span class=nx>sg</span><span class=p>,</span><span class=w> </span><span class=nx>ep</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// Queue is full. Take the item at the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// head of the queue. Make the sender enqueue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// its item at the tail of the queue. Since the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// queue is full, those are both the same slot.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>qp</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>chanbuf</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>raceenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nf>racenotify</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nf>racenotify</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=p>,</span><span class=w> </span><span class=nx>sg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// copy data from queue to receiver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>ep</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nf>typedmemmove</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span><span class=w> </span><span class=nx>ep</span><span class=p>,</span><span class=w> </span><span class=nx>qp</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// copy data from sender to queue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>typedmemmove</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span><span class=w> </span><span class=nx>qp</span><span class=p>,</span><span class=w> </span><span class=nx>sg</span><span class=p>.</span><span class=nx>elem</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=o>++</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>dataqsiz</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=p>.</span><span class=nx>sendx</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>recvx</span><span class=w> </span><span class=c1>// c.sendx = (c.sendx+1) % c.dataqsiz</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>sg</span><span class=p>.</span><span class=nx>elem</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>gp</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>sg</span><span class=p>.</span><span class=nx>g</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>unlockf</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>gp</span><span class=p>.</span><span class=nx>param</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=nx>sg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>sg</span><span class=p>.</span><span class=nx>success</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>sg</span><span class=p>.</span><span class=nx>releasetime</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>sg</span><span class=p>.</span><span class=nx>releasetime</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>cputicks</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>goready</span><span class=p>(</span><span class=nx>gp</span><span class=p>,</span><span class=w> </span><span class=nx>skip</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>å‚æ•°ï¼š</p><ol><li><code>c *hchan</code>: ç›®æ ‡ channelï¼Œè°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼Œc å·²ç»åŠ é”</li><li><code>sg *sudog</code>: è¡¨ç¤ºç­‰å¾…å‘é€çš„ goroutine çš„ sudogï¼Œsg å·²ç»ä» channel çš„å‘é€é˜Ÿåˆ—ä¸­ç§»é™¤ï¼ˆdequeueï¼‰</li><li><code>ep unsafe.Pointer</code>: è¡¨ç¤ºæ¥æ”¶æ–¹çš„ç›®æ ‡å†…å­˜åœ°å€ï¼Œå¦‚æœä¸º nilï¼Œåˆ™è¡¨ç¤ºå¿½ç•¥æ¥æ”¶åˆ°çš„å€¼</li><li><code>unlockf func()</code>: è§£é”å‡½æ•°ï¼Œç”¨äºåœ¨æ“ä½œå®Œæˆåé‡Šæ”¾é”</li><li><code>skip int:</code> è·Ÿè¸ªè°ƒç”¨æ ˆçš„æ·±åº¦ï¼Œç”¨äºè°ƒåº¦ç›¸å…³çš„è°ƒç”¨ï¼ˆå¦‚ goreadyï¼‰</li></ol><p>æ•´ä½“æµç¨‹ï¼š</p><p>è°ƒç”¨è¯¥å‡½æ•°çš„æ—¶å€™ï¼Œä»ç­‰å¾…å‘é€é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ª gï¼Œè¯´æ˜å¦‚æœæ˜¯å¸¦ç¼“å†²å¸¦çš„ chanï¼Œæ­¤æ—¶ç¼“å†²åŒºä¸€å®šæ˜¯æ»¡çš„</p><p>1ï¼‰å¦‚æœ<code>c.dataqsiz == 0</code>ï¼Œå±äº<strong>æ— ç¼“å†²</strong> channleï¼Œé€šè¿‡ <code>recvDirect</code> è·¨æ ˆç›´æ¥å‘é€æ•°æ®ï¼Œæ— éœ€æ“ä½œç¼“å†²åŒº</p><p>2ï¼‰å¦‚æœ<code>c.dataqsiz > 0</code>ï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª**æœ‰ç¼“å†² channelï¼Œ**éœ€è¦ä»ç¼“å†²åŒºä¸­è·å–å€¼ï¼Œå¹¶å°†å‘é€æ–¹çš„æ•°æ®å†™å…¥ç¼“å†²åŒº</p><ol><li><code>chanbuf</code>ï¼šè®¡ç®—ç¼“å†²åŒºä¸­å½“å‰æ¥æ”¶ä½ç½®çš„åœ°å€</li><li><code>racenotify</code>ï¼šé€šçŸ¥ç«æ€æ£€æµ‹å™¨ï¼Œå½“å‰æ¥æ”¶å’Œå‘é€ä½ç½®å³å°†å‘ç”Ÿæ“ä½œ</li><li>ep ä¸ä¸ºç©ºï¼Œä»ç¼“å†²åŒºå½“å‰æ¥æ”¶ä½ç½® qp å¤åˆ¶æ•°æ®åˆ°æ¥æ”¶æ–¹åœ°å€ ep</li><li>ä»å‘é€æ–¹çš„ sg.elem ä¸­å¤åˆ¶æ•°æ®åˆ°ç¼“å†²åŒºå½“å‰æ¥æ”¶ä½ç½® qp</li><li>æ›´æ–°æ¥æ”¶ç´¢å¼• recvx å’Œå‘é€ç´¢å¼• sendxï¼Œå¦‚æœåˆ°è¾¾ç¼“å†²åŒºæœ«å°¾ï¼Œå¾ªç¯å›åˆ°å¼€å¤´ï¼Œç”±äºæ­¤æ—¶ç¼“å†²åŒºå·²æ»¡ï¼Œrecvx å’Œ sendx æŒ‡å‘åŒä¸€ä¸ªä½ç½®</li></ol><p>3ï¼‰<code>sg.elem = nil </code>æ¸…é™¤ sg ä¸­çš„å…ƒç´ å¼•ç”¨ï¼Œé¿å…å†…å­˜æ³„æ¼ï¼Œè·å–å‘é€æ–¹ goroutine çš„æŒ‡é’ˆ gpï¼Œè°ƒç”¨è§£é”å‡½æ•° unlockfï¼Œé‡Šæ”¾å¯¹ channel çš„é”</p><p>4ï¼‰å°† sg è®¾ç½®ä¸ºå‘é€æ–¹ goroutine çš„å‚æ•°ï¼ˆparamï¼‰ï¼Œæ ‡è®° sg.success = trueï¼Œè°ƒç”¨ goready å”¤é†’å‘é€è€…ï¼Œå°†å‘é€ goroutine æ ‡è®°ä¸ºå¯è¿è¡ŒçŠ¶æ€ã€‚</p><p>æ€»ç»“ï¼šrecv çš„ä¸»è¦é€»è¾‘</p><ol><li>æ— ç¼“å†² channelï¼šæ•°æ®ç›´æ¥é€šè¿‡<code>recvDirect</code>ä»å‘é€æ–¹ä¼ é€’ç»™æ¥æ”¶æ–¹ã€‚ç›´æ¥å†…å­˜æ‹·è´ï¼ˆ<code>typedmemmove</code>ï¼‰ä¼˜åŒ–æ•°æ®ä¼ é€’</li><li>æœ‰ç¼“å†² channelï¼šä»ç¼“å†²åŒºä¸­è·å–æ¥æ”¶æ–¹çš„æ•°æ®ï¼Œå°†å‘é€æ–¹çš„æ•°æ®æ”¾å…¥ç¼“å†²åŒºçš„å°¾éƒ¨ï¼Œæ›´æ–°ç¼“å†²åŒºçš„çŠ¶æ€ç´¢å¼•</li><li>å”¤é†’å‘é€æ–¹ï¼šå°†å‘é€æ–¹ goroutine æ ‡è®°ä¸ºå¯è¿è¡ŒçŠ¶æ€ï¼Œä½¿å…¶æ¢å¤æ‰§è¡Œ</li></ol><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>recvDirect</span><span class=p>(</span><span class=nx>t</span><span class=w> </span><span class=o>*</span><span class=nx>_type</span><span class=p>,</span><span class=w> </span><span class=nx>sg</span><span class=w> </span><span class=o>*</span><span class=nx>sudog</span><span class=p>,</span><span class=w> </span><span class=nx>dst</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// dst is on our stack or the heap, src is on another stack.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// The channel is locked, so src will not move during this</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// operation.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>src</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>sg</span><span class=p>.</span><span class=nx>elem</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>typeBitsBulkBarrier</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span><span class=w> </span><span class=nb>uintptr</span><span class=p>(</span><span class=nx>dst</span><span class=p>),</span><span class=w> </span><span class=nb>uintptr</span><span class=p>(</span><span class=nx>src</span><span class=p>),</span><span class=w> </span><span class=nx>t</span><span class=p>.</span><span class=nx>Size_</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>memmove</span><span class=p>(</span><span class=nx>dst</span><span class=p>,</span><span class=w> </span><span class=nx>src</span><span class=p>,</span><span class=w> </span><span class=nx>t</span><span class=p>.</span><span class=nx>Size_</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><code>recvDirect</code> åŒ <code>sendDirect</code>ï¼Œç›´æ¥å®æ ˆäº¤æ¢æ•°æ®ï¼Œæ€ä¹ˆå®ç°çš„ï¼Ÿ</p><p>1ã€<code>sg.elem</code> æ˜¯å‘é€æ–¹ goroutine çš„æ ˆä¸Šçš„ä¸€ä¸ªåœ°å€ï¼ŒæŒ‡å‘å‘é€æ–¹å‡†å¤‡å¥½çš„æ•°æ®ã€‚é€šé“åœ¨è¿è¡Œæ—¶ä¼šå°†å‘é€ goroutine çš„æ•°æ®ä½ç½®å­˜å‚¨åˆ° <strong><code>sudog.elem</code></strong> ä¸­ã€‚chan çš„åŠ é”ä¿è¯äº†å‘é€æ–¹çš„ sudog.elem ä¸ä¼šåœ¨æ‹·è´æœŸé—´è¢«ä¿®æ”¹æˆ–ç§»åŠ¨ã€‚</p><p>2ã€é€šè¿‡å†™å±éšœä¿è¯ç¡®ä¿ GC åœ¨æ‰«æå¯¹è±¡æ—¶ä¸ä¼šé—æ¼æˆ–è¯¯åˆ¤å¼•ç”¨ï¼š</p><ul><li><p>å› ä¸º <code>src</code> å’Œ <code>dst</code> å¯èƒ½åˆ†åˆ«ä½äºä¸åŒçš„æ ˆæˆ–å †ä¸Šï¼Œå¹¶ä¸”è·¨æ ˆå†™å…¥æ˜¯ç‰¹æ®Šæƒ…å†µï¼Œè¿è¡Œæ—¶éœ€è¦è°ƒç”¨ <strong><code>typeBitsBulkBarrier</code></strong> æ¥é€šçŸ¥ GCï¼š</p></li><li><ul><li>æ•°æ®çš„æ¥æºï¼ˆ<strong><code>**src**</code></strong>ï¼‰å’Œç›®æ ‡ï¼ˆ<strong><code>dst</code></strong>ï¼‰ã€‚</li><li>æ•°æ®çš„å¤§å°å’Œç±»å‹ï¼ˆ<strong><code>t.Size_</code></strong>ï¼‰ã€‚</li></ul></li><li><p>è¿™å¯ä»¥ç¡®ä¿åœ¨ GC æ‰«ææ—¶æ­£ç¡®å¤„ç†æ ˆä¸å †ä¹‹é—´çš„å†…å­˜å¼•ç”¨ã€‚</p></li></ul><p>3ã€<code>memmove</code>æ˜¯ä¸€ä¸ªåº•å±‚çš„å†…å­˜æ‹·è´å‡½æ•°ï¼Œç”¨äºå°†æŒ‡å®šå¤§å°çš„æ•°æ®ä» <strong><code>src</code></strong> å¤åˆ¶åˆ° <strong><code>dst</code></strong>ã€‚è¿™é‡Œç›´æ¥å°†å‘é€æ–¹çš„å†…å­˜æ•°æ®ä» <strong><code>sg.elem</code></strong>ï¼ˆå‘é€æ–¹æ ˆä¸Šçš„æ•°æ®ï¼‰å¤åˆ¶åˆ°æ¥æ”¶æ–¹çš„å­˜å‚¨ä½ç½® <strong><code>dst</code></strong>ã€‚</p><h1 id=5å…³é—­-chan>5ã€å…³é—­ chan</h1><h2 id=51-å…³é”®å…¥å£ä¸æ‰§è¡Œè·¯å¾„>5.1 å…³é”®å…¥å£ä¸æ‰§è¡Œè·¯å¾„</h2><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nb>close</span><span class=p>(</span><span class=nx>ch</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>walkExpr</span><span class=p>(</span><span class=nx>n</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=p>,</span><span class=w> </span><span class=nx>init</span><span class=w> </span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Nodes</span><span class=p>)</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>...</span><span class=p>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>OCLEAR</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>n</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>n</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>UnaryExpr</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nf>walkClear</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>case</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>OCLOSE</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>n</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>n</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>UnaryExpr</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nf>walkClose</span><span class=p>(</span><span class=nx>n</span><span class=p>,</span><span class=w> </span><span class=nx>init</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>case</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>OMAKECHAN</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>n</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>n</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>MakeExpr</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nf>walkMakeChan</span><span class=p>(</span><span class=nx>n</span><span class=p>,</span><span class=w> </span><span class=nx>init</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>case</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>OMAKEMAP</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>n</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>n</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>MakeExpr</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nf>walkMakeMap</span><span class=p>(</span><span class=nx>n</span><span class=p>,</span><span class=w> </span><span class=nx>init</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>case</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>OMAKESLICE</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>n</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>n</span><span class=p>.(</span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>MakeExpr</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nf>walkMakeSlice</span><span class=p>(</span><span class=nx>n</span><span class=p>,</span><span class=w> </span><span class=nx>init</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>åœ¨ç¼–è¯‘å™¨ç¼–è¯‘æœŸé—´ï¼ŒèŠ‚ç‚¹ç±»å‹ä¸º <code>OLCLOSE</code>ï¼Œåœ¨<code>go/src/cmd/compile/internal/walk/expr.go</code>ä¸­å¤„ç†è¯¥èŠ‚ç‚¹çš„å‡½æ•°æ˜¯<code>go/src/cmd/compile/internal/walk/builtin.go</code> ä¸­çš„ <code>walkClose</code> å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°ä¼šè¢«ç¼–è¯‘å™¨å¤„ç†ä¸ºè°ƒç”¨è¿è¡Œæ—¶å‡½æ•° <code>closechan</code></p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// walkClose walks an OCLOSE node.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>walkClose</span><span class=p>(</span><span class=nx>n</span><span class=w> </span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>UnaryExpr</span><span class=p>,</span><span class=w> </span><span class=nx>init</span><span class=w> </span><span class=o>*</span><span class=nx>ir</span><span class=p>.</span><span class=nx>Nodes</span><span class=p>)</span><span class=w> </span><span class=nx>ir</span><span class=p>.</span><span class=nx>Node</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// cannot use chanfn - closechan takes any, not chan any</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>fn</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>typecheck</span><span class=p>.</span><span class=nf>LookupRuntime</span><span class=p>(</span><span class=s>&#34;closechan&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>n</span><span class=p>.</span><span class=nx>X</span><span class=p>.</span><span class=nf>Type</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nf>mkcall1</span><span class=p>(</span><span class=nx>fn</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>init</span><span class=p>,</span><span class=w> </span><span class=nx>n</span><span class=p>.</span><span class=nx>X</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h2 id=52-æµç¨‹>5.2 æµç¨‹</h2><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>closechan</span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>hchan</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>panic</span><span class=p>(</span><span class=nf>plainError</span><span class=p>(</span><span class=s>&#34;close of nil channel&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>lock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>lock</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>closed</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>lock</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>panic</span><span class=p>(</span><span class=nf>plainError</span><span class=p>(</span><span class=s>&#34;close of closed channel&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>raceenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>callerpc</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>getcallerpc</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>racewritepc</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nf>raceaddr</span><span class=p>(),</span><span class=w> </span><span class=nx>callerpc</span><span class=p>,</span><span class=w> </span><span class=nx>abi</span><span class=p>.</span><span class=nf>FuncPCABIInternal</span><span class=p>(</span><span class=nx>closechan</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>racerelease</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nf>raceaddr</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>c</span><span class=p>.</span><span class=nx>closed</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nx>glist</span><span class=w> </span><span class=nx>gList</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// release all readers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>sg</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>recvq</span><span class=p>.</span><span class=nf>dequeue</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>sg</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>sg</span><span class=p>.</span><span class=nx>elem</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nf>typedmemclr</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span><span class=w> </span><span class=nx>sg</span><span class=p>.</span><span class=nx>elem</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>sg</span><span class=p>.</span><span class=nx>elem</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>sg</span><span class=p>.</span><span class=nx>releasetime</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>sg</span><span class=p>.</span><span class=nx>releasetime</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>cputicks</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>gp</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>sg</span><span class=p>.</span><span class=nx>g</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>gp</span><span class=p>.</span><span class=nx>param</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=nx>sg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>sg</span><span class=p>.</span><span class=nx>success</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>raceenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nf>raceacquireg</span><span class=p>(</span><span class=nx>gp</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nf>raceaddr</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>glist</span><span class=p>.</span><span class=nf>push</span><span class=p>(</span><span class=nx>gp</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// release all writers (they will panic)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>sg</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>sendq</span><span class=p>.</span><span class=nf>dequeue</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>sg</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>sg</span><span class=p>.</span><span class=nx>elem</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>sg</span><span class=p>.</span><span class=nx>releasetime</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>sg</span><span class=p>.</span><span class=nx>releasetime</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nf>cputicks</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>gp</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>sg</span><span class=p>.</span><span class=nx>g</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>gp</span><span class=p>.</span><span class=nx>param</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=nx>sg</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>sg</span><span class=p>.</span><span class=nx>success</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>raceenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nf>raceacquireg</span><span class=p>(</span><span class=nx>gp</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nf>raceaddr</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>glist</span><span class=p>.</span><span class=nf>push</span><span class=p>(</span><span class=nx>gp</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>lock</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Ready all Gs now that we&#39;ve dropped the channel lock.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>!</span><span class=nx>glist</span><span class=p>.</span><span class=nf>empty</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>gp</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>glist</span><span class=p>.</span><span class=nf>pop</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>gp</span><span class=p>.</span><span class=nx>schedlink</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nf>goready</span><span class=p>(</span><span class=nx>gp</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>1ï¼‰å…³é—­æœªè¢«åˆå§‹åŒ–çš„ chanï¼Œä¼šè§¦å‘ panic</p><p>2ï¼‰åŠ é”</p><p>3ï¼‰åˆ¤æ–­æ˜¯å¦å·²è¢«å…³é—­ï¼Œè‹¥å…³é—­å·²ç»è¢«å…³é—­çš„ chanï¼Œè§¦å‘ panicï¼Œè§£é”</p><p>4ï¼‰å…³é—­ chanï¼Œc.closed èµ‹å€¼ä¸º 1</p><p>5ï¼‰å°†æ¥æ”¶é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ g ä½¿ç”¨ typedmemclr å°† elem çš„å†…å­˜åŒºåŸŸæ¸…é›¶ï¼Œæ·»åŠ åˆ° glistï¼Œåç»­é€šè¿‡ goready å”¤é†’</p><p>6ï¼‰å°†å‘é€é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ g ä¹Ÿæ·»åŠ åˆ° glist</p><p>7ï¼‰è§£é”</p><p>8ï¼‰å”¤é†’ glist ä¸­çš„æ‰€æœ‰ g</p><h1 id=6å…¶ä»–è¡¥å……çŸ¥è¯†>6ã€å…¶ä»–è¡¥å……çŸ¥è¯†</h1><h2 id=61-sudog>6.1 sudog</h2><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>sudog</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>g</span><span class=w>           </span><span class=o>*</span><span class=nx>g</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>next</span><span class=w>        </span><span class=o>*</span><span class=nx>sudog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>prev</span><span class=w>        </span><span class=o>*</span><span class=nx>sudog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>elem</span><span class=w>        </span><span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>acquiretime</span><span class=w> </span><span class=kt>int64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>releasetime</span><span class=w> </span><span class=kt>int64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>ticket</span><span class=w>      </span><span class=kt>uint32</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>isSelect</span><span class=w>    </span><span class=kt>bool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>success</span><span class=w>     </span><span class=kt>bool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>waiters</span><span class=w>     </span><span class=kt>uint16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>parent</span><span class=w>      </span><span class=o>*</span><span class=nx>sudog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>waitlink</span><span class=w>    </span><span class=o>*</span><span class=nx>sudog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>waittail</span><span class=w>    </span><span class=o>*</span><span class=nx>sudog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>c</span><span class=w>           </span><span class=o>*</span><span class=nx>hchan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>sudog æ˜¯ Go runtime ä¸­çš„ä¸€ä¸ªæ ¸å¿ƒç»“æ„ä½“ï¼Œç”¨äºç®¡ç† goroutine åœ¨ channel æ“ä½œä¸­çš„ç­‰å¾…çŠ¶æ€ã€‚sudog æ˜¯ channel çš„åº•å±‚å®ç°çš„ä¸€éƒ¨åˆ†ï¼Œé€šè¿‡å®ƒå¯ä»¥è®°å½•å“ªäº› goroutines æ­£åœ¨ç­‰å¾…æ“ä½œï¼Œå¦‚ä½•è°ƒåº¦å®ƒä»¬ï¼Œä»¥åŠç›¸å…³çš„å…ƒä¿¡æ¯ã€‚</p><p>ä»¥ä¸‹æ˜¯ sudog ç»“æ„ä½“å„å­—æ®µçš„è¯¦ç»†è¯´æ˜ï¼š</p><ol><li>g *g</li></ol><ul><li>å«ä¹‰ï¼šæŒ‡å‘æ­£åœ¨ç­‰å¾…æ“ä½œçš„ goroutine çš„ç»“æ„ä½“ã€‚</li><li>ä½œç”¨ï¼šsudog æ˜¯ä¸ goroutine ç´§å¯†å…³è”çš„ã€‚é€šè¿‡è¿™ä¸ªå­—æ®µå¯ä»¥æ‰¾åˆ°å…·ä½“çš„ goroutineï¼Œå®Œæˆè°ƒåº¦ã€å”¤é†’ç­‰æ“ä½œã€‚</li></ul><ol><li>next *sudog å’Œ prev *sudog</li></ol><ul><li>å«ä¹‰ï¼šå½¢æˆä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œnext æŒ‡å‘ä¸‹ä¸€ä¸ªç­‰å¾…çš„ sudogï¼Œprev æŒ‡å‘ä¸Šä¸€ä¸ªã€‚</li><li>ä½œç”¨ï¼šç»´æŠ¤ç­‰å¾…é˜Ÿåˆ—ï¼Œç‰¹åˆ«æ˜¯åœ¨ channel çš„å‘é€å’Œæ¥æ”¶æ“ä½œä¸­ï¼Œå­˜å‚¨æ‰€æœ‰ç­‰å¾…çš„ goroutinesã€‚</li></ul><ol><li>elem unsafe.Pointer</li></ol><ul><li>å«ä¹‰ï¼šæŒ‡å‘éœ€è¦è¢«å‘é€æˆ–æ¥æ”¶çš„æ•°æ®çš„åœ°å€ã€‚</li><li>ä½œç”¨ï¼šåœ¨ channel æ“ä½œä¸­ï¼Œç”¨äºä¿å­˜å‘é€æ•°æ®æˆ–è€…æ¥æ”¶æ•°æ®çš„ç›®æ ‡åœ°å€ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªå˜é‡æŒ‡é’ˆï¼‰ã€‚</li><li>åœºæ™¯ï¼šå‘é€æ–¹ä¼šå°†æ•°æ®å­˜æ”¾åˆ° elem æŒ‡å‘çš„åœ°å€ä¸­ï¼Œæ¥æ”¶æ–¹ä» elem æŒ‡å‘çš„åœ°å€è¯»å–æ•°æ®ã€‚</li></ul><ol><li>acquiretime int64 å’Œ releasetime int64</li></ol><ul><li>å«ä¹‰ï¼šåˆ†åˆ«è®°å½• sudog è¢«æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—çš„æ—¶é—´å’Œä»é˜Ÿåˆ—ä¸­ç§»é™¤çš„æ—¶é—´ã€‚</li><li>ä½œç”¨ï¼š</li><li>acquiretimeï¼šè®°å½• goroutine å¼€å§‹ç­‰å¾…æ—¶çš„æ—¶é—´æˆ³ï¼ˆçº³ç§’ï¼‰ã€‚</li><li>releasetimeï¼šè®°å½• goroutine è¢«å”¤é†’æ—¶çš„æ—¶é—´æˆ³ã€‚</li><li>ç”¨é€”ï¼šå¯ä»¥ç”¨æ¥è°ƒè¯•ã€æ€§èƒ½åˆ†ææˆ–æ£€æµ‹ goroutine æ˜¯å¦è¢«é•¿æ—¶é—´é˜»å¡ã€‚</li></ul><ol><li>ticket uint32</li></ol><ul><li>å«ä¹‰ï¼šä¸€ä¸ªæ ‡è¯†ï¼Œç”¨æ¥æ’åºæˆ–è°ƒåº¦ã€‚</li><li>ä½œç”¨ï¼šå¯ä»¥å¸®åŠ©å®ç°å…¬å¹³è°ƒåº¦ï¼Œç‰¹åˆ«æ˜¯åœ¨ç«äº‰æ¿€çƒˆçš„æƒ…å†µä¸‹ï¼Œå†³å®šå“ªä¸ª goroutine ä¼˜å…ˆè¢«å”¤é†’ã€‚</li></ul><ol><li>isSelect bool</li></ol><ul><li>å«ä¹‰ï¼šæ ‡è®°è¯¥ sudog æ˜¯å¦ä¸ select è¯­å¥å…³è”ã€‚</li><li>ä½œç”¨ï¼š</li><li>å¦‚æœ goroutine æ˜¯é€šè¿‡ select è¯­å¥é˜»å¡çš„ï¼Œè¿™ä¸ªæ ‡å¿—ä¼šè¢«è®¾ç½®ä¸º trueã€‚</li><li>ç‰¹æ®Šå¤„ç† select çš„å”¤é†’é€»è¾‘ã€‚</li></ul><ol><li>success bool</li></ol><ul><li>å«ä¹‰ï¼šè®°å½•å½“å‰æ“ä½œæ˜¯å¦æˆåŠŸã€‚</li><li>ä½œç”¨ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç”¨äºåˆ¤æ–­å‘é€æˆ–æ¥æ”¶æ“ä½œæ˜¯å¦å®Œæˆï¼ˆä¾‹å¦‚ä¸ select é…åˆæ—¶ï¼‰ã€‚</li></ul><ol><li>waiters uint16</li></ol><ul><li>å«ä¹‰ï¼šè¡¨ç¤ºå½“å‰ goroutine å…³è”çš„ç­‰å¾…è€…æ•°é‡ã€‚</li><li>ä½œç”¨ï¼šåœ¨è°ƒè¯•å’Œæ€§èƒ½åˆ†æä¸­å¯ä»¥ç”¨æ¥æ£€æŸ¥ goroutine æ˜¯å¦æœ‰è¿‡å¤šçš„ä¾èµ–æˆ–ç­‰å¾…è€…ã€‚</li></ul><ol><li>parent *sudog</li></ol><ul><li>å«ä¹‰ï¼šæŒ‡å‘çˆ¶çº§ sudogã€‚</li><li>ä½œç”¨ï¼šæ„å»ºä¸€ä¸ªå±‚çº§ç»“æ„ï¼Œç”¨äºç®¡ç†åµŒå¥—çš„ç­‰å¾…å…³ç³»ã€‚</li><li>åœºæ™¯ï¼šåœ¨æŸäº›å¤æ‚åœºæ™¯ä¸­ï¼Œç”¨æ¥æè¿°å¤šå±‚ç­‰å¾…ã€‚</li></ul><ol><li>waitlink *sudog å’Œ waittail *sudog</li></ol><ul><li>å«ä¹‰ï¼š</li><li>waitlinkï¼šé“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹ã€‚</li><li>waittailï¼šé“¾è¡¨çš„å°¾éƒ¨èŠ‚ç‚¹ã€‚</li><li>ä½œç”¨ï¼šç»´æŠ¤ä¸€ä¸ªé“¾è¡¨ï¼Œç”¨äºæè¿°å½“å‰ sudog çš„ç­‰å¾…å­é›†ã€‚</li></ul><ol><li>c *hchan</li></ol><ul><li>å«ä¹‰ï¼šæŒ‡å‘ä¸è¯¥ sudog å…³è”çš„ channelã€‚</li><li>ä½œç”¨ï¼šæ ‡æ˜è¯¥ sudog å½“å‰åœ¨å“ªä¸ª channel ä¸Šè¿›è¡Œæ“ä½œï¼ˆå‘é€æˆ–æ¥æ”¶ï¼‰ã€‚</li><li>åœºæ™¯ï¼šè°ƒåº¦æˆ–å”¤é†’æ—¶éœ€è¦é€šè¿‡è¿™ä¸ªå­—æ®µæ‰¾åˆ°å¯¹åº”çš„ channelã€‚</li></ul><p>æ€»ä½“ä½œç”¨ï¼š</p><p>â€¢åœºæ™¯ï¼šsudog çš„ä¸»è¦ç”¨é€”æ˜¯ç®¡ç† goroutine åœ¨ channel ä¸Šçš„é˜»å¡æ“ä½œã€‚æ— è®ºæ˜¯å‘é€è¿˜æ˜¯æ¥æ”¶æ“ä½œï¼Œå¦‚æœ channel æ»¡æˆ–ç©ºï¼Œgoroutine å°±ä¼šé€šè¿‡ä¸€ä¸ª sudog ç»“æ„ä½“è¢«æŒ‚èµ·åˆ° channel çš„ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚</p><p>â€¢æ“ä½œï¼š</p><p>â€¢ å¦‚æœæ˜¯å‘é€æ“ä½œï¼Œæ•°æ®ä¼šå­˜å‚¨åœ¨ elem æŒ‡å‘çš„åœ°å€ä¸­ã€‚</p><p>â€¢ å¦‚æœæ˜¯æ¥æ”¶æ“ä½œï¼Œæ•°æ®ä¼šä» elem æŒ‡å‘çš„åœ°å€è¯»å–ã€‚</p><p>â€¢æ¢å¤ï¼šå½“æ¡ä»¶æ»¡è¶³æ—¶ï¼ˆå¦‚ channel æœ‰ç©ºé—´æˆ–æœ‰æ•°æ®ï¼‰ï¼Œruntime ä¼šå”¤é†’é˜Ÿåˆ—ä¸­çš„ sudogï¼Œå¯¹åº”çš„ goroutine ç»§ç»­è¿è¡Œã€‚</p><h2 id=62-chanrecv-ä¸-chansend-çš„å¿«é€Ÿè·¯å¾„åˆ¤æ–­>6.2 chanrecv ä¸ chansend çš„å¿«é€Ÿè·¯å¾„åˆ¤æ–­</h2><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// chanrecv</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>block</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nf>empty</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 1ã€åŠ é”çš„ç›®çš„æ˜¯ï¼šé¿å…åœ¨è¯»å–channelçŠ¶æ€çš„åŒæ—¶æœ‰å¦ä¸€ä¸ªGæ­£åœ¨å…³é—­è¯¥é€šé“ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 2ã€è€ŒåŠ åŸå­é”çš„åŸå› æ˜¯ï¼š1ã€ç›¸æ¯”é”æ“ä½œï¼Œæ›´è½»é‡çº§ï¼Œé€‚åˆåœ¨å¿«é€Ÿè·¯å¾„ä¸­ä½¿ç”¨ï¼Œå°½é‡å‡å°‘å¼€é”€</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//                    2ã€é€šé“å…³é—­æ˜¯å•å‘çš„ï¼Œåªèƒ½ä»æœªå…³é—­-&gt;å…³é—­ï¼Œä¸”æ•°æ®çŠ¶æ€å˜æ›´å¾ˆå°‘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>atomic</span><span class=p>.</span><span class=nf>Load</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>closed</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å†æ¬¡æ£€æŸ¥æ˜¯å¦ä¸ºç©º</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æœ‰åœºæ™¯ï¼šå¯èƒ½å› ä¸ºåœ¨åˆ¤æ–­é€šé“å…³é—­çš„åŒæ—¶æœ‰å¦ä¸€ä¸ªgå¾€é€šé“å‘é€äº†æ•°æ®ï¼Œå¦‚æœæ­¤æ—¶æ²¡æœ‰æ£€æŸ¥ç›´æ¥è¿”å›å°±ä¼šæ¼æ‰é€šé“ä¸­çš„æ•°æ®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nf>empty</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// The channel is irreversibly closed and empty.ä¸å¯é€†è½¬çš„å…³é—­ä¸”ä¸ºç©º</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>raceenabled</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nf>raceacquire</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nf>raceaddr</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>ep</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nf>typedmemclr</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>elemtype</span><span class=p>,</span><span class=w> </span><span class=nx>ep</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// chansend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>block</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>closed</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nf>full</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p><strong>chanrecv å’Œ chansend çš„åŒºåˆ«</strong></p><p>é€šé“çš„å‘é€ï¼ˆ<strong><code>chansend</code></strong>ï¼‰å’Œæ¥æ”¶ï¼ˆ<strong><code>chanrecv</code></strong>ï¼‰é€»è¾‘ä¸­å¯¹å…³é—­çŠ¶æ€çš„å¤„ç†é€»è¾‘ä¸åŒï¼š</p><ul><li><p>æ¥æ”¶ï¼ˆ<strong><code>chanrecv</code></strong>ï¼‰ï¼š</p></li><li><ul><li>æ¥æ”¶æ“ä½œéœ€è¦éå¸¸ç²¾å‡†åœ°åˆ¤æ–­é€šé“çš„çŠ¶æ€ï¼Œå› ä¸ºæ¥æ”¶éœ€è¦çŸ¥é“ï¼š</li></ul></li></ul><ol><li><ol><li><ol><li>é€šé“æ˜¯å¦å·²ç»å…³é—­ã€‚</li><li>é€šé“æ˜¯å¦è¿˜æœ‰æ•°æ®ã€‚</li></ol></li></ol></li></ol><ul><li><ul><li>å¦‚æœé€šé“å·²ç»å…³é—­ä¸”æ²¡æœ‰æ•°æ®ï¼Œæ¥æ”¶æ“ä½œä¼šè¿”å›é»˜è®¤å€¼ã€‚</li><li>å› ä¸ºå…³é—­é€šé“å’Œæ¥æ”¶æ•°æ®å¯èƒ½æ˜¯å¹¶å‘å‘ç”Ÿçš„ï¼Œå‡è®¾å…ˆåˆ¤æ–­é€šé“æ˜¯å¦ä¸ºç©ºï¼Œå†åˆ¤æ–­æ˜¯å¦å…³é—­ï¼Œå¦‚æœé¡ºåºé”™ä¹±ï¼Œå¯èƒ½ä¼šé”™è¯¯åœ°æŠ¥å‘Šé€šé“â€œæœªå…³é—­ä½†ä¸ºç©ºâ€ï¼Œå¯¼è‡´é€»è¾‘é”™è¯¯å› æ­¤å¿…é¡»é€šè¿‡ <strong>åŸå­æ“ä½œ</strong>ï¼ˆ<strong><code>**atomic.Load**</code></strong>ï¼‰æ¥ç¡®ä¿è¯»å–åˆ°çš„çŠ¶æ€æ˜¯å‡†ç¡®çš„ã€‚</li></ul></li><li><p><strong>å‘é€ï¼ˆ</strong><code>chansend</code>ï¼‰ï¼š</p></li><li><ul><li>å‘é€æ“ä½œåªéœ€è¦åˆ¤æ–­é€šé“æ˜¯å¦å…³é—­ã€‚</li><li>å¦‚æœé€šé“å…³é—­ï¼Œå‘é€ä¼šç›´æ¥å¤±è´¥ã€‚</li><li>å‘é€å’Œå…³é—­é€šé“ä¹‹é—´è™½ç„¶ä¹Ÿå¯èƒ½æ˜¯å¹¶å‘çš„ï¼Œä½† Go è®¾è®¡é‡Œï¼Œè¿™ç§åœºæ™¯æ˜¯æ›´ç®€å•çš„ï¼Œå› ä¸ºé€šé“å…³é—­æ˜¯ä¸€ä¸ªå•å‘æ“ä½œï¼ˆåªèƒ½ä»æœªå…³é—­åˆ°å…³é—­ï¼‰ï¼Œä¸ä¼šåå¤å˜åŒ–ã€‚å¦‚æœåœ¨åˆ¤æ–­æ—¶ï¼Œ<strong><code>c.closed</code></strong> çš„å€¼åˆšå¥½ä»æœªå…³é—­ï¼ˆ<strong><code>0</code></strong>ï¼‰å˜æˆäº†å…³é—­ï¼ˆ<strong><code>1</code></strong>ï¼‰ï¼Œå¿«é€Ÿè·¯å¾„å¯èƒ½ä¼šé”™è¯¯åœ°åˆ¤æ–­é€šé“â€œæœªå…³é—­â€ï¼Œè¿›å…¥åç»­é€»è¾‘ï¼Œ<strong>ä½†æ²¡å…³ç³»</strong>ï¼Œå› ä¸ºåç»­é€»è¾‘ä¼šå†æ¬¡è·å–é”å¹¶æ£€æŸ¥é€šé“çŠ¶æ€ã€‚åœ¨è¿™ç§è®¾è®¡ä¸­ï¼Œå¿«é€Ÿè·¯å¾„çš„åˆ¤æ–­åªæ˜¯ä¸€ç§â€œä¼˜åŒ–â€ï¼Œå¹¶ä¸æ˜¯æœ€ç»ˆçš„ç»“æœã€‚</li></ul></li></ul><p>å› æ­¤ï¼Œåœ¨å‘é€åœºæ™¯ä¸­ï¼Œå¯¹ <strong><code>c.closed</code></strong> çš„åˆ¤æ–­ä¸éœ€è¦åƒæ¥æ”¶é‚£æ ·é‚£ä¹ˆä¸¥æ ¼ã€‚</p><h2 id=63-é˜»å¡æ¨¡å¼ä¸-éé˜»å¡æ¨¡å¼>6.3 é˜»å¡æ¨¡å¼ä¸ éé˜»å¡æ¨¡å¼</h2><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>chansend</span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>hchan</span><span class=p>,</span><span class=w> </span><span class=nx>ep</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span><span class=p>,</span><span class=w> </span><span class=nx>block</span><span class=w> </span><span class=kt>bool</span><span class=p>,</span><span class=w> </span><span class=nx>callerpc</span><span class=w> </span><span class=kt>uintptr</span><span class=p>)</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>chanrecv</span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>hchan</span><span class=p>,</span><span class=w> </span><span class=nx>ep</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span><span class=p>,</span><span class=w> </span><span class=nx>block</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>selected</span><span class=p>,</span><span class=w> </span><span class=nx>received</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=p>{}</span></span></span></code></pre></div></div><p>éé˜»å¡æ¨¡å¼ä¸‹ï¼Œé€šè¿‡ <code>block</code> å‚æ•°è®¾ç½®ä¸º false å®ç°ï¼Œåœ¨å‡½æ•°å¤„ç†è¿‡ç¨‹ä¸­ï¼š</p><p>ï¼ˆ1ï¼‰ æ‰€æœ‰éœ€è¦ä½¿å¾—å½“å‰ goroutine è¢«æŒ‚èµ·å’Œè¿›å…¥æ­»é”çš„æ“ä½œï¼Œåœ¨éé˜»å¡æ¨¡å¼ä¸‹éƒ½ä¼šè¿”å› falseï¼›</p><p>ï¼ˆ2ï¼‰æ‰€æœ‰èƒ½ç«‹å³å®Œæˆè¯»å–/å†™å…¥æ“ä½œçš„æ¡ä»¶ä¸‹ï¼Œéé˜»å¡æ¨¡å¼ä¸‹ä¼šè¿”å› trueã€‚</p><p>åŒæ ·çš„ï¼Œå¯¹äº select å…³é”®å­—ï¼Œåœ¨å¤šè·¯å¤ç”¨åˆ†æ”¯ä¸­ï¼Œæœ‰ defalut åˆ†æ”¯çš„æƒ…å†µä¸‹ï¼Œä¼šè¢«ç¼–è¯‘å™¨ä¼˜åŒ–ä¸ºè°ƒç”¨è¿è¡Œæ—¶ selectnbsend å’Œ selectnbrecv å‡½æ•°ï¼Œè€Œè¯¥å‡½æ•°åº•å±‚ä»ç„¶æ˜¯è°ƒç”¨ chansend å’Œ chanrecvï¼Œåªä¸è¿‡æ˜¯ä¼ é€’ <code>block=false</code>ï¼Œè¡¨ç¤ºéé˜»å¡æ¨¡å¼ã€‚å…·ä½“å¯è§ <a href=https://www.yuque.com/power-l5h2z/fhqphz/laoqgdi063845ule target=_blank rel="noopener noreffer">select çš„åº•å±‚å®ç°</a>ã€‚</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// compiler implements</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>//	select {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//	case c &lt;- v:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//		... foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//	default:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//		... bar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//	}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// as</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>//	if selectnbsend(c, v) {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//		... foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//	} else {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//		... bar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//	}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>selectnbsend</span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>hchan</span><span class=p>,</span><span class=w> </span><span class=nx>elem</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>selected</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nf>chansend</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=nf>getcallerpc</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// compiler implements</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>//	select {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//	case v, ok = &lt;-c:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//		... foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//	default:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//		... bar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//	}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>// as</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1>//	if selected, ok = selectnbrecv(&amp;v, c); selected {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//		... foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//	} else {</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//		... bar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//	}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>selectnbrecv</span><span class=p>(</span><span class=nx>elem</span><span class=w> </span><span class=nx>unsafe</span><span class=p>.</span><span class=nx>Pointer</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>hchan</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>selected</span><span class=p>,</span><span class=w> </span><span class=nx>received</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nf>chanrecv</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>elem</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>æ›´æ–°äº 2026-02-04</span></div><div id=page-views class=post-info-mod></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/channle/index.md target=_blank>é˜…è¯»åŸå§‹æ–‡æ¡£</a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/go/>Go</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>è¿”å›</a></span>&nbsp;|&nbsp;<span><a href=/>ä¸»é¡µ</a></span></section></div><div class=post-nav><a href=/context/ class=prev rel=prev title=Context><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Context</a></div></div><div id=comments><div id=giscus class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app>Giscus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2026</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>zg</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=å›åˆ°é¡¶éƒ¨><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i></a></div><div id=fixed-buttons-hidden><a href=# id=view-comments class=fixed-button title=æŸ¥çœ‹è¯„è®º><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script src=/lib/autocomplete/autocomplete.min.js></script><script src=/lib/lunr/lunr.min.js></script><script src=/lib/lunr/lunr.stemmer.support.min.js></script><script src=/lib/lunr/lunr.zh.min.js></script><script src=/lib/lazysizes/lazysizes.min.js></script><script src=/lib/lightgallery/lightgallery.min.js></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js></script><script src=/lib/clipboard/clipboard.min.js></script><script src=/lib/typeit/index.umd.js></script><script src=/lib/katex/katex.min.js></script><script src=/lib/katex/contrib/auto-render.min.js></script><script src=/lib/katex/contrib/copy-tex.min.js></script><script src=/lib/katex/contrib/mhchem.min.js></script><script src=/lib/cookieconsent/cookieconsent.min.js></script><script>window.config={comment:{giscus:{category:"Announcements",categoryId:"DIC_kwDORJxhrc4C19KM",darkTheme:"dark",emitMetadata:"0",inputPosition:"bottom",lang:"zh-CN",lazyLoading:!1,lightTheme:"light",mapping:"pathname",reactionsEnabled:"1",repo:"guangzou/guangzou.github.io",repoId:"R_kgDORJxhrQ"}},cookieconsent:{content:{dismiss:"åŒæ„",link:"äº†è§£æ›´å¤š",message:"æœ¬ç½‘ç«™ä½¿ç”¨ Cookies æ¥æ”¹å–„æ‚¨çš„æµè§ˆä½“éªŒ."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},data:{"id-1":"zg's blog","id-2":"zg's blog"},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"æ²¡æœ‰æ‰¾åˆ°ç»“æœ",snippetLength:30,type:"lunr"},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"id-1":["id-1"],"id-2":["id-2"]},duration:-1,speed:100}}</script><script src=/js/theme.min.js></script></body></html>