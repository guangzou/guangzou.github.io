<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Context - zg blog</title><meta name=Description content="Stay hungry, stay foolish! ğŸš€"><meta property="og:url" content="https://guangzou.github.io/context/"><meta property="og:site_name" content="zg blog"><meta property="og:title" content="Context"><meta property="og:description" content="åå¥½æ‰¶å¥½é©¬ä¸Šæ­æ™“ã€å†…å®¹åŠ²çˆ†æœ‰ç‚¹é‡è¦"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-02-03T16:44:51+08:00"><meta property="article:modified_time" content="2026-02-04T17:59:12+08:00"><meta property="article:tag" content="Go"><meta property="og:image" content="https://guangzou.github.io/logo.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://guangzou.github.io/logo.png"><meta name=twitter:title content="Context"><meta name=twitter:description content="åå¥½æ‰¶å¥½é©¬ä¸Šæ­æ™“ã€å†…å®¹åŠ²çˆ†æœ‰ç‚¹é‡è¦"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=referrer content="no-referrer"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://guangzou.github.io/context/><link rel=prev href=https://guangzou.github.io/database_sql/><link rel=next href=https://guangzou.github.io/channle/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/css/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Context","inLanguage":"zh-cn","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/guangzou.github.io\/context\/"},"genre":"posts","keywords":"Go","wordcount":4766,"url":"https:\/\/guangzou.github.io\/context\/","datePublished":"2026-02-03T16:44:51+08:00","dateModified":"2026-02-04T17:59:12+08:00","license":"xxx","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"zg"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script>const query=window.matchMedia("(prefers-color-scheme: dark)");function applyTheme(){let e=window.localStorage?.getItem("theme")||"auto",t=e==="dark"||e==="auto"&&query.matches;document.body.setAttribute("theme",t?"dark":"light"),document.body.setAttribute("cfg-theme",e)}applyTheme(),query.addEventListener("change",applyTheme)</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="zg blog"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span><span id=id-1 class=typeit></span><span class=header-title-post><i class='fas fa-book fa-fw'></i></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>æ–‡ç«  </a><a class=menu-item href=/tags/>æ ‡ç­¾ </a><a class=menu-item href=/categories/>åˆ†ç±» </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=æœç´¢><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=æ¸…ç©º><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="zg blog"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span><span id=id-2 class=typeit></span><span class=header-title-post><i class='fas fa-book fa-fw'></i></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=æœç´¢><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=æ¸…ç©º><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>å–æ¶ˆ</a></div><a class=menu-item href=/posts/ title>æ–‡ç« </a><a class=menu-item href=/tags/ title>æ ‡ç­¾</a><a class=menu-item href=/categories/ title>åˆ†ç±»</a><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>ç›®å½•</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Context</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>zg</a></span>&nbsp;<span class=post-category>æ”¶å½•äº <a href=/categories/go%E8%AF%AD%E8%A8%80/><i class="far fa-folder fa-fw" aria-hidden=true></i>Goè¯­è¨€</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2026-02-03>2026-02-03</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;çº¦ 4766 å­—&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;é¢„è®¡é˜…è¯» 10 åˆ†é’Ÿ&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/images/context%e5%ba%95%e5%b1%82%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90_banner.png data-srcset="/images/context%e5%ba%95%e5%b1%82%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90_banner.png, /images/context%e5%ba%95%e5%b1%82%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90_banner.png 1.5x, /images/context%e5%ba%95%e5%b1%82%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90_banner.png 2x" data-sizes=auto alt=/images/contextåº•å±‚æºç è§£æ_banner.png title=/images/contextåº•å±‚æºç è§£æ_banner.png></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>ç›®å½•</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1ä½¿ç”¨æ–¹å¼>1ã€ä½¿ç”¨æ–¹å¼</a></li><li><a href=#2åº•å±‚å®ç°go-122>2ã€åº•å±‚å®ç°ï¼ˆgo 1.22ï¼‰</a><ul><li><a href=#21-context-å†…éƒ¨æ•°æ®ç»“æ„>2.1 Context å†…éƒ¨æ•°æ®ç»“æ„ï¼š</a></li><li><a href=#22-emptyctx-ç©ºå®ç°>2.2 emptyCtx ç©ºå®ç°</a></li><li><a href=#23-cancelctx-å®ç°>2.3 cancelCtx å®ç°</a><ul><li><a href=#231-å†…éƒ¨æ•°æ®æ¥å£å®šä¹‰>2.3.1 å†…éƒ¨æ•°æ®æ¥å£å®šä¹‰</a></li><li><a href=#232-cancelctx-å®ç°-context-æ¥å£çš„å››ä¸ªæ–¹æ³•>2.3.2 cancelCtx å®ç° Context æ¥å£çš„å››ä¸ªæ–¹æ³•ï¼š</a></li><li><a href=#233-cancelctxcancelæ–¹æ³•>2.3.3 cancelCtx.cancelæ–¹æ³•</a></li></ul></li><li><a href=#24-timerctx>2.4 timerCtxï¼š</a></li><li><a href=#25-valuectx>2.5 valueCtx</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>åå¥½æ‰¶å¥½é©¬ä¸Šæ­æ™“ã€å†…å®¹åŠ²çˆ†æœ‰ç‚¹é‡è¦</p><h1 id=1ä½¿ç”¨æ–¹å¼>1ã€ä½¿ç”¨æ–¹å¼</h1><p>ä¸»è¦ç”¨äºè¿½è¸ª <code>goroutine</code>ï¼Œè¾¾åˆ°æ§åˆ¶å®ƒä»¬çš„ä½œç”¨ï¼Œä¸€ä¸ª<code>goroutine</code>å¼€å¯åï¼Œè¦ä¹ˆç­‰ä»–è‡ªå·±ç»“æŸï¼Œè¦ä¹ˆç­‰å¤–ç•Œé€šçŸ¥å®ƒç»“æŸã€‚å¯¹äºåå°ç›‘æ§ç±»çš„<code>goroutine</code>ï¼Œå¦‚æœæ²¡æœ‰å¤–ç•Œé€šçŸ¥å®ƒç»“æŸçš„è¯ä¼šä¸€ç›´è¿è¡Œä¸‹å»ï¼Œå¯ä»¥é€šè¿‡<code>chan+select</code>æ§åˆ¶ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼æ— æ³•å¤„ç†<code>goroutine</code>ä¸­å¼€<code>goroutine</code>çš„æƒ…å†µï¼Œå¯èƒ½ä¼šæœ‰å¤šä¸ªåµŒå¥—çš„<code>goroutine</code>ï¼Œä¸å¯èƒ½å†™é‚£ä¹ˆå¤šçš„<code>case &lt;-stop</code>ã€‚</p><p>ä½¿ç”¨<code>context</code>æ¯”è¾ƒå¥½ï¼Œ<code>context.Background() </code>è¿”å›ä¸€ä¸ªç©ºçš„Contextï¼Œè¿™ä¸ªç©ºçš„Contextä¸€èˆ¬ç”¨äºæ•´ä¸ªContextæ ‘çš„æ ¹èŠ‚ç‚¹ã€‚ç„¶åæˆ‘ä»¬ä½¿ç”¨<code>context.WithCancel(parent)</code>å‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ªå¯å–æ¶ˆçš„å­Contextï¼Œç„¶åå½“ä½œå‚æ•°ä¼ ç»™goroutineä½¿ç”¨ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªå­Contextè·Ÿè¸ªè¿™ä¸ªgoroutineã€‚</p><p>åœ¨goroutineä¸­ï¼Œä½¿ç”¨selectè°ƒç”¨<code>&lt;-ctx.Done()</code>åˆ¤æ–­æ˜¯å¦è¦ç»“æŸï¼Œå¦‚æœæ¥å—åˆ°å€¼çš„è¯ï¼Œå°±å¯ä»¥è¿”å›ç»“æŸgoroutineäº†ï¼›å¦‚æœæ¥æ”¶ä¸åˆ°ï¼Œå°±ä¼šç»§ç»­è¿›è¡Œç›‘æ§ã€‚</p><p>é‚£ä¹ˆæ˜¯å¦‚ä½•å‘é€ç»“æŸæŒ‡ä»¤çš„å‘¢ï¼Ÿè¿™å°±æ˜¯ç¤ºä¾‹ä¸­çš„ cancel å‡½æ•°å•¦ï¼Œå®ƒæ˜¯æˆ‘ä»¬è°ƒç”¨<code>context.WithCancel(parent)</code>å‡½æ•°ç”Ÿæˆå­Contextçš„æ—¶å€™è¿”å›çš„ï¼Œç¬¬äºŒä¸ªè¿”å›å€¼å°±æ˜¯è¿™ä¸ªå–æ¶ˆå‡½æ•°ï¼Œå®ƒæ˜¯CancelFuncç±»å‹çš„ã€‚æˆ‘ä»¬è°ƒç”¨å®ƒå°±å¯ä»¥å‘å‡ºå–æ¶ˆæŒ‡ä»¤ï¼Œç„¶åæˆ‘ä»¬çš„ç›‘æ§ goroutine å°±ä¼šæ”¶åˆ°ä¿¡å·ï¼Œå°±ä¼šè¿”å›ç»“æŸã€‚</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// ä½¿ç”¨chan+select</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>stop</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>go</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>for</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>stop</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;ç›‘æ§é€€å‡ºï¼Œåœæ­¢äº†...&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;goroutineç›‘æ§ä¸­...&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>10</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;å¯ä»¥äº†ï¼Œé€šçŸ¥ç›‘æ§åœæ­¢&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>stop</span><span class=o>&lt;-</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=cp>//ä¸ºäº†æ£€æµ‹ç›‘æ§è¿‡æ˜¯å¦åœæ­¢ï¼Œå¦‚æœæ²¡æœ‰ç›‘æ§è¾“å‡ºï¼Œå°±è¡¨ç¤ºåœæ­¢äº†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>5</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// ä½¿ç”¨context</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>cancel</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nf>WithCancel</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>go</span><span class=w> </span><span class=nf>watch</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=s>&#34;ã€ç›‘æ§1ã€‘&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>go</span><span class=w> </span><span class=nf>watch</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=s>&#34;ã€ç›‘æ§2ã€‘&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>go</span><span class=w> </span><span class=nf>watch</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=s>&#34;ã€ç›‘æ§3ã€‘&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>10</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;å¯ä»¥äº†ï¼Œé€šçŸ¥ç›‘æ§åœæ­¢&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>cancel</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=cp>//ä¸ºäº†æ£€æµ‹ç›‘æ§è¿‡æ˜¯å¦åœæ­¢ï¼Œå¦‚æœæ²¡æœ‰ç›‘æ§è¾“å‡ºï¼Œå°±è¡¨ç¤ºåœæ­¢äº†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>5</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>watch</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>name</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>for</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span><span class=s>&#34;ç›‘æ§é€€å‡ºï¼Œåœæ­¢äº†...&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span><span class=s>&#34;goroutineç›‘æ§ä¸­...&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h1 id=2åº•å±‚å®ç°go-122>2ã€åº•å±‚å®ç°ï¼ˆgo 1.22ï¼‰</h1><h2 id=21-context-å†…éƒ¨æ•°æ®ç»“æ„>2.1 Context å†…éƒ¨æ•°æ®ç»“æ„ï¼š</h2><p><a class=lightgallery href=../images/context%e6%8e%a5%e5%8f%a3.webp title=img data-thumbnail=../images/contextæ¥å£.webp><img class=lazyload src=/svg/loading.min.svg data-src=../images/context%e6%8e%a5%e5%8f%a3.webp data-srcset="../images/context%e6%8e%a5%e5%8f%a3.webp, ../images/context%e6%8e%a5%e5%8f%a3.webp 1.5x, ../images/context%e6%8e%a5%e5%8f%a3.webp 2x" data-sizes=auto alt=../images/contextæ¥å£.webp></a></p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>Context</span><span class=w> </span><span class=kd>interface</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Deadline</span><span class=p>()</span><span class=w> </span><span class=p>(</span><span class=nx>deadline</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Done</span><span class=p>()</span><span class=w> </span><span class=o>&lt;-</span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Err</span><span class=p>()</span><span class=w> </span><span class=kt>error</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Value</span><span class=p>(</span><span class=nx>key</span><span class=w> </span><span class=kt>any</span><span class=p>)</span><span class=w> </span><span class=kt>any</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>ï¼ˆ1ï¼‰Deadlineï¼šè¿”å› context çš„è¿‡æœŸæ—¶é—´ï¼›</p><p>ï¼ˆ2ï¼‰Doneï¼šè¿”å› context ä¸­çš„ channelï¼›</p><p>ï¼ˆ3ï¼‰Errï¼šè¿”å›é”™è¯¯ï¼›</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// å½“context å–æ¶ˆæ—¶ï¼Œç”± [Context.Err] è¿”å› Canceled</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>var</span><span class=w> </span><span class=nx>Canceled</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;context canceled&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// å½“context è¶…æ—¶ï¼Œç”± [Context.Err] è¿”å› DeadlineExceeded</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>var</span><span class=w> </span><span class=nx>DeadlineExceeded</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>deadlineExceededError</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>deadlineExceededError</span><span class=w> </span><span class=kd>struct</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// å®ç° Error æ¥å£</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>deadlineExceededError</span><span class=p>)</span><span class=w> </span><span class=nf>Error</span><span class=p>()</span><span class=w> </span><span class=kt>string</span><span class=w>   </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=s>&#34;context deadline exceeded&#34;</span><span class=w> </span><span class=p>}</span></span></span></code></pre></div></div><p>ï¼ˆ4ï¼‰Valueï¼šè¿”å› context ä¸­çš„å¯¹åº” key çš„å€¼.</p><h2 id=22-emptyctx-ç©ºå®ç°>2.2 emptyCtx ç©ºå®ç°</h2><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>emptyCtx</span><span class=p>)</span><span class=w> </span><span class=nf>Deadline</span><span class=p>()</span><span class=w> </span><span class=p>(</span><span class=nx>deadline</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// è¿”å›ä¸€ä¸ª nilï¼Œç”¨æˆ·æ— è®ºå¾€ nil ä¸­å†™å…¥æˆ–è€…è¯»å–æ•°æ®ï¼Œå‡ä¼šé™·å…¥é˜»å¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>emptyCtx</span><span class=p>)</span><span class=w> </span><span class=nf>Done</span><span class=p>()</span><span class=w> </span><span class=o>&lt;-</span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{}</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>emptyCtx</span><span class=p>)</span><span class=w> </span><span class=nf>Err</span><span class=p>()</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>emptyCtx</span><span class=p>)</span><span class=w> </span><span class=nf>Value</span><span class=p>(</span><span class=nx>key</span><span class=w> </span><span class=kt>any</span><span class=p>)</span><span class=w> </span><span class=kt>any</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>backgroundCtx</span><span class=w> </span><span class=kd>struct</span><span class=p>{</span><span class=w> </span><span class=nx>emptyCtx</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>todoCtx</span><span class=w> </span><span class=kd>struct</span><span class=p>{</span><span class=w> </span><span class=nx>emptyCtx</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>Background</span><span class=p>()</span><span class=w> </span><span class=nx>Context</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>backgroundCtx</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>TODO</span><span class=p>()</span><span class=w> </span><span class=nx>Context</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>todoCtx</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>å¯ä»¥çœ‹åˆ°å¹³å¸¸ä½¿ç”¨çš„ <code>context.Background()</code>å®é™…æ˜¯è¿”å›ä¸€ä¸ª context æ¥å£çš„ç©ºå®ç°ã€‚TODO() ä¹Ÿæ˜¯å¦‚æ­¤ã€‚</p><h2 id=23-cancelctx-å®ç°>2.3 cancelCtx å®ç°</h2><p>å¹³å¸¸æˆ‘ä»¬å¤§å¤šæ•°éƒ½æ˜¯ä½¿ç”¨ å¸¦ cancel çš„ context</p><p>æ¯”å¦‚ï¼š</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>cancel</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nf>WithCancel</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>())</span></span></span></code></pre></div></div><p>åœ¨è°ƒç”¨å†…éƒ¨å…¶å®æ˜¯è°ƒç”¨äº† withCancel å‡½æ•°è¿”å›ä¸€ä¸ª cancelCtx ç»“æ„ä½“å¯¹è±¡ï¼Œè€Œè¯¥å¯¹è±¡æ˜¯å®ç°äº† Context æ¥å£çš„ã€‚</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>CancelFunc</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>WithCancel</span><span class=p>(</span><span class=nx>parent</span><span class=w> </span><span class=nx>Context</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>cancel</span><span class=w> </span><span class=nx>CancelFunc</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>withCancel</span><span class=p>(</span><span class=nx>parent</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nf>cancel</span><span class=p>(</span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=nx>Canceled</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>withCancel</span><span class=p>(</span><span class=nx>parent</span><span class=w> </span><span class=nx>Context</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=nx>cancelCtx</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>parent</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nb>panic</span><span class=p>(</span><span class=s>&#34;cannot create context from nil parent&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>cancelCtx</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>.</span><span class=nf>propagateCancel</span><span class=p>(</span><span class=nx>parent</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>åœ¨çœ‹ <code>c.propagateCancel(parent, c)</code>æ–¹æ³•å®ç°ä¹‹å‰ï¼Œå…ˆçœ‹çœ‹ <code>cancelCtx</code>è¿™ä¸ªç»“æ„ä½“çš„å†…éƒ¨æ•°æ®ç»“æ„æ˜¯æ€æ ·çš„ã€‚</p><h3 id=231-å†…éƒ¨æ•°æ®æ¥å£å®šä¹‰>2.3.1 å†…éƒ¨æ•°æ®æ¥å£å®šä¹‰</h3><p><a class=lightgallery href=../images/cancelCtx%e7%bb%93%e6%9e%84.webp title=img data-thumbnail=../images/cancelCtxç»“æ„.webp><img class=lazyload src=/svg/loading.min.svg data-src=../images/cancelCtx%e7%bb%93%e6%9e%84.webp data-srcset="../images/cancelCtx%e7%bb%93%e6%9e%84.webp, ../images/cancelCtx%e7%bb%93%e6%9e%84.webp 1.5x, ../images/cancelCtx%e7%bb%93%e6%9e%84.webp 2x" data-sizes=auto alt=../images/cancelCtxç»“æ„.webp></a></p><p>CancelCtx å¯ä»¥è¢«å–æ¶ˆã€‚å–æ¶ˆæ—¶ï¼Œå®ƒè¿˜ä¼šå–æ¶ˆå…¶æ‰€æœ‰å­ Contextã€‚</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>cancelCtx</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>Context</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>mu</span><span class=w>       </span><span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span><span class=w>            </span><span class=c1>// protects following fields</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>done</span><span class=w>     </span><span class=nx>atomic</span><span class=p>.</span><span class=nx>Value</span><span class=w>          </span><span class=c1>// of chan struct{}, created lazily, closed by first cancel call</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>children</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=nx>canceler</span><span class=p>]</span><span class=kd>struct</span><span class=p>{}</span><span class=w> </span><span class=c1>// set to nil by the first cancel call</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w>      </span><span class=kt>error</span><span class=w>                 </span><span class=c1>// set to non-nil by the first cancel call</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>cause</span><span class=w>    </span><span class=kt>error</span><span class=w>                 </span><span class=c1>// set to non-nil by the first cancel call</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// cancelCtxåŒæ—¶å®ç°äº†canceleræ¥å£</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// A canceler is a context type that can be canceled directly. The</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// implementations are *cancelCtx and *timerCtx.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>canceler</span><span class=w> </span><span class=kd>interface</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>cancel</span><span class=p>(</span><span class=nx>removeFromParent</span><span class=w> </span><span class=kt>bool</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>,</span><span class=nx>cause</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>Done</span><span class=p>()</span><span class=w> </span><span class=o>&lt;-</span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>1ã€å†…ç½®äº†ä¸€ä¸ª Contextï¼Œä½œä¸ºå…¶çˆ¶ Contextï¼ŒcancelCtx å¿…ç„¶ä¸ºæŸä¸ª Context çš„å­ Context</p><p>2ã€mutexï¼ŒåŠ é”è·å–å¹¶å‘åœºæ™¯çš„èµ„æº</p><p>3ã€childrenï¼šä¸€ä¸ª mapï¼ŒæŒ‡å‘ cancelCtx çš„æ‰€æœ‰å­ contextï¼›key æ˜¯ä¸€ä¸ªå®ç°äº† canceler æ¥å£çš„å®ç°ç±»ã€‚è¯¥ map ä¿å­˜ç€ä»è¯¥ context å»¶ä¼¸ä¸‹å»çš„å­èŠ‚ç‚¹ï¼Œæ¯ä¸€ä¸ªå­èŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªå®ç°äº†canceler æ¥å£çš„å®ç°ç±»ï¼Œå†çœ‹çœ‹ canceler æ¥å£çš„å®ç°æ–¹æ³•ï¼Œè¿™äº›æ˜¯æš´éœ²ç»™å­ context çš„æ–¹æ³•ï¼Œçˆ¶context ä»…ä»…è¦æ±‚ å­context å®ç°è¿™ä¸¤ä¸ªæ–¹æ³•å³å¯ï¼Œå­context æœ‰å…·ä½“çš„å…¶ä»–æ–¹æ³•å¯ç”±å­context åšå¯¹åº”çš„å¢åŠ ã€‚ä¿æŒèŒè´£å†…èšï¼Œä»…å…³æ³¨è‡ªå·±éœ€è¦å…³æ³¨çš„éƒ¨åˆ†å³å¯ï¼Œä¹Ÿæ˜¯ä¸ºäº†é¿å…æš´éœ²è¿‡å¤šçš„æ–¹æ³•ç»™çˆ¶contextï¼Œé€ æˆé”™è¯¯è°ƒç”¨ã€‚</p><p>ç»§ç»­çœ‹ <code>c.propagateCancel(parent, c)</code>æ–¹æ³•å®ç°ï¼Œç”¨æ¥å°†çˆ¶ context çš„å–æ¶ˆäº‹ä»¶ä¼ é€’ç»™å­ contextï¼Œå…¶ä¸­å‚æ•°ä¸­çš„ child æ˜¯ä¸€ä¸ª canceler æ¥å£ï¼ŒcancelCtx ä¹Ÿå®ç°äº†è¯¥æ¥å£ï¼Œå› æ­¤å¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’è¿›æ¥ã€‚</p><p>åœ¨å‡½æ•°å†…éƒ¨</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// å‡½æ•°çš„ä½œç”¨æ˜¯ç¡®ä¿å½“çˆ¶ä¸Šä¸‹æ–‡ï¼ˆparentï¼‰è¢«å–æ¶ˆæ—¶ï¼Œå­ä¸Šä¸‹æ–‡ï¼ˆchildï¼‰ä¹Ÿèƒ½è¢«ç›¸åº”åœ°å–æ¶ˆ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>cancelCtx</span><span class=p>)</span><span class=w> </span><span class=nf>propagateCancel</span><span class=p>(</span><span class=nx>parent</span><span class=w> </span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>child</span><span class=w> </span><span class=nx>canceler</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>c</span><span class=p>.</span><span class=nx>Context</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>parent</span><span class=w>   </span><span class=c1>// ç»™ çˆ¶Context èµ‹å€¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>done</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>parent</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 1ã€çˆ¶ Contextæ°¸è¿œä¸ä¼šå–æ¶ˆï¼Œæ¯”å¦‚emptyCtxï¼Œç›´æ¥è¿”å›</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>done</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=c1>// parent is never canceled</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 2ã€select ç›‘å¬ done é€šé“æ˜¯å¦æœ‰å€¼ï¼Œæœ‰å€¼ä»£è¡¨çˆ¶Contextå·²ç»è¢«å–æ¶ˆï¼Œ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// æ­¤æ—¶ä½œä¸ºè¯¥ çˆ¶ Contextçš„å­Contextä¹Ÿåº”è¯¥è¢«å–æ¶ˆï¼ŒåŒæ—¶ï¼Œè¯¥å­Contextçš„åä»£Contextä¹Ÿåº”è¯¥è¢«å–æ¶ˆ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ä¹Ÿå°±æ˜¯è°ƒç”¨ child.cancel æ–¹æ³•è¿›è¡Œå–æ¶ˆï¼Œä»è¿™é‡Œèƒ½å¤Ÿçœ‹åˆ° Contextæ˜¯æœ‰çˆ¶å­å…³ç³»çš„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>done</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// parent is already canceled</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>child</span><span class=p>.</span><span class=nf>cancel</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=nx>parent</span><span class=p>.</span><span class=nf>Err</span><span class=p>(),</span><span class=w> </span><span class=nf>Cause</span><span class=p>(</span><span class=nx>parent</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 3ã€åˆ¤æ–­ parent æœ€å†…å±‚çš„cancelCtxæ˜¯å¦æ˜¯goè‡ªå·±å†…éƒ¨å®ç°çš„cancelCtx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å¦‚æœæ˜¯ï¼Œåˆ™æŠŠ child æ·»åŠ åˆ°è¯¥ cancelCtx çš„ child ä¸­</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>p</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>parentCancelCtx</span><span class=p>(</span><span class=nx>parent</span><span class=p>);</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// parent is a *cancelCtx, or derives from one.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>p</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w> </span><span class=c1>// è®¿é—®å…±äº«èµ„æº p.children mapç»“æ„ï¼ŒåŠ é”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// parent has already been canceled</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>child</span><span class=p>.</span><span class=nf>cancel</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>err</span><span class=p>,</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>cause</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>children</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// æ‡’åŠ è½½</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nx>p</span><span class=p>.</span><span class=nx>children</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>canceler</span><span class=p>]</span><span class=kd>struct</span><span class=p>{})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>p</span><span class=p>.</span><span class=nx>children</span><span class=p>[</span><span class=nx>child</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kd>struct</span><span class=p>{}{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>p</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 4ã€æ˜¯å¦å®ç°äº†AfterFuncæ–¹æ³•</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>a</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>parent</span><span class=p>.(</span><span class=nx>afterFuncer</span><span class=p>);</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// parent implements an AfterFunc method.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>c</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>stop</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>a</span><span class=p>.</span><span class=nf>AfterFunc</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>child</span><span class=p>.</span><span class=nf>cancel</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=nx>parent</span><span class=p>.</span><span class=nf>Err</span><span class=p>(),</span><span class=w> </span><span class=nf>Cause</span><span class=p>(</span><span class=nx>parent</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>c</span><span class=p>.</span><span class=nx>Context</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>stopCtx</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>Context</span><span class=p>:</span><span class=w> </span><span class=nx>parent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>stop</span><span class=p>:</span><span class=w>    </span><span class=nx>stop</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nx>c</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>//5ã€å¦‚æœä¸æ˜¯goè‡ªå·±å†…éƒ¨å®ç°çš„cancelCtxåˆ™å¦å¤–èµ·ä¸€ä¸ªåç¨‹ï¼Œä¸€ç›´ç›‘å¬çˆ¶contextæ˜¯å¦å…³é—­ï¼Œå¦‚æœå…³é—­åˆ™å…³é—­child</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>goroutines</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>go</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>parent</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nx>child</span><span class=p>.</span><span class=nf>cancel</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=nx>parent</span><span class=p>.</span><span class=nf>Err</span><span class=p>(),</span><span class=w> </span><span class=nf>Cause</span><span class=p>(</span><span class=nx>parent</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>child</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// cancelCtxKey æ˜¯ cancelCtx è¿”å›è‡ªèº«çš„é”®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>var</span><span class=w> </span><span class=nx>cancelCtxKey</span><span class=w> </span><span class=kt>int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// è¯¥æ–¹æ³•ä¸»è¦æ˜¯æ ¹æ®cancelCtxKeyæŸ¥æ‰¾parentæœ€åº•å±‚çš„cancelCtx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>parentCancelCtx</span><span class=p>(</span><span class=nx>parent</span><span class=w> </span><span class=nx>Context</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>cancelCtx</span><span class=p>,</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>done</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>parent</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>done</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>closedchan</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=nx>done</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>p</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>parent</span><span class=p>.</span><span class=nf>Value</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>cancelCtxKey</span><span class=p>).(</span><span class=o>*</span><span class=nx>cancelCtx</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>ok</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>pdone</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>done</span><span class=p>.</span><span class=nf>Load</span><span class=p>().(</span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>pdone</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nx>done</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>p</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h3 id=232-cancelctx-å®ç°-context-æ¥å£çš„å››ä¸ªæ–¹æ³•>2.3.2 cancelCtx å®ç° Context æ¥å£çš„å››ä¸ªæ–¹æ³•ï¼š</h3><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 1ã€key ç­‰äº ç‰¹å®šå€¼cancelCtxKeyï¼Œè¿”å›cancelCtxè‡ªèº«çš„æŒ‡é’ˆ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// 2ã€å¦åˆ™ï¼Œæ ¹æ®çˆ¶contextæ¥å–å€¼</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>cancelCtx</span><span class=p>)</span><span class=w> </span><span class=nf>Value</span><span class=p>(</span><span class=nx>key</span><span class=w> </span><span class=kt>any</span><span class=p>)</span><span class=w> </span><span class=kt>any</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>key</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=o>&amp;</span><span class=nx>cancelCtxKey</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nx>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nf>value</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>key</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>value</span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>key</span><span class=w> </span><span class=kt>any</span><span class=p>)</span><span class=w> </span><span class=kt>any</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>for</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>switch</span><span class=w> </span><span class=nx>ctx</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>c</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=o>*</span><span class=nx>valueCtx</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>key</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>ctx</span><span class=p>.</span><span class=nx>key</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>return</span><span class=w> </span><span class=nx>ctx</span><span class=p>.</span><span class=nx>val</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>ctx</span><span class=p>.</span><span class=nx>Context</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=o>*</span><span class=nx>cancelCtx</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>key</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=o>&amp;</span><span class=nx>cancelCtxKey</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>return</span><span class=w> </span><span class=nx>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>ctx</span><span class=p>.</span><span class=nx>Context</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=nx>withoutCancelCtx</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>key</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=o>&amp;</span><span class=nx>cancelCtxKey</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// This implements Cause(ctx) == nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// when ctx is created using WithoutCancel.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>ctx</span><span class=p>.</span><span class=nx>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=o>*</span><span class=nx>timerCtx</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>key</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=o>&amp;</span><span class=nx>cancelCtxKey</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>ctx</span><span class=p>.</span><span class=nx>cancelCtx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>ctx</span><span class=p>.</span><span class=nx>Context</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=nx>backgroundCtx</span><span class=p>,</span><span class=w> </span><span class=nx>todoCtx</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nf>Value</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=cp>//ï¼ˆ1ï¼‰åŸºäº atomic åŒ…ï¼Œè¯»å– cancelCtx ä¸­çš„ chanï¼›å€˜è‹¥å·²å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›ï¼›</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=cp>//ï¼ˆ2ï¼‰åŠ é”åï¼Œå†æ¬¡æ£€æŸ¥ chan æ˜¯å¦å­˜åœ¨ï¼Œè‹¥å­˜åœ¨åˆ™è¿”å›ï¼›ï¼ˆdouble checkï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=cp>//ï¼ˆ3ï¼‰ä¸å­˜åœ¨ï¼Œåˆ™åˆå§‹åŒ– chan å­˜å‚¨åˆ° aotmic.Value å½“ä¸­ï¼Œå¹¶è¿”å›ï¼ˆæ‡’åŠ è½½æœºåˆ¶ï¼‰</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>cancelCtx</span><span class=p>)</span><span class=w> </span><span class=nf>Done</span><span class=p>()</span><span class=w> </span><span class=o>&lt;-</span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{}</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>d</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>done</span><span class=p>.</span><span class=nf>Load</span><span class=p>()</span><span class=w> </span><span class=c1>// doneæ˜¯ atomic åŒ…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>d</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nx>d</span><span class=p>.(</span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>defer</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>d</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>done</span><span class=p>.</span><span class=nf>Load</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>d</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>d</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=p>.</span><span class=nx>done</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=nx>d</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>d</span><span class=p>.(</span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// åŠ é”èµ‹å€¼ç»™errï¼Œè§£é”è¿”å›</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>cancelCtx</span><span class=p>)</span><span class=w> </span><span class=nf>Err</span><span class=p>()</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>Deadlineæ–¹æ³•</span><span class=err>ï¼š</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>ç›´æ¥å¤ç”¨çˆ¶Contextçš„Deadlineæ–¹æ³•</span><span class=err>ã€‚</span></span></span></code></pre></div></div><h3 id=233-cancelctxcancelæ–¹æ³•>2.3.3 cancelCtx.cancelæ–¹æ³•</h3><p><a class=lightgallery href=../images/cancel%e6%96%b9%e6%b3%95.webp title=img data-thumbnail=../images/cancelæ–¹æ³•.webp><img class=lazyload src=/svg/loading.min.svg data-src=../images/cancel%e6%96%b9%e6%b3%95.webp data-srcset="../images/cancel%e6%96%b9%e6%b3%95.webp, ../images/cancel%e6%96%b9%e6%b3%95.webp 1.5x, ../images/cancel%e6%96%b9%e6%b3%95.webp 2x" data-sizes=auto alt=../images/cancelæ–¹æ³•.webp></a></p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// cancel closes c.done, cancels each of c&#39;s children, and, if</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// removeFromParent is true, removes c from its parent&#39;s children.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// cancel sets c.cause to cause if this is the first time c is canceled.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>cancelCtx</span><span class=p>)</span><span class=w> </span><span class=nf>cancel</span><span class=p>(</span><span class=nx>removeFromParent</span><span class=w> </span><span class=kt>bool</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>,</span><span class=w> </span><span class=nx>cause</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nb>panic</span><span class=p>(</span><span class=s>&#34;context: internal error: missing cancel error&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// å…¼å®¹è€ç‰ˆæœ¬ï¼Œä»¥å‰ç‰ˆæœ¬ä¸éœ€è¦ä¼  causeï¼Œä»…ä¼ err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>cause</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>cause</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=c1>// already canceled</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>.</span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>.</span><span class=nx>cause</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>cause</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>d</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>done</span><span class=p>.</span><span class=nf>Load</span><span class=p>().(</span><span class=kd>chan</span><span class=w> </span><span class=kd>struct</span><span class=p>{})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>d</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=p>.</span><span class=nx>done</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=nx>closedchan</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nb>close</span><span class=p>(</span><span class=nx>d</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>for</span><span class=w> </span><span class=nx>child</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>children</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// NOTE: acquiring the child&#39;s lock while holding parent&#39;s lock.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>child</span><span class=p>.</span><span class=nf>cancel</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>,</span><span class=w> </span><span class=nx>cause</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>.</span><span class=nx>children</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>removeFromParent</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>removeChild</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// removeChild removes a context from its parent.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>removeChild</span><span class=p>(</span><span class=nx>parent</span><span class=w> </span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>child</span><span class=w> </span><span class=nx>canceler</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>s</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>parent</span><span class=p>.(</span><span class=nx>stopCtx</span><span class=p>);</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>s</span><span class=p>.</span><span class=nf>stop</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>p</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>parentCancelCtx</span><span class=p>(</span><span class=nx>parent</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>ok</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>p</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>p</span><span class=p>.</span><span class=nx>children</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nb>delete</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>children</span><span class=p>,</span><span class=w> </span><span class=nx>child</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>p</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>ï¼ˆ1ï¼‰è¯¥æ–¹æ³•æœ‰ä¸‰ä¸ªå…¥å‚ï¼Œç¬¬ä¸€ä¸ª removeFromParent æ˜¯ä¸€ä¸ª bool å€¼ï¼Œè¡¨ç¤ºå½“å‰ context æ˜¯å¦éœ€è¦ä»çˆ¶ context çš„ children map é›†åˆä¸­åˆ é™¤ï¼›ç¬¬äºŒä¸ª err æ˜¯ cancel åéœ€è¦å±•ç¤ºçš„é”™è¯¯ä¿¡æ¯ï¼›ç¬¬ä¸‰ä¸ª cause åŒ errï¼Œåœ¨ç¬¬ä¸€æ¬¡cancel è°ƒç”¨æ—¶è¢«è®¾ç½®ã€‚</p><p>ï¼ˆ2ï¼‰æ ¡éªŒä¼ è¿›æ¥çš„ err æ˜¯å¦ä¸ºç©ºï¼Œè‹¥ä¸ºç©ºåˆ™ panic</p><p>ï¼ˆ3ï¼‰åŠ é”</p><p>ï¼ˆ4ï¼‰åˆ¤æ–­ cancelCtx è‡ªèº«çš„ err æ˜¯å¦ä¸º nilï¼Œè‹¥ä¸ä¸º nilï¼Œè¡¨ç¤ºå·²ç»è¢« cancel äº†ï¼Œè§£é”è¿”å›</p><p>ï¼ˆ5ï¼‰ç»™ cancelCtx çš„ err å’Œ cause èµ‹å€¼ï¼Œå¤„ç† cancelCtx çš„ channelï¼Œè‹¥ channel æ­¤å‰æœªåˆå§‹åŒ–ï¼Œåˆ™ç›´æ¥æ³¨å…¥ä¸€ä¸ª closedChanï¼Œå¦åˆ™å…³é—­è¯¥ channelï¼›</p><p>ï¼ˆ6ï¼‰éå†å½“å‰ cancelCtx çš„ children map é›†åˆï¼Œä¾æ¬¡å°† children context éƒ½è¿›è¡Œ cancelï¼›å°†å½“å‰ cancelCtx çš„ children å­—æ®µç½®ä¸º nilï¼›è¿™é‡Œæ˜¯ä¸€ä¸ªé€’å½’è°ƒç”¨ï¼Œåœ¨è·å– child contxet é”çš„åŒæ—¶ä¹ŸæŒæœ‰ parent context çš„é”</p><p>ï¼ˆ7ï¼‰è§£é”</p><p>ï¼ˆ8ï¼‰å¦‚æœ removeFromParent ä¸º trueï¼Œè°ƒç”¨ removeChild æ–¹æ³•ï¼Œå…ˆåˆ¤æ–­æ˜¯å¦æ˜¯ cancelCtxï¼Œä¸æ˜¯åˆ™ç›´æ¥è¿”å›ï¼ˆå› ä¸ºåªæœ‰ cancelCtx æ‰æœ‰ children mapï¼‰ï¼›æŠŠå½“å‰ cancelCtx ä»å…¶çˆ¶ context çš„ children map ä¸­ deleteï¼›æ“ä½œå…±äº«èµ„æºåŠ é”</p><h2 id=24-timerctx>2.4 timerCtxï¼š</h2><p><a class=lightgallery href=../images/timerCtx.webp title=img data-thumbnail=../images/timerCtx.webp><img class=lazyload src=/svg/loading.min.svg data-src=../images/timerCtx.webp data-srcset="../images/timerCtx.webp, ../images/timerCtx.webp 1.5x, ../images/timerCtx.webp 2x" data-sizes=auto alt=../images/timerCtx.webp></a></p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// å†…åµŒäº†ä¸€ä¸ª cancelCtxï¼Œç”¨æ¥å®ç° Done å’Œ Err æ–¹æ³•ï¼Œå¹¶é€šè¿‡åœæ­¢è®¡æ—¶å™¨ç„¶åå§”æ‰˜ç»™cancelCtx.cancel æ¥å®ç°å–æ¶ˆ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>timerCtx</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>cancelCtx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>timer</span><span class=w> </span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Timer</span><span class=w> </span><span class=c1>// Under cancelCtx.mu.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>deadline</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>timerCtx åœ¨ cancelCtx åŸºç¡€ä¸Šåˆåšäº†ä¸€å±‚å°è£…ï¼Œé™¤äº†ç»§æ‰¿ cancelCtx çš„èƒ½åŠ›ä¹‹å¤–ï¼Œæ–°å¢äº†ä¸€ä¸ª time.Timer ç”¨äºå®šæ—¶ç»ˆæ­¢ contextï¼›å¦å¤–æ–°å¢äº†ä¸€ä¸ª deadline å­—æ®µç”¨äºåˆ¤æ–­ timerCtx çš„è¿‡æœŸæ—¶é—´.</p><p>æ¥çœ‹åˆå§‹åŒ–ä¸€ä¸ªå¸¦æˆªæ­¢æ—¶é—´çš„ Context ï¼š</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// åˆ›å»º</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>timeout</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span><span class=w> </span><span class=mi>10</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Minute</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>parent</span><span class=w> </span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>timeout</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>CancelFunc</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nf>WithDeadline</span><span class=p>(</span><span class=nx>parent</span><span class=p>,</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Add</span><span class=p>(</span><span class=nx>timeout</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>WithDeadline</span><span class=p>(</span><span class=nx>parent</span><span class=w> </span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>d</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>CancelFunc</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nf>WithDeadlineCause</span><span class=p>(</span><span class=nx>parent</span><span class=p>,</span><span class=w> </span><span class=nx>d</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>WithDeadlineCause</span><span class=p>(</span><span class=nx>parent</span><span class=w> </span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>d</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>,</span><span class=w> </span><span class=nx>cause</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>CancelFunc</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>parent</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nb>panic</span><span class=p>(</span><span class=s>&#34;cannot create context from nil parent&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>cur</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>parent</span><span class=p>.</span><span class=nf>Deadline</span><span class=p>();</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>cur</span><span class=p>.</span><span class=nf>Before</span><span class=p>(</span><span class=nx>d</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// The current deadline is already sooner than the new one.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nf>WithCancel</span><span class=p>(</span><span class=nx>parent</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>timerCtx</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>deadline</span><span class=p>:</span><span class=w> </span><span class=nx>d</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>.</span><span class=nx>cancelCtx</span><span class=p>.</span><span class=nf>propagateCancel</span><span class=p>(</span><span class=nx>parent</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>dur</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>Until</span><span class=p>(</span><span class=nx>d</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>dur</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=p>.</span><span class=nf>cancel</span><span class=p>(</span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=nx>DeadlineExceeded</span><span class=p>,</span><span class=w> </span><span class=nx>cause</span><span class=p>)</span><span class=w> </span><span class=c1>// deadline has already passed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nf>cancel</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=nx>Canceled</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>defer</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>err</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=p>.</span><span class=nx>timer</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nf>AfterFunc</span><span class=p>(</span><span class=nx>dur</span><span class=p>,</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>c</span><span class=p>.</span><span class=nf>cancel</span><span class=p>(</span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=nx>DeadlineExceeded</span><span class=p>,</span><span class=w> </span><span class=nx>cause</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nf>cancel</span><span class=p>(</span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=nx>Canceled</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>1ï¼‰parent == nil æŠ¥é”™</p><p>2ï¼‰å¦‚æœçˆ¶ Context çš„æˆªæ­¢æ—¶é—´æ—©äºå½“å‰ Contextï¼Œè¿”å›ä¸€ä¸ª cancelCtx</p><p>3ï¼‰åˆå§‹åŒ– timeCtxï¼Œå¹¶å°† parent çš„ cancel äº‹ä»¶åŒæ­¥åˆ°å­ Context</p><p>4ï¼‰åˆ¤æ–­æ˜¯å¦åˆ°è¾¾æˆªæ­¢æ—¶é—´ï¼Œè‹¥æ˜¯ï¼Œåˆ™å–æ¶ˆè¯¥ timeCtx</p><p>5ï¼‰åŠ é”</p><p>6ï¼‰å¯åŠ¨ time.Timerï¼Œå¹¶è§„å®šå¥½åˆ°è¾¾æˆªæ­¢æ—¶é—´æ—¶ï¼Œè°ƒç”¨ cancel æ–¹æ³•å–æ¶ˆ Contextï¼Œå¹¶è¿”å›è¶…æ—¶é”™è¯¯</p><p>7ï¼‰è§£é”ï¼Œè¿”å› timerCtx å’Œä¸€ä¸ªå¯å–æ¶ˆçš„ func</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>timerCtx</span><span class=p>)</span><span class=w> </span><span class=nf>Deadline</span><span class=p>()</span><span class=w> </span><span class=p>(</span><span class=nx>deadline</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>,</span><span class=w> </span><span class=nx>ok</span><span class=w> </span><span class=kt>bool</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>deadline</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// å€ŸåŠ©cancelCtxçš„cancelæ–¹æ³•ï¼Œç„¶åå–æ¶ˆå®šæ—¶å™¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>timerCtx</span><span class=p>)</span><span class=w> </span><span class=nf>cancel</span><span class=p>(</span><span class=nx>removeFromParent</span><span class=w> </span><span class=kt>bool</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>,</span><span class=w> </span><span class=nx>cause</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>.</span><span class=nx>cancelCtx</span><span class=p>.</span><span class=nf>cancel</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>,</span><span class=w> </span><span class=nx>cause</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>removeFromParent</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// Remove this timerCtx from its parent cancelCtx&#39;s children.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nf>removeChild</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>cancelCtx</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>timer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=p>.</span><span class=nx>timer</span><span class=p>.</span><span class=nf>Stop</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>c</span><span class=p>.</span><span class=nx>timer</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>c</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h2 id=25-valuectx>2.5 valueCtx</h2><p>valueCtx æºå¸¦ä¸€ä¸ª key-value é”®å€¼å¯¹ï¼Œå…¶ä»–çš„ context æ¥å£æ–¹æ³•éƒ½å§”æ‰˜ç»™å†…åµŒçš„ Context</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>valueCtx</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Context</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>key</span><span class=p>,</span><span class=w> </span><span class=nx>val</span><span class=w> </span><span class=kt>any</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>ContextKey</span><span class=w> </span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// å®šä¹‰é”®</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>const</span><span class=w> </span><span class=nx>key</span><span class=w> </span><span class=nx>ContextKey</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>&#34;userID&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// åˆ›å»ºä¸€ä¸ªå¸¦å€¼çš„ä¸Šä¸‹æ–‡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nx>ctxWithValue</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nf>WithValue</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span><span class=w> </span><span class=nx>key</span><span class=p>,</span><span class=w> </span><span class=s>&#34;12345&#34;</span><span class=p>)</span></span></span></code></pre></div></div><p>WithValueï¼š</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>WithValue</span><span class=p>(</span><span class=nx>parent</span><span class=w> </span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>key</span><span class=p>,</span><span class=w> </span><span class=nx>val</span><span class=w> </span><span class=kt>any</span><span class=p>)</span><span class=w> </span><span class=nx>Context</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>parent</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nb>panic</span><span class=p>(</span><span class=s>&#34;cannot create context from nil parent&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>key</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nb>panic</span><span class=p>(</span><span class=s>&#34;nil key&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>reflectlite</span><span class=p>.</span><span class=nf>TypeOf</span><span class=p>(</span><span class=nx>key</span><span class=p>).</span><span class=nf>Comparable</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nb>panic</span><span class=p>(</span><span class=s>&#34;key is not comparable&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>valueCtx</span><span class=p>{</span><span class=nx>parent</span><span class=p>,</span><span class=w> </span><span class=nx>key</span><span class=p>,</span><span class=w> </span><span class=nx>val</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>valueCtx.Value æ–¹æ³•ï¼š</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-go"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=å¤åˆ¶åˆ°å‰ªè´´æ¿><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>valueCtx</span><span class=p>)</span><span class=w> </span><span class=nf>Value</span><span class=p>(</span><span class=nx>key</span><span class=w> </span><span class=kt>any</span><span class=p>)</span><span class=w> </span><span class=kt>any</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>key</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>key</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>val</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nf>value</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>key</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>value</span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>key</span><span class=w> </span><span class=kt>any</span><span class=p>)</span><span class=w> </span><span class=kt>any</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>for</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>switch</span><span class=w> </span><span class=nx>ctx</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>c</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=o>*</span><span class=nx>valueCtx</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>key</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>ctx</span><span class=p>.</span><span class=nx>key</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>return</span><span class=w> </span><span class=nx>ctx</span><span class=p>.</span><span class=nx>val</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>ctx</span><span class=p>.</span><span class=nx>Context</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=o>*</span><span class=nx>cancelCtx</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>key</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=o>&amp;</span><span class=nx>cancelCtxKey</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>return</span><span class=w> </span><span class=nx>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>ctx</span><span class=p>.</span><span class=nx>Context</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=nx>withoutCancelCtx</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>key</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=o>&amp;</span><span class=nx>cancelCtxKey</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// This implements Cause(ctx) == nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>// when ctx is created using WithoutCancel.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>ctx</span><span class=p>.</span><span class=nx>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=o>*</span><span class=nx>timerCtx</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>if</span><span class=w> </span><span class=nx>key</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=o>&amp;</span><span class=nx>cancelCtxKey</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>ctx</span><span class=p>.</span><span class=nx>cancelCtx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>c</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>ctx</span><span class=p>.</span><span class=nx>Context</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>case</span><span class=w> </span><span class=nx>backgroundCtx</span><span class=p>,</span><span class=w> </span><span class=nx>todoCtx</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nf>Value</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>1ï¼‰å¦‚æœå½“å‰ valueCtx çš„ key ç­‰äºä¼ å…¥çš„ keyï¼Œè¿”å›å…¶ value</p><p>2ï¼‰ä¸ç­‰äºï¼Œåˆ™å‘ä¸Šå¾€çˆ¶ Context æŸ¥æ‰¾</p><p>valueCtx ä½¿ç”¨æ³¨æ„ï¼š</p><ol><li><strong><code>context.WithValue</code></strong> çš„å€¼æ˜¯ä¸å¯å˜çš„ï¼Œå¦‚æœéœ€è¦ä¿®æ”¹å€¼ï¼Œå¿…é¡»åˆ›å»ºæ–°çš„ä¸Šä¸‹æ–‡ã€‚</li><li>ä¸å»ºè®®åœ¨ä¸Šä¸‹æ–‡ä¸­å­˜å‚¨è¿‡å¤§çš„æ•°æ®ï¼Œå¦‚ç»“æ„ä½“æˆ–åˆ‡ç‰‡ã€‚</li><li>ä¸è¦æ»¥ç”¨ <strong><code>WithValue**</code></strong>ï¼Œè¿‡å¤šçš„é”®å€¼å¯¹å¯èƒ½å¯¼è‡´ä¸Šä¸‹æ–‡æ··ä¹±ã€‚ä¸æ”¯æŒåŸºäº k çš„å»é‡ï¼Œç›¸åŒ k å¯èƒ½é‡å¤å­˜åœ¨ï¼Œå¹¶åŸºäºèµ·ç‚¹çš„ä¸åŒï¼Œè¿”å›ä¸åŒçš„ vã€‚ä»…ç”¨äºåœ¨è¯·æ±‚èŒƒå›´å†…ä¼ é€’å…ƒæ•°æ®ï¼Œä¾‹å¦‚ï¼šç”¨æˆ· IDã€è¯·æ±‚è·Ÿè¸ª ID ç­‰</li><li>ä½¿ç”¨è‡ªå®šä¹‰ç±»å‹ä½œä¸ºé”®ï¼Œå¹¶ä¸”æ˜¯å¯æ¯”è¾ƒçš„</li></ol><ul><li>é¿å…ä½¿ç”¨åŸºç¡€ç±»å‹ï¼ˆå¦‚ <strong><code>string</code></strong> æˆ– <strong><code>int</code></strong>ï¼‰ä½œä¸ºé”®ï¼Œå®¹æ˜“å¼•å‘å†²çªã€‚</li><li>ä½¿ç”¨è‡ªå®šä¹‰ç±»å‹ï¼ˆä¾‹å¦‚ <strong><code>type ContextKey string</code></strong>ï¼‰ç¡®ä¿é”®åœ¨ä¸Šä¸‹æ–‡ä¸­æ˜¯å”¯ä¸€çš„ï¼Œé¿å…ä¸å…¶ä»–åŒ…çš„é”®å†²çªã€‚</li></ul><ol><li>åŸºäº k å¯»æ‰¾ v çš„è¿‡ç¨‹æ˜¯çº¿æ€§çš„ï¼Œæ—¶é—´å¤æ‚åº¦ O(N)</li></ol></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>æ›´æ–°äº 2026-02-04</span></div><div id=page-views class=post-info-mod></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/context/index.md target=_blank>é˜…è¯»åŸå§‹æ–‡æ¡£</a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/go/>Go</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>è¿”å›</a></span>&nbsp;|&nbsp;<span><a href=/>ä¸»é¡µ</a></span></section></div><div class=post-nav><a href=/database_sql/ class=prev rel=prev title=database/sql><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>database/sql</a>
<a href=/channle/ class=next rel=next title=Channelè§£æ>Channelè§£æ<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2026</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>zg</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=å›åˆ°é¡¶éƒ¨><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i></a></div><div id=fixed-buttons-hidden><a href=# id=view-comments class=fixed-button title=æŸ¥çœ‹è¯„è®º><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script src=/lib/autocomplete/autocomplete.min.js></script><script src=/lib/lunr/lunr.min.js></script><script src=/lib/lunr/lunr.stemmer.support.min.js></script><script src=/lib/lunr/lunr.zh.min.js></script><script src=/lib/lazysizes/lazysizes.min.js></script><script src=/lib/lightgallery/lightgallery.min.js></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js></script><script src=/lib/clipboard/clipboard.min.js></script><script src=/lib/typeit/index.umd.js></script><script src=/lib/katex/katex.min.js></script><script src=/lib/katex/contrib/auto-render.min.js></script><script src=/lib/katex/contrib/copy-tex.min.js></script><script src=/lib/katex/contrib/mhchem.min.js></script><script src=/lib/cookieconsent/cookieconsent.min.js></script><script>window.config={comment:{},cookieconsent:{content:{dismiss:"åŒæ„",link:"äº†è§£æ›´å¤š",message:"æœ¬ç½‘ç«™ä½¿ç”¨ Cookies æ¥æ”¹å–„æ‚¨çš„æµè§ˆä½“éªŒ."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},data:{"id-1":"zg's blog","id-2":"zg's blog"},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"æ²¡æœ‰æ‰¾åˆ°ç»“æœ",snippetLength:30,type:"lunr"},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"id-1":["id-1"],"id-2":["id-2"]},duration:-1,speed:100}}</script><script src=/js/theme.min.js></script></body></html>